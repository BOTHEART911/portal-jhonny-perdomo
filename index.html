<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>JHONNY PERDOMO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1759697569/Jhonny_tvexdy.png">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <link rel="manifest" href="manifest.webmanifest">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{
  --primary:#007BFF;
  --primary-2:#0056b3;
  --ok:#16a34a;
  --error:#dc2626;
  --scrim:rgba(0,0,0,.35);
}
 html,body{
      margin:0; padding:0; height:100%; width:100%;
      overflow-x:hidden; /* SIN scroll lateral */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1753538930/FONDO_JHONNY_sugwsj.png') center/cover fixed no-repeat;
    }
    .container{ max-width: 1000px; margin: 0 auto; padding: 16px; }

    /* VISTAS con transici√≥n */
    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      min-height: 0; /* <--- ELIMINADO min-height extra */
      box-sizing:border-box; padding:16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }

/* Tarjetas y formularios */
.card{
  background: rgba(255,255,255,.06);
  backdrop-filter: blur(3px);
  border: 2px solid #ddd; border-radius: 10px;
  box-shadow: 0 8px 18px rgba(0,0,0,.15);
  max-width: 420px; margin: 16px auto; padding: 16px 16px 10px 16px;
}
h1,h2{ margin: 8px 0 12px; text-align:center; }
p.helper{ color:#666; font-size:.95rem; text-align:center; margin:8px 0 16px; }
label{ display:block; font-weight:700; margin: 10px 0 6px; color:#007BFF; }
input, select, textarea, button{
  width:100%; padding:12px; box-sizing:border-box;
  border:1.5px solid #ccc; border-radius:8px; background:#fff;
  outline:none; transition: border-color .2s ease, transform .08s ease;
  font-size:16px;
}
/* Toggle ver/ocultar documento en login (igual a indexref) */
.pwd-wrapper{
  position:relative;
  width:100%;
}
.pwd-wrapper input#doc-login{
  display:block;
  width:100%;
  box-sizing:border-box;
  padding-right:40px;
}
.toggle-cedula{
  position:absolute;
  top:50%;
  right:10px;
  transform:translateY(-50%);
  background:transparent !important;
  border:0 !important;
  padding:0;
  width:28px;
  height:28px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  border-radius:6px;
}
.toggle-cedula:hover{
  background:rgba(0,0,0,.06);
}
.toggle-cedula:active{
  transform:translateY(-50%) scale(.92);
}
.toggle-cedula:focus-visible{
  outline:none;
  box-shadow:0 0 0 3px rgba(6,64,43,.35);
}
.toggle-cedula img{
  width:22px;
  height:22px;
  display:block;
  pointer-events:none;
}
@media (max-width:480px){
  .pwd-wrapper input#doc-login{ padding-right:36px; }
  .toggle-cedula{ right:8px; width:26px; height:26px; }
  .toggle-cedula img{ width:20px; height:20px; }
}
   input, select, textarea, button{
      width:100%; padding:12px; box-sizing:border-box;
      border:1.5px solid #ccc; border-radius:8px; background:#fff;
      outline:none; transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
    button{
      cursor:pointer; border:2px solid var(--primary);
      background:#fff; color:#000; font-weight:700;
    }
button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
.btn-primary{ background:var(--primary); color:#fff; }
.btn-row{ display:flex; gap:12px; }
.btn-row > *{ flex:1; }
.muted{ color:#666; font-size:.9rem; }
.center{ text-align:center; }
.image-center{ display:flex; justify-content:center; align-items:center; }
.brand{ width:210px; border-radius:8px; display:block; margin:12px auto 4px; }
.chip{
  padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
  background:#fff; font-weight:700; color:#000;
}
.danger{ background:#e11; border-color:#e11; color:#fff; }

/* OVERLAY BANNER LATERAL */
.overlay{
  position: fixed;
  inset: 0;
  pointer-events:none;
}
.overlay .scrim{
  position:absolute;
  inset:0;
  background:var(--scrim);
  opacity:0;
  transition:opacity .25s ease;
}
.overlay .panel{
  position:absolute;
  top:0;
  left:0;
  width:min(360px, 90vw);
  height:100%;
  background:#000053; /* color del overlay */
  color:#fff;
  padding:16px 16px 8px 16px;
  box-sizing:border-box;
  transform: translateX(-100%);
  transition: transform .25s ease;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
  min-height: 0;
}

/* Botones del men√∫ lateral en azul */
.menu-btn{
  background: var(--primary);
  color:#fff;
  border:0;
  font-weight:800;
  border-radius:999px;
  padding:12px;
  box-shadow: 0 6px 12px rgba(0,0,0,.18);
}
.menu-btn:hover{
  background: var(--primary-2);
}
  
.overlay.open{ pointer-events:auto; }
.overlay.open .scrim{ opacity:1; }
.overlay.open .panel{ transform: translateX(0); }
.panel h3{ margin: 4px 0 8px; text-align:center; }

  /* Bloques de categor√≠as en el men√∫ lateral */
.menu-section-block{
  margin:6px 0;
}

/* Bot√≥n de categor√≠a (cabecera) */
.menu-cat-btn{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  width:100%;
  border-radius:999px;
  font-weight:800;
  font-size:0.9rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Texto dentro del bot√≥n de categor√≠a */
.menu-cat-btn span{
  flex:1 1 auto;
  text-align:left;
}

/* Contenedor de opciones de cada categor√≠a */
.menu-cat-options{
  display:none;
  flex-direction:column;
  gap:8px;
  margin:6px 0 10px;
}

/* Botones internos un poco m√°s compactos dentro de las categor√≠as */
.menu-cat-options .menu-btn{
  font-weight:600;
  font-size:0.86rem;
}

/* Categor√≠a activa (cabecera resaltada) */
.menu-cat-btn.active{
  background:#7de3ef;
  color:#000;
  border-color:#7de3ef;
}

/* Animaci√≥n de aparici√≥n de las opciones */
.menu-cat-options.showing{
  animation: menuDropIn 0.22s ease-out;
}

@keyframes menuDropIn{
  from{
    opacity:0;
    transform:translateY(-6px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}
  
/* VIDEO */
.video-card{
  position:relative; width: min(560px, 90vw); aspect-ratio: 16 / 9;
  margin: 12px auto; background:#000; border-radius: 14px; overflow:hidden;
  border:2px solid #ddd; box-shadow: 0 10px 24px rgba(0,0,0,.25);
}
.video-card .video-thumb{
  position:absolute; inset:0; width:100%; height:100%;
  object-fit:cover; display:block;
}
.video-card .play-layer{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  background: radial-gradient(circle at center, rgba(255,255,255,.18), rgba(0,0,0,.55));
  color:#fff; font-size: 64px; cursor:pointer; transition: opacity .2s ease;
}
.video-card.playing .play-layer{ opacity:0; pointer-events:none; }
.video-card.playing .video-thumb{ display:none; }
.video-card iframe{ width:100%; height:100%; display:block; }

/* Loader centrado (overlay) */
.loader{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.35);
  z-index:9999; backdrop-filter: blur(2px);
  opacity:1; transition: opacity .12s ease;
  will-change: opacity;
}
/* Para que el loader haga fade-out pero NO afecte otros .hidden */
.loader.hidden{
  display:flex !important;
  opacity:0; pointer-events:none;
}

/* Spinner tipo iOS (12 barras) */
.spinner-ios{
  position:relative; width:64px; height:64px;
}
.spinner-ios i{
  position:absolute; left:50%; top:50%;
  width:6px; height:18px; margin:-9px 0 0 -3px;
  background:#fff; border-radius:3px;
  opacity:.2;
  animation:iosFade 1.2s linear infinite;
  transform-origin: center center;
}

/* Keyframes de ‚Äúiluminaci√≥n‚Äù secuencial */
@keyframes iosFade{
  0%, 39%, 100% { opacity:.2; }
  40% { opacity:1; }
}

/* 12 barras */
.spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
.spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
.spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
.spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
.spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
.spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
.spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
.spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
.spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
.spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
.spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
.spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

.hidden{ display:none !important; }

.narrow{ max-width: 520px; margin: 0 auto; }
.spaced{ margin-top:12px; }

/* Tarjeta de mapa est√°tico */
.map-card{
  width: 100%;
  max-width: 100%;
  aspect-ratio: 16 / 9;
  margin: 12px 0;
  border-radius: 14px;
  overflow: hidden;
  border: 2px solid #ddd;
  box-shadow: 0 10px 24px rgba(0,0,0,.25);
  background: #f3f3f3;
}
.map-card img,
.map-card iframe{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border: 0;
}

/* Mapa responsivo dentro del card */
#view-sede .map-embed{
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;
  border-radius: 14px;
  overflow: hidden;
  border: 2px solid #ddd;
  box-shadow: 0 10px 24px rgba(0,0,0,.25);
  background:#000;
  margin: 12px 0;
}
#view-sede .map-embed iframe{
  position:absolute; inset:0;
  width:100%; height:100%; border:0; display:block;
}

/* Si se usa .video-card para el mapa en esta vista */
#view-sede .video-card{
  width:100% !important;
  max-width:100%;
  margin:12px 0;
  border-radius:14px;
  overflow:hidden;
}

@media (max-width: 700px){ .btn-row{ flex-direction:column; } }

/* Redes sociales: botones con icono */
.social-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
  margin:12px 0;
}
.social-btn{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px;
  border-radius:999px; border:2px solid var(--primary);
  background:#fff; color:#000; font-weight:800; text-decoration:none;
  box-shadow: 0 6px 12px rgba(0,0,0,.18);
}
.social-btn:hover{
  background:var(--primary-2); color:#fff; border-color:var(--primary-2);
}
.social-btn img{
  width:26px; height:26px; object-fit:contain; margin-left:10px;
  border-radius:4px; background:#fff;
}
@media (min-width: 560px){
  .social-grid{ grid-template-columns: 1fr 1fr; }
}

/* REFERIDOS (vista l√≠der) */
.ref-summary-wrap{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:8px; margin:8px 0 16px;
}
.ref-selected-group{
  display:flex; flex-direction:column; align-items:center; gap:6px;
}
.ref-selected-badge{
  display:inline-block;
  border-radius:999px; padding:8px 16px;
  font-weight:900; text-align:center;
  color:#0a0; background:#d7f8e3;
  border:3px solid #7adf9b;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
  min-width:120px;
}
.ref-summary-caption{
  font-size:.85rem; color:#666; text-align:center;
}
.ref-filter-input{
  appearance:none;
  border-radius:999px;
  background:#fff;
  border:3px solid #111;
  padding:10px 16px;
  font-weight:700;
  min-width:240px;
  max-width:360px;
  box-shadow:0 8px 18px rgba(0,0,0,.08);
  outline:none;
  font-size:.95rem;
}
.ref-filter-input::placeholder{ color:#999; font-weight:600; }

.ref-list{
  display:flex; flex-direction:column; gap:12px;
}

.ref-item{
  background:rgba(255,255,255,.9);
  border:2px solid #2f6bdb;
  border-radius:16px;
  padding:12px 12px 10px;
  box-shadow:0 6px 14px rgba(0,0,0,.12);
  display:flex; flex-direction:column; gap:6px;
}

.ref-row-top{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}

.ref-name{
  font-weight:900; font-size:1.05rem; color:#1b2a6b;
  text-transform:uppercase; margin:0;
}

.ref-vote{
  font-weight:900; font-size:.8rem; margin:0;
  padding:4px 10px; border-radius:999px;
  background:#eee; color:#222;
}

.ref-vote.green{ background:#c6f6d5; color:#065f46; border:2px solid #16a34a; }
.ref-vote.gray{ background:#e5e7eb; color:#374151; border:2px solid #9ca3af; }
.ref-vote.orange{ background:#ffedd5; color:#9a3412; border:2px solid #f97316; }
.ref-vote.red{ background:#fee2e2; color:#991b1b; border:2px solid #dc2626; }
.ref-vote.blue{ background:#dbeafe; color:#1e40af; border:2px solid #3b82f6; }

.ref-details{
  display:flex;
  flex-direction:column;
  gap:4px;
  font-size:.75rem; color:#333; font-weight:600;
}

.ref-details span{ white-space:nowrap; }

.ref-actions{
  display:flex; gap:10px; align-items:center;
  margin-top:4px;
}

.ref-wa{
  display:inline-flex; align-items:center; justify-content:center;
  width:42px; height:42px; border-radius:10px;
  border:2px solid var(--primary);
  background:#fff; box-shadow:0 6px 12px rgba(0,0,0,.18);
}
.ref-wa img{ width:26px; height:26px; border-radius:6px; background:#fff; }

@media (max-width:560px){
  .ref-row-top{ flex-direction:column; align-items:flex-start; }
  .ref-filter-input{ width:100%; max-width:100%; }
}

   /* Bot√≥n instalar PWA */
  #btn-instalar{
    border-radius:999px;
    font-size:1rem;
    padding:12px 18px;
  }

  @media (max-width:700px){
    .btn-row{ flex-direction:column; }
  }

/* Bot√≥n con icono */
.btn-with-icon{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}
.btn-with-icon img{
  width:22px; height:22px;
  object-fit:contain;
  border-radius:4px;
  background:#fff;
}

   /* Quitar espacio extra arriba/abajo en todas las vistas (menu, sede, redes, etc.) */
.view{
  padding: 0 16px; /* sin padding vertical; se conserva solo el lateral */
}

  /* Evitar m√°rgenes colapsados del primer y √∫ltimo elemento dentro de cada vista */
.view > *:first-child{ margin-top: 0 !important; }
.view > *:last-child{ margin-bottom: 0 !important; }

  /* Panel lateral (men√∫ deslizable): sin espacio ‚Äúmuerto‚Äù abajo/arriba */
.overlay .panel{
  padding-top: 16px;
  padding-bottom: 0; /* quita espacio al final */
}
.overlay .panel > *:first-child{ margin-top: 0 !important; }
.overlay .panel > *:last-child{ margin-bottom: 0 !important; }

/* 2) Recorte global de bordes: sin espacio arriba/abajo si no hay m√°s contenido */
.container{ padding-bottom: 0; }                  /* Nada de espacio extra al final de la p√°gina */
.view{ padding-top: 0; padding-bottom: 0; }       /* Sin padding vertical en cada vista */
.view > *:first-child{ margin-top: 0 !important; }/* Primer bloque sin margen superior */
.view > *:last-child{ margin-bottom: 0 !important; }/* √öltimo bloque sin margen inferior */

/* Opcional: si quieres que Sede y Redes no tengan ni 1px de ‚Äúaire‚Äù arriba */
#view-sede > *:first-child,
#view-redes > *:first-child{ margin-top: 0 !important; }


/* FEED NOTIFICACIONES */
.feed-list{
  display:flex; flex-direction:column; gap:12px;
}
.feed-item{
  display:flex; gap:12px; align-items:flex-start;
  background: rgba(255,255,255,.9);
  border:2px solid #ddd; border-radius:16px; padding:10px;
  box-shadow: 0 6px 14px rgba(0,0,0,.12);
  cursor:pointer;
}
.feed-thumb{
  width:64px; height:64px; border-radius:10px; object-fit:cover; flex-shrink:0;
  background:#eee;
  border:1px solid #ddd;
}
.feed-content{ flex:1; min-width:0; }
.feed-title{
  font-weight:800; color:#111; margin:0 0 4px 0;
  display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis;
}
.feed-desc{
  color:#333; margin:0;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; text-overflow:ellipsis;
}

/* Punto rojo (no le√≠do) */
.feed-dot{
  width:12px; height:12px; background:#e11; border-radius:999px; flex-shrink:0; margin-left:6px; margin-top:4px;
  box-shadow: 0 0 0 2px #fff;
}

/* Detalle */
.feed-detail-card{
  background: rgba(255,255,255,.9);
  border:2px solid #ddd; border-radius:16px; padding:16px;
  box-shadow: 0 8px 18px rgba(0,0,0,.15);
  max-width: 520px; margin: 12px auto;
  text-align:center;
}
.feed-detail-thumb{
  width:180px; height:180px; object-fit:cover; border-radius:12px; border:1px solid #ddd; background:#eee;
  display:block; margin: 0 auto 10px;
}
.feed-detail-title{
  margin:6px 0 10px; color:#111; font-weight:900;
}
.feed-detail-desc{
  text-align:justify; color:#222; white-space:pre-line;
}
.feed-actions{
  display:flex;
  flex-direction:column;
  align-items:stretch;
  gap:12px;
  margin-top:12px;
}
.feed-actions > *{ flex:0 0 auto; }
.feed-actions .chip{ text-align:center; }
#fd-volver{ width:100%; }

/* Badge en men√∫ (icono con latido y contador) */
.notif-wrap{ position:relative; display:inline-block; }
.notif-bell{
  position:absolute; right:-6px; top:-6px; width:28px; height:28px; display:none;
  animation:heartbeat 1.2s infinite;
}
.notif-bell.active{ display:block; }
.notif-count{
  position:absolute; right:-2px; top:-2px;
  background:#e11; color:#fff; border-radius:999px; min-width:18px; height:18px; line-height:18px;
  text-align:center; padding:0 4px; font-size:12px; font-weight:800; display:none;
  box-shadow: 0 0 0 2px #fff;
}
.notif-count.active{ display:inline-block; }

/* Latido */
@keyframes heartbeat{
  0%{ transform: scale(1); }
  20%{ transform: scale(1.15); }
  40%{ transform: scale(1); }
  60%{ transform: scale(1.15); }
  100%{ transform: scale(1); }
}

    .image-center{ display:flex; justify-content:center; align-items:center; }

    /* Evitar desbordes en detalle (URLs y palabras largas) */
.feed-detail-desc{
  overflow-wrap:anywhere;   /* fuerza corte de palabras muy largas/URLs */
  word-break:break-word;    /* respaldo */
  max-width:100%;
}

  /* Badge del bot√≥n "Ponte al d√≠a" en el men√∫ lateral */
.menu-btn{ position:relative; }
.btn-badge{
  position:absolute; right:-6px; top:-6px;
  background:#e11; color:#fff; border-radius:999px;
  min-width:18px; height:18px; line-height:18px; text-align:center;
  padding:0 4px; font-size:12px; font-weight:800; display:none;
  box-shadow: 0 0 0 2px #fff;
}
.btn-badge.active{ display:inline-block; }

  /* Etiqueta "Ponte al d√≠a" junto a la campana, con el mismo latido */
.notif-label{
  position:absolute; left:calc(100% + 6px); top:-6px;
  height:28px; line-height:28px; padding:0 10px;
  background:#7de3ef; color:#000; border-radius:999px;
  font-weight:800; font-size:14px; white-space:nowrap; display:none;
  animation:heartbeat 1.2s infinite;
  cursor: pointer;
}
  .notif-label.active{ display:inline-block; }

  .notif-label{ cursor: pointer; }

/* Badge del bot√≥n "Ponte al d√≠a" en el men√∫ lateral */
.menu-btn{ position:relative; }
.btn-badge{
  position:absolute; right:-6px; top:-6px;
  background:#e11; color:#fff; border-radius:999px;
  min-width:18px; height:18px; line-height:18px; text-align:center;
  padding:0 4px; font-size:12px; font-weight:800; display:none;
  box-shadow: 0 0 0 2px #fff;
}
.btn-badge.active{ display:inline-block; }
.notif-label.active{ display:inline-block; }

/* Evitar desbordes en detalle (URLs y palabras largas) */
.feed-detail-desc{
  overflow-wrap:anywhere;
  word-break:break-word;
  max-width:100%;
}

/* LIBRETA DE CONTACTOS */
.contact-list{
  display:flex; flex-direction:column; gap:12px;
}
.contact-item{
  display:flex; align-items:center; gap:12px;
  background: rgba(255,255,255,.9);
  border:2px solid #ddd; border-radius:16px; padding:10px 12px;
  box-shadow: 0 6px 14px rgba(0,0,0,.12);
}
.contact-name{
  font-weight:900; color:#1b2a6b;
  flex:1; min-width:0;
  text-transform:uppercase;
}
.contact-actions{
  display:flex; gap:10px; flex-shrink:0;
}
.contact-actions a{
  display:inline-flex; align-items:center; justify-content:center;
  width:48px; height:48px; border-radius:12px; border:2px solid var(--primary);
  background:#fff; box-shadow: 0 6px 12px rgba(0,0,0,.18);
}
.contact-actions img{
  width:26px; height:26px; object-fit:contain; border-radius:6px; background:#fff;
}

  /* Texto gu√≠a bajo el t√≠tulo */
.contact-hint{
  text-align:center; color:#333; margin-top:0; margin-bottom:12px;
}
.contact-hint img{ width:20px; height:20px; vertical-align:middle; border-radius:4px; background:#fff; }

/* Comerciantes Amigos */
.com-top{
  text-align:center;
  margin: 0 auto 10px;
  max-width: 560px;
}
.com-top .tagline-strong{ font-weight:900; }
.com-icons{
  display:flex; gap:10px; justify-content:center; align-items:center;
  margin: 8px 0 0;
}
.com-icons img{ width:22px; height:22px; border-radius:6px; background:#fff; }

.com-cat-wrap{ max-width: 520px; margin: 10px auto; }
.com-spec{
  max-width: 720px; margin: 10px auto;
  text-align:justify; color:#222;
}
.com-spec .chip{ margin: 0 0 8px 0; display:inline-block; }
.com-cat-chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border-radius:999px; border:2px solid var(--primary);
  background:#fff; color:#000; font-weight:800;
}

.com-list{
  display:grid; gap:12px;
  grid-template-columns: 1fr;
}
@media (min-width: 1024px){
  #view-comerciantes .card.narrow{
    max-width: 1100px;
  }
  #view-comerciantes .com-list{
    grid-template-columns: repeat(auto-fit, minmax(460px, 1fr));
    justify-content: center;
  }
  #view-comerciantes .com-card{
    max-width: 520px;
    margin: 0 auto;
  }
}

/* contenedor bot√≥n inferior Comerciantes */
#view-comerciantes .com-bottom-actions{
  display:flex;
  justify-content:center;
  margin-top:12px;
}

.com-card{
  background: rgba(255,255,255,.9);
  border:2px solid #5e60ce;
  border-radius:16px;
  padding:12px;
  box-shadow: 0 6px 16px rgba(0,0,0,.12);
}
.com-card-title{
  text-align:center; font-weight:900; color:var(--primary);
  margin:4px 0 2px; font-size:1.15rem; text-transform:uppercase;
}
.com-card-sub{
  text-align:center; color:#666; margin:0 0 8px;
  font-size:.8rem; font-weight:600;
}
.com-card-img{
  width:100%; aspect-ratio: 4/3; object-fit:cover;
  border-radius:14px; border:1px solid #ddd; background:#eee;
  display:block; margin: 6px 0 10px;
}
.com-card-desc{
  color:#666; font-size:.8rem; margin:0 0 10px; text-align:justify;
}
.com-card-hi{
  background:#c6f6d5; color:#000; border:2px solid #16a34a;
  border-radius:12px; padding:10px; font-weight:800;
  text-align:center; margin: 0 0 10px;
}
.com-offer-label{
  font-size:.75rem;
  text-align:center;
  font-weight:700;
  color:#000;
  margin: 4px 0 6px;
}
.com-card-std{
  background: rgba(22,163,74,.08);
  color:#000;
  border: 2px solid rgba(22,163,74,.35);
  border-radius:12px;
  padding:10px;
  font-weight:800;
  text-align:center;
  margin: 0 0 10px;
}
.com-card-actions{
  display:flex; justify-content:center; gap:10px; flex-wrap:wrap;
}
.com-card-actions a{
  display:inline-flex; align-items:center; justify-content:center;
  width:42px; height:42px; border-radius:10px;
  border:2px solid var(--primary);
  background:#fff; box-shadow: 0 6px 12px rgba(0,0,0,.18);
}
.com-card-actions img{
  width:24px; height:24px; object-fit:contain; border-radius:6px; background:#fff;
}
.com-spec #com-cat-chip{
  display: table;
  margin: 0 auto 8px;
  text-align: center;
}
.com-spec{
  text-align: justify;
}

  /* Asegurar que la descripci√≥n dentro de cada tarjeta est√© justificada */
.com-card-desc{
  color:#666;
  font-size:.8rem;          /* mismo tama√±o que el subt√≠tulo */
  margin:0 0 10px;
  text-align: justify;
}

</style>
  
</head>
<body>
 <!-- Loader centrado (efecto iOS, sin imagen) -->
<div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
  <div class="spinner-ios" role="status" aria-label="Cargando">
    <i></i><i></i><i></i><i></i><i></i><i></i>
    <i></i><i></i><i></i><i></i><i></i><i></i>
  </div>
</div>

  <div class="container">

    <!-- VISTA 1: LOGIN / REGISTRO -->
    <section id="view-login" class="view active">
      <div class="card">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">JHONNY PERDOMO</h1>
        <p class="helper"><b>Al usar esta aplicaci√≥n, aceptas voluntariamente suministrar tus datos Personales.</b><br><i>Art. 5 Ley 1581 de 2012 y Decreto 1074 de 2015</i></p>

                <label>Documento:</label>
        <div class="pwd-wrapper">
          <input
            id="doc-login"
            type="password"
            inputmode="numeric"
            placeholder="Sin puntos ni espacios"
          />
          <button
            type="button"
            id="toggle-doc-login"
            aria-label="Mostrar documento"
            class="toggle-cedula"
          >
            <img
              src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png"
              alt="Mostrar"
            >
          </button>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
         <button id="btn-compartir" class="btn-with-icon">
  <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1766267125/compartir_szoxv7.webp" alt="" aria-hidden="true">
  <span>Comparte la App</span>
</button>
        </div>

        <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
        <p class="center muted">Copyright ¬© BOTHEART</p>
      </div>

      <!-- REGISTRO (solo si no existe) -->
      <div id="registro-card" class="card" style="display:none;">
        <h2 style="color:var(--primary)">INFORMACI√ìN PERSONAL</h2>
        <div class="narrow">
          <label>Nombre Completo</label>
          <input id="reg-nombre" type="text" placeholder="Ingresa tu Nombre completo" />

          <label>Whatsapp</label>
          <input id="reg-telefono" type="tel" inputmode="numeric" placeholder="10 d√≠gitos" />

          <label>Barrio, Vereda o Conjunto de Residencia</label>
          <select id="reg-residencia">
            <option value="" disabled selected>Selecciona tu Residencia</option>
            <option value="ACAPULCO I">ACAPULCO I</option>
            <option value="ACAPULCO II">ACAPULCO II</option>
            <option value="AGUAMARINA">AGUAMARINA</option>
            <option value="ALCALA I">ALCALA I</option>
            <option value="ALFONSO LOPEZ">ALFONSO LOPEZ</option>
            <option value="ALTAGRACIA I">ALTAGRACIA I</option>
            <option value="ALTAGRACIA II">ALTAGRACIA II</option>
            <option value="ALTAGRACIA IV">ALTAGRACIA IV</option>
            <option value="APROVITEF">APROVITEF</option>
            <option value="ARAGON I">ARAGON I</option>
            <option value="ARAGON II">ARAGON II</option>
            <option value="ARAGON III">ARAGON III</option>
            <option value="ARAGON IV">ARAGON IV</option>
            <option value="ARBOLEDA I">ARBOLEDA I</option>
            <option value="ARBOLEDA II">ARBOLEDA II</option>
            <option value="BALCONES DE ALEJANDRIA">BALCONES DE ALEJANDRIA</option>
            <option value="BILBAO">BILBAO</option>
            <option value="CALA I">CALA I</option>
            <option value="CANALES">CANALES</option>
            <option value="CANCUN">CANCUN</option>
            <option value="CAMALA">CAMALA</option>
            <option value="CASA DEL SOL I">CASA DEL SOL I</option>
            <option value="CASA DEL SOL II">CASA DEL SOL II</option>
            <option value="CENTRO">CENTRO</option>
            <option value="COLEGIO I">COLEGIO I</option>
            <option value="COLEGIO II">COLEGIO II</option>
            <option value="COLEGIO III">COLEGIO III</option>
            <option value="DUBAI">DUBAI</option>
            <option value="EL JORDAN">EL JORDAN</option>
            <option value="EL PORTAL DEL RUBI">EL PORTAL DEL RUBI</option>
            <option value="GAITAN">GAITAN</option>
            <option value="HANGARES">HANGARES</option>
            <option value="INVASION BRISAS DEL CARMEN">INVASION BRISAS DEL CARMEN</option>
            <option value="INVASION VILLA MAGDALENA">INVASION VILLA MAGDALENA</option>
            <option value="INVASION VILLA MARIANA">INVASION VILLA MARIANA</option>
            <option value="IQUEIMA">IQUEIMA</option>
            <option value="JARDINES DE BABILONIA">JARDINES DE BABILONIA</option>
            <option value="LA CAPILLA">LA CAPILLA</option>
            <option value="LA CEIBA">LA CEIBA</option>
            <option value="LA ESPERANZA">LA ESPERANZA</option>
            <option value="LA PAZ">LA PAZ</option>
            <option value="LA UNION">LA UNION</option>
            <option value="LAS ROSAS">LAS ROSAS</option>
            <option value="LAS VILLAS">LAS VILLAS</option>
            <option value="LIBERTADOR">LIBERTADOR</option>
            <option value="LLERAS">LLERAS</option>
            <option value="LOS MANGOS I">LOS MANGOS I</option>
            <option value="LOS MANGOS II">LOS MANGOS II</option>
            <option value="LOS MANGOS III">LOS MANGOS III</option>
            <option value="LOS MANGOS IV">LOS MANGOS IV</option>
            <option value="LOS MANGOS V">LOS MANGOS V</option>
            <option value="LOS MANGOS VI">LOS MANGOS VI</option>
            <option value="LOS MANGOS VII">LOS MANGOS VII</option>
            <option value="LOS PIJAOS">LOS PIJAOS</option>
            <option value="MINUTO DE DIOS">MINUTO DE DIOS</option>
            <option value="MIRADOR DE LA ESPERANZA">MIRADOR DE LA ESPERANZA</option>
            <option value="MIRADOR DEL SOL">MIRADOR DEL SOL</option>
            <option value="MONACO">MONACO</option>
            <option value="OBRERO">OBRERO</option>
            <option value="OBRERO DELIRIO">OBRERO DELIRIO</option>
            <option value="ORQU√çDEAS I">ORQU√çDEAS I</option>
            <option value="ORQU√çDEAS II">ORQU√çDEAS II</option>
            <option value="ORQU√çDEAS REAL I">ORQU√çDEAS REAL I</option>
            <option value="ORQU√çDEAS REAL II">ORQU√çDEAS REAL II</option>
            <option value="ORQU√çDEAS REAL III">ORQU√çDEAS REAL III</option>
            <option value="ORQU√çDEAS REAL IV">ORQU√çDEAS REAL IV</option>
            <option value="PARADERO I">PARADERO I</option>
            <option value="PARADERO II">PARADERO II</option>
            <option value="PARAISO">PARAISO</option>
            <option value="PAKISTAN I">PAKISTAN I</option>
            <option value="PAKISTAN II">PAKISTAN II</option>
            <option value="PAKISTAN III">PAKISTAN III</option>
            <option value="PALO VERDE">PALO VERDE</option>
            <option value="PARQUES DE ALEJANDRIA I">PARQUES DE ALEJANDRIA I</option>
            <option value="PARQUES DE ALEJANDRIA II">PARQUES DE ALEJANDRIA II</option>
            <option value="PARQUES DE ALEJANDRIA III">PARQUES DE ALEJANDRIA III</option>
            <option value="PARQUES DE ALEJANDRIA IV">PARQUES DE ALEJANDRIA IV</option>
            <option value="PARQUES DE PAKISTAN I">PARQUES DE PAKISTAN I</option>
            <option value="PARQUES DE PAKISTAN II">PARQUES DE PAKISTAN II</option>
            <option value="PARQUES DE PAKISTAN III">PARQUES DE PAKISTAN III</option>
            <option value="PARQUES DE PAKISTAN IV">PARQUES DE PAKISTAN IV</option>
            <option value="PARQUES DE PAKISTAN V">PARQUES DE PAKISTAN V</option>
            <option value="PORTAL DEL RUBY">PORTAL DEL RUBY</option>
            <option value="PRADERAS DE PALMA REAL">PRADERAS DE PALMA REAL</option>
            <option value="PRADOS DE SAN REMO">PRADOS DE SAN REMO</option>
            <option value="PUERTA BLANCA">PUERTA BLANCA</option>
            <option value="PUERTO BAHIA I">PUERTO BAHIA I</option>
            <option value="PUERTO BAHIA II">PUERTO BAHIA II</option>
            <option value="PUERTO DOMINGO">PUERTO DOMINGO</option>
            <option value="PUERTO MEDITERRANEO">PUERTO MEDITERRANEO</option>
            <option value="QUINTAS DE SAN ESTEBAN">QUINTAS DE SAN ESTEBAN</option>
            <option value="QUINTAS DE SAN FRANCISCO">QUINTAS DE SAN FRANCISCO</option>
            <option value="QUINTAS DEL DIVINO NI√ëO">QUINTAS DEL DIVINO NI√ëO</option>
            <option value="QUINTAS FERROVIARIAS">QUINTAS FERROVIARIAS</option>
            <option value="RIVERAS DEL MAGDALENA">RIVERAS DEL MAGDALENA</option>
            <option value="SAN ANDRES">SAN ANDRES</option>
            <option value="SAN FELIPE DE BARAJAS">SAN FELIPE DE BARAJAS</option>
            <option value="SAN FEMANDO DE SEGOVIA">SAN FEMANDO DE SEGOVIA</option>
            <option value="SAN FRANCISCO">SAN FRANCISCO</option>
            <option value="SAN LUIS">SAN LUIS</option>
            <option value="SANTA ANA">SANTA ANA</option>
            <option value="SANTA HAGIA SOTA">SANTA HAGIA SOTA</option>
            <option value="SANTA MARTHA">SANTA MARTHA</option>
            <option value="SANTA MONICA I">SANTA MONICA I</option>
            <option value="SANTA MONICA II">SANTA MONICA II</option>
            <option value="SINAI">SINAI</option>
            <option value="SOL Y BRISA">SOL Y BRISA</option>
            <option value="TARQUI">TARQUI</option>
            <option value="TAYRONA">TAYRONA</option>
            <option value="TERRAZAS DE ALEJANDRIA">TERRAZAS DE ALEJANDRIA</option>
            <option value="TOPACIO">TOPACIO</option>
            <option value="TRIANA">TRIANA</option>
            <option value="URBANIZACION ARRAYANES">URBANIZACION ARRAYANES</option>
            <option value="URBANIZACION EL PALMAR">URBANIZACION EL PALMAR</option>
            <option value="URBANIZACION EL PORTAL">URBANIZACION EL PORTAL</option>
            <option value="URBANIZACION EL RUBY">URBANIZACION EL RUBY</option>
            <option value="URBANIZACION LOS ALMENDROS">URBANIZACION LOS ALMENDROS</option>
            <option value="URBANIZACION VILLA LUCIA">URBANIZACION VILLA LUCIA</option>
            <option value="URBANIZACION VILLA MAGDALENA I">URBANIZACION VILLA MAGDALENA I</option>
            <option value="URBANIZACION VILLA MAGDALENA II">URBANIZACION VILLA MAGDALENA II</option>
            <option value="URBANIZACION VILLA MAGDALENA III">URBANIZACION VILLA MAGDALENA III</option>
            <option value="URBANIZACION VILLA MARIANA">URBANIZACI√ìN VILLA MARIANA</option>
            <option value="VALLESUE">VALLESUE</option>
            <option value="VENECIA I">VENECIA I</option>
            <option value="VENECIA II">VENECIA II</option>
            <option value="VENECIA III">VENECIA III</option>
            <option value="VENECIA IV">VENECIA IV</option>
            <option value="VILLA DE LAS PALMAS">VILLA DE LAS PALMAS</option>
            <option value="VILLA DEL RIO I">VILLA DEL RIO I</option>
            <option value="VILLA DEL RIO II">VILLA DEL RIO II</option>
            <option value="VILLA DEL SOL">VILLA DEL SOL</option>
            <option value="VILLA ESPERANZA">VILLA ESPERANZA</option>
            <option value="VILLA LAS PALMAS">VILLA LAS PALMAS</option>
            <option value="VILLA MEDINA">VILLA MEDINA</option>
            <option value="VILLAS DEL MEDITERANEO">VILLAS DEL MEDITERANEO</option>
          </select>

          <!-- Campo Referido ocultable -->
          <div id="reg-referido-wrap" style="display:none;">
            <label>N¬∞ Referido</label>
            <input id="reg-referencia" type="tel" inputmode="numeric" placeholder="N¬∞ de Referido (opcional)" />
          </div>
          <div class="btn-row">
            <button id="btn-ref-mas">Si eres Referido</button>
            <button id="btn-ref-menos" class="hidden">No soy Referido</button>
          </div>

          <div class="btn-row spaced">
            <button class="spaced btn-primary" id="btn-guardar-registro">Guardar</button>
            <button id="btn-reg-atras">Atr√°s</button>
          </div>
          <p class="center muted spaced"><b>Revisa la informaci√≥n antes de guardar.</b></p>
        </div>
      </div>
    </section>

    <!-- VISTA 2: MEN√ö -->
<section id="view-menu" class="view">
  <div class="btn-row" style="margin-bottom:12px;">
    <button class="chip" id="btn-open-menu">MEN√ö</button>
    <button class="chip danger" id="btn-logout">Cerrar Sesi√≥n</button>
  </div>

  <div class="image-center">
  <div class="notif-wrap">
  <img alt="usuario" src="https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png" width="64" height="64" />
  <img id="notif-bell" class="notif-bell" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759767447/Notificaci%C3%B3n_jtptyw.webp" alt="">
  <span id="notif-count" class="notif-count">0</span>
  <span id="notif-label" class="notif-label">Ponte al d√≠a</span>
</div>
</div>

  <p id="u-plan" class="center muted" style="font-weight:800; margin:6px 0 0;"></p>

    <h2 id="u-nombre">Nombre</h2>
    <div class="narrow">
      <p><b>C.C.:</b> <span id="u-doc"></span></p>
      <p><b>Cel:</b> <span id="u-cel"></span></p>
      <p><b>Residencia:</b> <span id="u-res"></span></p>
      <p><b>Referencia:</b> <span id="u-ref"></span></p>
      <p><b>Municipio:</b> <span id="u-mpio"></span></p>
      <p><b>Puesto:</b> <span id="u-puesto"></span></p>
      <p><b>Mesa:</b> <span id="u-mesa"></span></p>
    </div>

  <!-- Video de Drive -->
  <div class="video-card" id="videoCard">
    <img id="videoThumb" class="video-thumb" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759802023/Miniatura_ilkloy.png" alt="Video miniatura">
    <div class="play-layer" id="playLayer">‚ñ∂</div>
  </div>

  <div class="image-center">
    <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
  </div>
  <p class="center muted">Copyright ¬© BOTHEART</p>
</section>

    <!-- OVERLAY BANNER -->
<div class="overlay" id="overlay">
  <div class="scrim" id="ovlClose"></div>
  <aside class="panel">
    <div class="btn-row">
      <button id="btn-ovl-back">ATR√ÅS</button>
    </div>
    <div class="image-center">
      <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759696513/Jhonny_y1tslf.gif" style="max-width:180px;border-radius:10px;" />
    </div>
    <h3>Selecciona una categor√≠a</h3>

    <!-- REGISTRO DE DATOS -->
    <div class="menu-section-block">
      <button class="menu-btn menu-cat-btn" data-cat="cat-registro">
        <span>REGISTRO DE DATOS</span>
      </button>
      <div id="cat-registro" class="menu-cat-options">
        <button class="menu-btn" id="go-actualizacion">Actualiza tus Datos Personales üîÅ</button>
        <button class="menu-btn" id="go-asistencia">Registra Asistencia a Evento ‚úãüèæ</button>
        <button class="menu-btn" id="go-consultar">Consulta tu Puesto de Votaci√≥n üó≥</button>
      </div>
    </div>

    <!-- APORTES Y SOLICITUDES -->
    <div class="menu-section-block">
      <button class="menu-btn menu-cat-btn" data-cat="cat-aportes">
        <span>APORTES Y SOLICITUDES</span>
      </button>
      <div id="cat-aportes" class="menu-cat-options">
        <button class="menu-btn" id="go-solicitud">Realiza tu Solicitud üì¨</button>
        <button class="menu-btn" id="go-ideas">Suma tus Ideas üí°</button>
      </div>
    </div>

    <!-- NUESTRO EQUIPO, TU EQUIPO -->
    <div class="menu-section-block">
      <button class="menu-btn menu-cat-btn" data-cat="cat-equipo">
        <span>NUESTRO EQUIPO, TU EQUIPO</span>
      </button>
      <div id="cat-equipo" class="menu-cat-options">
        <button class="menu-btn" id="go-feed">
          Ponte al d√≠a üìÖ
          <span id="go-feed-badge" class="btn-badge">0</span>
        </button>
        <!-- <button class="menu-btn" id="go-calendario">Nuestro Calendario üìÜ</button> -->
        <button class="menu-btn" id="go-sede">Visita Nuestra Casa Social üìç</button>
        <button class="menu-btn" id="go-redes">Conoce Nuestras Redes Sociales üåê</button>
      </div>
    </div>

    <!-- GESTI√ìN E INFORMACI√ìN -->
    <div class="menu-section-block">
      <button class="menu-btn menu-cat-btn" data-cat="cat-gestion">
        <span>GESTI√ìN E INFORMACI√ìN</span>
      </button>
      <div id="cat-gestion" class="menu-cat-options">
        <button class="menu-btn" id="go-libretacontactos">Libreta de Contactos üìí</button>
        <button class="menu-btn" id="go-comerciantes">Comerciantes Amigos üõçÔ∏è</button>
      </div>
    </div>

       <!-- L√çDERES (se controla visibilidad desde JS) -->
    <div class="menu-section-block" id="cat-lideres-block">
      <button class="menu-btn menu-cat-btn" data-cat="cat-lideres">
        <span>L√çDERES</span>
      </button>
      <div id="cat-lideres" class="menu-cat-options">
        <button class="menu-btn" id="go-lider">Refiere por Whatsapp üì§</button>
        <button class="menu-btn" id="go-referidos">Mis Referidos üî¢</button>
        <button class="menu-btn" id="go-jlideres">Portal de Lideres üîç</button>

        <!-- BOTONES ESPECIALES SOLO PARA L√çDERES AUTORIZADOS -->
        <button class="menu-btn" id="go-agenda">Nuestra Agenda üìÜ</button>
        <button class="menu-btn" id="go-servicios">Portal de Sevicios üíº</button>
        <button class="menu-btn" id="go-asistir">Gesti√≥n de Asistencias ‚úÖ</button>
        <button class="menu-btn" id="go-appcomercial">App Comercial üõí</button>
      </div>
    </div>
    
    <div style="height:24px"></div>
    <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
    <p class="center muted">Copyright ¬© BOTHEART</p>
  </aside>
</div>

    <!-- VISTA 3: ASISTENCIA -->
    <section id="view-asistencia" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">REGISTRA ASISTENCIA</h2>
        <input id="a-documento" type="hidden" />
        <input id="a-nombre" type="hidden" />
        <input id="a-telefono" type="hidden" />

        <p class="center muted spaced"><b>Escribe el N¬∞ de Evento y espera unos segundos</b></p>

        <label>N¬∞ de Evento</label>
        <input id="a-reunion" type="tel" inputmode="numeric" placeholder="N¬∞ de Evento" />
        <div id="evento-wrap" style="display:none;">
          <label>Nombre de Evento</label>
          <input id="a-evento" type="text" readonly>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="a-guardar">Guardar</button>
          <button id="a-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA 4: VOTACI√ìN -->
    <section id="view-votacion" class="view">
      <div class="card narrow">
        <h2 style="color:#0a0">CONSULTA TU LUGAR DE VOTACI√ìN</h2>
        <p class="helper">
          1) Abre la p√°gina oficial y consulta tu puesto.<br>
          2) Copia la fila de resultados de la tabla.<br>
          3) P√©gala abajo: se completa autom√°tico.<br>
        </p>
        <div class="image-center">
          <a class="chip" href="https://wsp.registraduria.gov.co/censo/consultar/" target="_blank">Ir a la p√°gina oficial</a>
        </div>
        <label>Pega aqu√≠ la fila copiada de la tabla</label>
        <textarea id="v-row" rows="6" placeholder="Pega aqu√≠..."></textarea>

        <label>NUIP</label><input id="v-nuip" readonly>
        <label>Departamento</label><input id="v-departamento" readonly>
        <label>Municipio</label><input id="v-municipio" readonly>
        <label>Puesto</label><input id="v-puesto" readonly>
        <label>Direcci√≥n</label><input id="v-direccion" readonly>
        <label>Mesa</label><input id="v-mesa" readonly>

        <p class="center muted spaced"><b>Si no Guardaras estos campos, haz clic en el bot√≥n "Atr√°s"</b></p>

        <div class="btn-row spaced">
          <button class="btn-primary" id="v-guardar">Guardar</button>
          <button id="v-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA 5: ACTUALIZACI√ìN -->
    <section id="view-actualizacion" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">ACTUALIZA TUS DATOS</h2>
        <input id="upd-documento" type="hidden" />
        <label>Nombre</label>
        <input id="upd-nombre" type="text" readonly>

        <p class="center muted spaced"><b>Solo edita los campos que actualizar√°s</b></p>
        
        <label>Whatsapp</label>
        <input id="upd-telefono" type="tel" inputmode="numeric" placeholder="10 d√≠gitos" />
        <label>Residencia</label>
        <select id="upd-residencia">
          <option value="" disabled selected>Selecciona tu Residencia</option>
          <!-- mismas opciones que en registro -->
          <option value="ACAPULCO I">ACAPULCO I</option>
          <option value="ACAPULCO II">ACAPULCO II</option>
          <option value="AGUAMARINA">AGUAMARINA</option>
          <option value="ALCALA I">ALCALA I</option>
          <option value="ALFONSO LOPEZ">ALFONSO LOPEZ</option>
          <option value="ALTAGRACIA I">ALTAGRACIA I</option>
          <option value="ALTAGRACIA II">ALTAGRACIA II</option>
          <option value="ALTAGRACIA IV">ALTAGRACIA IV</option>
          <option value="APROVITEF">APROVITEF</option>
          <option value="ARAGON I">ARAGON I</option>
          <option value="ARAGON II">ARAGON II</option>
          <option value="ARAGON III">ARAGON III</option>
          <option value="ARAGON IV">ARAGON IV</option>
          <option value="ARBOLEDA I">ARBOLEDA I</option>
          <option value="ARBOLEDA II">ARBOLEDA II</option>
          <option value="BALCONES DE ALEJANDRIA">BALCONES DE ALEJANDRIA</option>
          <option value="BILBAO">BILBAO</option>
          <option value="CALA I">CALA I</option>
          <option value="CANALES">CANALES</option>
          <option value="CANCUN">CANCUN</option>
          <option value="CAMALA">CAMALA</option>
          <option value="CASA DEL SOL I">CASA DEL SOL I</option>
          <option value="CASA DEL SOL II">CASA DEL SOL II</option>
          <option value="CENTRO">CENTRO</option>
          <option value="COLEGIO I">COLEGIO I</option>
          <option value="COLEGIO II">COLEGIO II</option>
          <option value="COLEGIO III">COLEGIO III</option>
          <option value="DUBAI">DUBAI</option>
          <option value="EL JORDAN">EL JORDAN</option>
          <option value="EL PORTAL DEL RUBI">EL PORTAL DEL RUBI</option>
          <option value="GAITAN">GAITAN</option>
          <option value="HANGARES">HANGARES</option>
          <option value="INVASION BRISAS DEL CARMEN">INVASION BRISAS DEL CARMEN</option>
          <option value="INVASION VILLA MAGDALENA">INVASION VILLA MAGDALENA</option>
          <option value="INVASION VILLA MARIANA">INVASION VILLA MARIANA</option>
          <option value="IQUEIMA">IQUEIMA</option>
          <option value="JARDINES DE BABILONIA">JARDINES DE BABILONIA</option>
          <option value="LA CAPILLA">LA CAPILLA</option>
          <option value="LA CEIBA">LA CEIBA</option>
          <option value="LA ESPERANZA">LA ESPERANZA</option>
          <option value="LA PAZ">LA PAZ</option>
          <option value="LA UNION">LA UNION</option>
          <option value="LAS ROSAS">LAS ROSAS</option>
          <option value="LAS VILLAS">LAS VILLAS</option>
          <option value="LIBERTADOR">LIBERTADOR</option>
          <option value="LLERAS">LLERAS</option>
          <option value="LOS MANGOS I">LOS MANGOS I</option>
          <option value="LOS MANGOS II">LOS MANGOS II</option>
          <option value="LOS MANGOS III">LOS MANGOS III</option>
          <option value="LOS MANGOS IV">LOS MANGOS IV</option>
          <option value="LOS MANGOS V">LOS MANGOS V</option>
          <option value="LOS MANGOS VI">LOS MANGOS VI</option>
          <option value="LOS MANGOS VII">LOS MANGOS VII</option>
          <option value="LOS PIJAOS">LOS PIJAOS</option>
          <option value="MINUTO DE DIOS">MINUTO DE DIOS</option>
          <option value="MIRADOR DE LA ESPERANZA">MIRADOR DE LA ESPERANZA</option>
          <option value="MIRADOR DEL SOL">MIRADOR DEL SOL</option>
          <option value="MONACO">MONACO</option>
          <option value="OBRERO">OBRERO</option>
          <option value="OBRERO DELIRIO">OBRERO DELIRIO</option>
          <option value="ORQU√çDEAS I">ORQU√çDEAS I</option>
          <option value="ORQU√çDEAS II">ORQU√çDEAS II</option>
          <option value="ORQU√çDEAS REAL I">ORQU√çDEAS REAL I</option>
          <option value="ORQU√çDEAS REAL II">ORQU√çDEAS REAL II</option>
          <option value="ORQU√çDEAS REAL III">ORQU√çDEAS REAL III</option>
          <option value="ORQU√çDEAS REAL IV">ORQU√çDEAS REAL IV</option>
          <option value="PARADERO I">PARADERO I</option>
          <option value="PARADERO II">PARADERO II</option>
          <option value="PARAISO">PARAISO</option>
          <option value="PAKISTAN I">PAKISTAN I</option>
          <option value="PAKISTAN II">PAKISTAN II</option>
          <option value="PAKISTAN III">PAKISTAN III</option>
          <option value="PALO VERDE">PALO VERDE</option>
          <option value="PARQUES DE ALEJANDRIA I">PARQUES DE ALEJANDRIA I</option>
          <option value="PARQUES DE ALEJANDRIA II">PARQUES DE ALEJANDRIA II</option>
          <option value="PARQUES DE ALEJANDRIA III">PARQUES DE ALEJANDRIA III</option>
          <option value="PARQUES DE ALEJANDRIA IV">PARQUES DE ALEJANDRIA IV</option>
          <option value="PARQUES DE PAKISTAN I">PARQUES DE PAKISTAN I</option>
          <option value="PARQUES DE PAKISTAN II">PARQUES DE PAKISTAN II</option>
          <option value="PARQUES DE PAKISTAN III">PARQUES DE PAKISTAN III</option>
          <option value="PARQUES DE PAKISTAN IV">PARQUES DE PAKISTAN IV</option>
          <option value="PARQUES DE PAKISTAN V">PARQUES DE PAKISTAN V</option>
          <option value="PORTAL DEL RUBY">PORTAL DEL RUBY</option>
          <option value="PRADERAS DE PALMA REAL">PRADERAS DE PALMA REAL</option>
          <option value="PRADOS DE SAN REMO">PRADOS DE SAN REMO</option>
          <option value="PUERTA BLANCA">PUERTA BLANCA</option>
          <option value="PUERTO BAHIA I">PUERTO BAHIA I</option>
          <option value="PUERTO BAHIA II">PUERTO BAHIA II</option>
          <option value="PUERTO DOMINGO">PUERTO DOMINGO</option>
          <option value="PUERTO MEDITERRANEO">PUERTO MEDITERRANEO</option>
          <option value="QUINTAS DE SAN ESTEBAN">QUINTAS DE SAN ESTEBAN</option>
          <option value="QUINTAS DE SAN FRANCISCO">QUINTAS DE SAN FRANCISCO</option>
          <option value="QUINTAS DEL DIVINO NI√ëO">QUINTAS DEL DIVINO NI√ëO</option>
          <option value="QUINTAS FERROVIARIAS">QUINTAS FERROVIARIAS</option>
          <option value="RIVERAS DEL MAGDALENA">RIVERAS DEL MAGDALENA</option>
          <option value="SAN ANDRES">SAN ANDRES</option>
          <option value="SAN FELIPE DE BARAJAS">SAN FELIPE DE BARAJAS</option>
          <option value="SAN FEMANDO DE SEGOVIA">SAN FEMANDO DE SEGOVIA</option>
          <option value="SAN FRANCISCO">SAN FRANCISCO</option>
          <option value="SAN LUIS">SAN LUIS</option>
          <option value="SANTA ANA">SANTA ANA</option>
          <option value="SANTA HAGIA SOTA">SANTA HAGIA SOTA</option>
          <option value="SANTA MARTHA">SANTA MARTHA</option>
          <option value="SANTA MONICA I">SANTA MONICA I</option>
          <option value="SANTA MONICA II">SANTA MONICA II</option>
          <option value="SINAI">SINAI</option>
          <option value="SOL Y BRISA">SOL Y BRISA</option>
          <option value="TARQUI">TARQUI</option>
          <option value="TAYRONA">TAYRONA</option>
          <option value="TERRAZAS DE ALEJANDRIA">TERRAZAS DE ALEJANDRIA</option>
          <option value="TOPACIO">TOPACIO</option>
          <option value="TRIANA">TRIANA</option>
          <option value="URBANIZACION ARRAYANES">URBANIZACION ARRAYANES</option>
          <option value="URBANIZACION EL PALMAR">URBANIZACION EL PALMAR</option>
          <option value="URBANIZACION EL PORTAL">URBANIZACION EL PORTAL</option>
          <option value="URBANIZACION EL RUBY">URBANIZACION EL RUBY</option>
          <option value="URBANIZACION LOS ALMENDROS">URBANIZACION LOS ALMENDROS</option>
          <option value="URBANIZACION VILLA LUCIA">URBANIZACION VILLA LUCIA</option>
          <option value="URBANIZACION VILLA MAGDALENA I">URBANIZACION VILLA MAGDALENA I</option>
          <option value="URBANIZACION VILLA MAGDALENA II">URBANIZACION VILLA MAGDALENA II</option>
          <option value="URBANIZACION VILLA MAGDALENA III">URBANIZACION VILLA MAGDALENA III</option>
          <option value="URBANIZACION VILLA MARIANA">URBANIZACI√ìN VILLA MARIANA</option>
          <option value="VALLESUE">VALLESUE</option>
          <option value="VENECIA I">VENECIA I</option>
          <option value="VENECIA II">VENECIA II</option>
          <option value="VENECIA III">VENECIA III</option>
          <option value="VENECIA IV">VENECIA IV</option>
          <option value="VILLA DE LAS PALMAS">VILLA DE LAS PALMAS</option>
          <option value="VILLA DEL RIO I">VILLA DEL RIO I</option>
          <option value="VILLA DEL RIO II">VILLA DEL RIO II</option>
          <option value="VILLA DEL SOL">VILLA DEL SOL</option>
          <option value="VILLA ESPERANZA">VILLA ESPERANZA</option>
          <option value="VILLA LAS PALMAS">VILLA LAS PALMAS</option>
          <option value="VILLA MEDINA">VILLA MEDINA</option>
          <option value="VILLAS DEL MEDITERANEO">VILLAS DEL MEDITERANEO</option>
        </select>

        <!-- Referido (ocultable) -->
        <div id="upd-referido-wrap" style="display:none;">
          <label>Ingresa o Actualiza el N¬∞ Referido</label>
          <input id="upd-referencia" type="tel" inputmode="numeric" placeholder="N¬∞ de Referido (opcional)">
        </div>
        <div class="btn-row">
          <button id="upd-ref-mas">Agregar/Editar N¬∞ de Referido</button>
          <button id="upd-ref-menos" class="hidden">No editar Referido</button>
        </div>

        <p class="center muted spaced"><b>Revisa muy bien la informaci√≥n antes de Guardar</b></p>

        <div class="btn-row spaced">
          <button class="btn-primary" id="upd-guardar">Guardar</button>
          <button id="upd-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA 6: CONSULTAR -->
    <section id="view-consultar" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">CONSULTA TU PUESTO DE VOTACI√ìN</h2>
        <label>Documento</label>
        <input id="c-documento" type="tel" inputmode="numeric" placeholder="Pega o escribe tu Documento" />
        <div class="btn-row spaced">
          <button class="btn-primary" id="c-validar">Validar Documento</button>
          <button id="c-volver">Regresar</button>
        </div>
        <div id="c-result" class="spaced" style="display:none;">
          <p><b>Departamento:</b> <span id="c-dep"></span></p>
          <p><b>Municipio:</b> <span id="c-mun"></span></p>
          <p><b>Puesto:</b> <span id="c-pue"></span></p>
          <p><b>Direcci√≥n:</b> <span id="c-dir"></span></p>
          <p><b>Mesa:</b> <span id="c-mesa"></span></p>
        </div>
      </div>
    </section>

    <!-- VISTA 7: SOLICITUD -->
    <section id="view-solicitud" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">REALIZA TU SOLICITUD</h2>
        <p class="center muted spaced"><b>Recibir√°s respuesta o asesoramiento v√≠a telef√≥nica</b></p>
        <input id="s-documento" type="hidden" />
        <input id="s-telefono" type="hidden" />
        <input id="s-residencia" type="hidden" />

        <label>Nombre</label>
        <input id="s-nombre" type="text" readonly placeholder="Tu Nombre" />

        <label>Servicio</label>
        <select id="s-servicio">
          <option value="" disabled selected>Selecciona el servicio que necesitas</option>
          <option value="Asesor√≠a Jur√≠dica">Asesor√≠a Jur√≠dica</option>
          <option value="Asesor√≠a Contable">Asesor√≠a Contable</option>
          <option value="Asesor√≠a Ambiental o Forestal">Asesor√≠a Ambiental o Forestal</option>
          <option value="Orientaci√≥n en Salud">Orientaci√≥n en Salud</option>
          <option value="Orientaci√≥n Psicol√≥gica">Orientaci√≥n Psicol√≥gica</option>
        </select>

        <label>Solicitud</label>
        <textarea id="s-solicitud" rows="5" placeholder="Describe ampliamente tu solicitud"></textarea>

        <p class="center muted spaced"><b>Revisa muy bien la informaci√≥n antes de Guardar</b></p>

        <div class="btn-row spaced">
          <button class="btn-primary" id="s-guardar">Guardar</button>
          <button id="s-volver">Atr√°s</button>
        </div>
      </div>
    </section>

    <!-- VISTA 8: IDEAS -->
    <section id="view-ideas" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">SUMA TUS IDEAS</h2>
        <input id="i-documento" type="hidden" />
        <input id="i-telefono" type="hidden" />
        <input id="i-residencia" type="hidden" />

        <label>Nombre</label>
        <input id="i-nombre" type="text" readonly placeholder="Tu Nombre" />

        <p class="helper" style="margin-top:16px;">
          <b>Escribe las acciones o proyectos que te gustar√≠a proponer para tu sector, barrio, calle, cuadra, vereda, conjunto o en general para el municipio.<br><br>Tus propuestas e ideas son importantes para que juntos recuperemos la identidad de nuestro hermoso municipio de Flandes.</b>
        </p>

        <label>Aspecto Social</label>
        <p class="muted">Salud, educaci√≥n, vivienda, cultura, deporte y recreaci√≥n, agua potable y saneamiento b√°sico, y promoci√≥n social (atenci√≥n a grupos vulnerables)</p>
        <textarea id="i-social" rows="4" placeholder="Redacta tus ideas para Aspecto Social"></textarea>

        <label>Aspecto Institucional</label>
        <p class="muted">Seguridad y justicia, desarrollo comunitario, fortalecimiento institucional, equipamiento p√∫blico y centros de reclusi√≥n.</p>
        <textarea id="i-institucional" rows="4" placeholder="Redacta tus ideas para Aspecto Institucional"></textarea>

        <label>Aspecto Econ√≥mico</label>
        <p class="muted">Promoci√≥n del desarrollo, empleo, turismo, emprendimiento, agropecuario, transporte, servicios p√∫blicos diferentes a acueducto, alcantarillado y aseo.</p>
        <textarea id="i-economico" rows="4" placeholder="Redacta tus ideas para Aspecto Econ√≥mico"></textarea>

        <label>Aspecto Ambiental</label>
        <p class="muted">Ambiental, prevenci√≥n y atenci√≥n de desastres, gesti√≥n del riesgo, protecci√≥n animal.</p>
        <textarea id="i-ambiental" rows="4" placeholder="Redacta tus ideas para Aspecto Ambiental"></textarea>

        <label>Otros</label>
        <textarea id="i-otros" rows="4" placeholder="Redacta tus ideas para Otros Aspectos"></textarea>

        <p class="center muted spaced"><b>Revisa muy bien la informaci√≥n antes de Guardar</b></p>

        <div class="btn-row spaced">
          <button class="btn-primary" id="i-guardar">Guardar</button>
          <button id="i-volver">Atr√°s</button>
        </div>
      </div>
    </section>

        <!-- VISTA INSTALAR -->
  <section id="view-instalar" class="view">
    <div class="card narrow" style="text-align:center;">
      <h2 style="color:var(--primary);">JHONNY PERDOMO</h2>
      <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759696513/Jhonny_y1tslf.gif" />
      <p style="font-weight:600;">
        Instala esta App en tu dispositivo para tener la mejor experiencia.
      </p>
      <div class="btn-row" style="justify-content:center; margin-top:12px;">
        <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
      </div>
      <p class="muted" style="margin-top:14px;">
        Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.
      </p>
    </div>
  </section> 

    <!-- VISTA 9: CASA SOCIAL -->
<section id="view-sede" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">Casa Social Soy de Flandes</h2>

    <!-- Mapa responsivo e interactivo en m√≥vil -->
    <div class="map-embed" style="overscroll-behavior: contain;">
      <iframe
        src="https://www.google.com/maps?q=4.289037,-74.814221&z=16&hl=es&output=embed&gestureHandling=greedy"
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
        allowfullscreen
        title="Ubicaci√≥n Casa Social Soy de Flandes"
        style="width:100%; height:100%; border:0; touch-action: pan-x pan-y; -ms-touch-action: pan-x pan-y;"
      ></iframe>
    </div>

    <!-- Botones -->
    <div class="btn-row spaced">
      <button class="btn-primary" id="btn-como-llegar">Iniciar Recorrido</button>
      <button id="sede-volver">Atr√°s</button>
    </div>

    <div class="narrow">
      <p class="helper" style="text-align:left;">
        Aqu√≠ te escuchamos, te acompa√±amos y ponemos a tu alcance cursos y servicios totalmente gratuitos.
      </p>
      <ul style="line-height:1.6; padding-left:18px;">
        <li><b>Martes:</b> asesor√≠as jur√≠dicas para las JAC</li>
        <li><b>Mi√©rcoles:</b> asesor√≠as en salud y tr√°mites EPS</li>
        <li><b>Jueves:</b> asesor√≠as contablesüìà y curso de guitarra üé∏</li>
        <li><b>Viernes:</b> asesor√≠as jur√≠dicas y realizaci√≥n de derechos de petici√≥n y acciones de tutelas‚öñ. Y en la noche, aer√≥bicos para toda la familia üèÉ‚Äç‚ôÄ</li>
        <li><b>S√°bados:</b> un espacio de escucha y amistadüë•</li>
        <li><b>Red de apoyo con entrega gratuita de medicamentos üíä</b></li>
      </ul>
      <p style="margin-top:10px;">
        Ven y vis√≠tanos <b>diagonal al Parque La Victoriaüìç</b>. Estamos para ti, trabajando de la mano con todos los flamencos. ü§ù
      </p>
      <p class="muted" style="margin-top:8px;">
        #SoyDeFlandes #CasaSocial #NoParamos #SiemprePresentes
      </p>
    </div>
  </div>

  
  <!-- Forzar abrir Google Maps app con fallback a web -->
  <script>
    (function(){
      const btn = document.getElementById('btn-como-llegar');
      if (!btn) return;

      const LAT = 4.289037, LNG = -74.814221;

      btn.addEventListener('click', () => {
        const ua = navigator.userAgent || '';
        const isAndroid = /android/i.test(ua);
        const isIOS = /(iphone|ipad|ipod)/i.test(ua);

        // Fallback web universal (indicando destino y modo)
        const webUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + LAT + ',' + LNG + '&travelmode=driving';

        if (isAndroid){
          // Intent para abrir app de Google Maps
          const intentUrl = 'intent://maps.google.com/maps?daddr=' + LAT + ',' + LNG + '&directionsmode=driving#Intent;scheme=https;package=com.google.android.apps.maps;end';
          let fallbackTimer = setTimeout(()=> window.open(webUrl, '_blank'), 700);
          try{
            window.location.href = intentUrl;
          }catch(_){
            clearTimeout(fallbackTimer);
            window.open(webUrl, '_blank');
          }
          return;
        }

        if (isIOS){
          // Esquema de Google Maps (si la app est√° instalada)
          const appUrl = 'comgooglemaps://?daddr=' + LAT + ',' + LNG + '&directionsmode=driving';
          let fallbackTimer = setTimeout(()=> window.open(webUrl, '_blank'), 700);
          window.location.href = appUrl;
          return;
        }

        // Desktop u otros
        window.open(webUrl, '_blank');
      });
    })();
  </script>
    </section>
<script>
 /* ================== PWA AVANZADO ================== */
let deferredPrompt = null;
let __installStartShown = false;    // bandera: ya mostramos "App instal√°ndose"
let __installSuccessShown = false;  // bandera: ya mostramos "Instalaci√≥n exitosa"

function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const dmInstalled  = window.matchMedia('(display-mode: installed)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  return dmStandalone || dmInstalled || iosStandalone;
}
function isIOS(){
  return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
}
function isMarkedInstalled(){
  try{ return localStorage.getItem('pwaInstalledFlag') === '1'; }catch(_){ return false; }
}
function markInstalled(){
  try{ localStorage.setItem('pwaInstalledFlag', '1'); }catch(_){}
}
function clearInstalledMark(){
  try{ localStorage.removeItem('pwaInstalledFlag'); }catch(_){}
}
async function detectInstalled(){
  if (isStandalone()) return true;
  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a =>
        a.platform === 'webapp' &&
        typeof a.url === 'string' &&
        /manifest\.webmanifest$/.test(a.url)
      );
      if (found){
        markInstalled();
        return true;
      } else {
        clearInstalledMark();
      }
    }catch(_){}
  }
  return isMarkedInstalled();
}
function updateInstallButtonsVisibility(){
  const btn1 = document.getElementById('btn-instalar');
  const canPrompt = !!deferredPrompt;
  const installed = isMarkedInstalled() || isStandalone();
  const shouldShow = !installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  updateInstallButtonsVisibility();
});

window.addEventListener('appinstalled', ()=>{
  markInstalled();
  deferredPrompt = null;
  updateInstallButtonsVisibility();
});

document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  // Flujo iOS: se respeta exactamente tu alerta e instrucciones
  if(isIOS()){
    Swal.fire({
      icon:'info',
      title: '¬°Para Instalar en tu Iphone!',
  html: `
    <div style="text-align:center; margin-top:8px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1765745210/instalacion_ios_ysbhnd.gif"
        alt="Instalaci√≥n de IOS"
        style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
      >
      <div style="margin-top:10px;">
        <b>1.</b> Toca Compartir.<br><b>2.</b> Elige "Agregar a pantalla de inicio".<br><b>3.</b> Confirma "Agregar".
      </div>
    </div>
  `,
    });
    return;
  }
  // Android: requiere beforeinstallprompt (deferredPrompt)
  if(!deferredPrompt){
    Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'});
    return;
  }

  const dp = deferredPrompt;
  dp.prompt();                           // muestra di√°logo nativo de instalaci√≥n
  const choice = await dp.userChoice;    // espera la elecci√≥n del usuario
  deferredPrompt = null;                 // limpia el prompt (solo se usa una vez)

  if (choice.outcome === 'accepted'){
    // Primera alerta (Android): confirma inicio de instalaci√≥n por 6 segundos
    markInstalled();
    __installStartShown = true;
    Swal.fire({
  icon: 'success',
  title: '¬°App instal√°ndose!',
  html: `
    <div style="text-align:center; margin-top:8px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1765740540/instalacion_lydtcl.gif"
        alt="Instalando app"
        style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
      >
      <div>Debes esperar unos segundos mientras el sistema instala la App.</div>
      <div style="margin-top:10px;">
        <b>Al desaparecer este aviso, puedes salir de esta vista. La App aparecer√° en la pantalla principal de este dispositivo.</b>
      </div>
    </div>
  `,
  timer: 12000,
  showConfirmButton: false
});
  } else {
    Swal.fire({icon:'info',title:'Instalaci√≥n cancelada'});
  }

  updateInstallButtonsVisibility();
});

async function initPWAVista(){
  const installed = await detectInstalled();
  if (installed){
    showView('view-login');
  } else {
    showView('view-instalar');
    updateInstallButtonsVisibility();
  }
}
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
window.addEventListener('load', initPWAVista);
    
  </script>



     <!-- VISTA 10: REDES SOCIALES -->
<section id="view-redes" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">S√≠guenos</h2>
    <p class="helper"><b>Conoce el trabajo que venimos desarrollando todos los d√≠as</b><br><br>#SoyDeFlandes #CasaSocial #NoParamos #SiemprePresentes</p>

    <div class="social-grid">
      <a class="social-btn" href="https://www.facebook.com/share/1CD6ubtcRA/" target="_blank" rel="noopener">
        Facebook
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/facebook_nezbkz.webp" alt="Facebook">
      </a>
      <a class="social-btn" href="https://www.instagram.com/jhonnyperdomor?igsh=MTN5eHZucTd5OGNtbw==" target="_blank" rel="noopener">
        Instagram
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/instragram_uft2wl.webp" alt="Instagram">
      </a>
      <a class="social-btn" href="https://vt.tiktok.com/ZSD7FBBNG/" target="_blank" rel="noopener">
        TikTok
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/tiktok_tdvc2x.webp" alt="TikTok">
      </a>
      <a class="social-btn" href="https://whatsapp.com/channel/0029VbBEYJ83LdQbOODLO10S" target="_blank" rel="noopener">
        WhatsApp Canal
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="WhatsApp">
      </a>
    </div>

    <div class="btn-row spaced">
      <button id="redes-volver">Atr√°s</button>
    </div>
  </div>
</section>

     <!-- VISTA 12: LIBRETA DE CONTACTOS -->
    <section id="view-libretacontactos" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">LIBRETA DE CONTACTOS</h2>
    <p class="contact-hint">
      Para ir al chat, haz clic en
      <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="WhatsApp" aria-hidden="true">
      <br>
      Para llamar, haz clic en
      <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759952569/Llamada_hra2ch.webp" alt="Llamar" aria-hidden="true">
    </p>

    <div id="lc-list" class="contact-list"></div>

    <div class="btn-row spaced">
      <button id="lc-volver">Regresar</button>
    </div>
  </div>
</section>

         <!-- VISTA 13: COMERCIANTES AMIGOS -->
    <section id="view-comerciantes" class="view">
  <div class="card narrow" style="padding-top:12px;">
    <h2 style="color:var(--primary); text-shadow: 0 2px 2px #031732; margin-bottom:6px;">COMERCIANTES AMIGOS</h2>

    <div class="com-top">
      <div class="tagline-strong">Apoyemos a nuestros comerciantes</div>
      <div>Cuando filtres una categor√≠a, haz clic en los iconos para explorar cada comercio</div>
      <div class="com-icons">
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1760108968/ubicacion_zicnod.png" alt="">
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/facebook_nezbkz.webp" alt="">
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/instragram_uft2wl.webp" alt="">
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/tiktok_tdvc2x.webp" alt="">
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="">
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759952569/Llamada_hra2ch.webp" alt="">
      </div>
    </div>

    <div class="btn-row spaced">
      <button id="com-volver">Regresar</button>
    </div>

    <div class="com-cat-wrap">
      <label>Categor√≠a</label>
      <select id="com-cat">
        <option value="" selected disabled>Selecciona la Categor√≠a</option>
      </select>
    </div>

    <div id="com-spec" class="com-spec" style="display:none;">
      <div id="com-cat-chip" class="com-cat-chip"></div>
      <div id="com-spec-text"></div>
    </div>

    <div id="com-list" class="com-list"></div>
  </div>
</section>

  <!-- VISTA 11: PONTE AL D√çA (lista) -->
<section id="view-feed" class="view">
  <div class="card narrow" style="padding-top:12px;">
    <h2 style="color:var(--primary); text-shadow: 0 2px 2px #031732; margin-bottom:10px;">¬°PONTE AL D√çA!</h2>
    <div id="feed-list" class="feed-list">
      <!-- Se llena por JS en el paso 2 -->
      <!-- Placeholder para que sepas d√≥nde aparece la lista -->
    </div>
    <div class="btn-row spaced">
      <button id="feed-volver">Regresar</button>
    </div>
  </div>
</section>

<!-- VISTA 12: DETALLE DE NOTIFICACI√ìN -->
<section id="view-feed-detail" class="view">
  <div class="feed-detail-card">
    <img id="fd-thumb" class="feed-detail-thumb" src="" alt="">
    <h3 id="fd-title" class="feed-detail-title">T√≠tulo</h3>
    <p id="fd-desc" class="feed-detail-desc">Descripci√≥n</p>
    <div class="feed-actions">
      <a id="fd-link" class="chip" href="#" target="_blank" rel="noopener">Ay√∫danos con tu Like üëçüèæ Comenta ‚úè y Comparte üì≤</a>
      <button id="fd-volver">Regresar</button>
    </div>
  </div>
</section>

     <!-- VISTA 14: MIS REFERIDOS -->
    <section id="view-referidos" class="view">
  <div class="card narrow" style="padding-top:12px;">
    <h2 id="ref-title" style="color:var(--primary); text-shadow:0 2px 2px #031732; margin-bottom:10px;">REFERIDOS</h2>

    <div class="ref-summary-wrap">
      <div class="ref-selected-group">
        <div id="ref-count" class="ref-selected-badge" style="display:none"></div>
        <div id="ref-caption" class="ref-summary-caption" style="display:none">N¬∞ de Referidos</div>
      </div>
      <input id="ref-filter" class="ref-filter-input" type="text" placeholder="Escribe para filtrar" aria-label="Filtrar por nombre, documento, residencia o votaci√≥n">
    </div>

    <div id="ref-list" class="ref-list"></div>

    <div class="btn-row spaced">
      <button id="ref-volver">Regresar</button>
    </div>
  </div>
</section>

  <script>
  
    // URL de tu Apps Script desplegado
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzYEzUpAoXZKgkCut4HI2CgcHiwkgldjx23RXucAGx-BlTKXreJO_ZQ2MCyr8aqnOl0/exec';

   // Loader centrado (smart delay)
const loader = document.getElementById('loader');
let loadingCount = 0;
let loaderTimer = null;

function startLoading(){
  loadingCount++;
  if (loadingCount === 1){
    // Mostrar solo si la operaci√≥n tarda m√°s de 120ms (evita parpadeo)
    loaderTimer = setTimeout(()=>{
      loader.classList.remove('hidden');
      loaderTimer = null;
    }, 120);
  }
}

function stopLoading(){
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    // Si nunca alcanz√≥ a mostrarse, cancela el timer
    if (loaderTimer){
      clearTimeout(loaderTimer);
      loaderTimer = null;
    }
    // Oculta de inmediato (fade corto definido en CSS)
    loader.classList.add('hidden');
  }
}

    // Sonidos
    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
      logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
      menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3',
      notify: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759767435/Notificacion_d1woxv.mp3'
    };
    function playSoundOnce(url){
      try{
        const a = new Audio(url);
        a.preload = 'auto';
        a.play().catch(()=>{});
      }catch(e){}
    }
    // Patch de SweetAlert2 para sonar seg√∫n icono o etiqueta de resumen
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen'){
            playSoundOnce(SOUNDS.resumen);
          } else {
            const icon = options.icon || options.type;
            if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
          }
        }catch(e){}
        return __fire(options, ...rest);
      }
    }

    // Fetch helpers
    async function apiGet(action, params = {}){
      startLoading();
      try{
        const url = new URL(API_BASE);
        url.search = new URLSearchParams({ action, ...params }).toString();
        const r = await fetch(url.toString(), { method: 'GET' });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }
    async function apiPost(action, body = {}){
      startLoading();
      try{
        const url = API_BASE + '?action=' + encodeURIComponent(action);
        const r = await fetch(url, {
          method:'POST',
          headers: { 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }

    // Estado
    let currentUser = null;

        // Lista de l√≠deres autorizados para ver botones especiales
    const AUTH_LEADERS = [
      '1108456583','1003523357','1070621556','93435295','1108454481','1108453352',
      '65820648','1108454823','38210170','39584197','65820550','65820373',
      '1108454657','88199574','94070799','1070598628','1070619267'
    ];

    // Helpers de vistas
 function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  document.getElementById(id).classList.add('active');
  overlay.classList.remove('open');

  const target = document.getElementById(id);
  if (target && typeof target.scrollIntoView === 'function'){
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  if(id === 'view-menu'){ refreshNotificationsBadge(); }
}
    
    function renderUserMenu(){
  document.getElementById('u-nombre').textContent = currentUser?.nombre || '';
  document.getElementById('u-doc').textContent = currentUser?.documento || '';
  document.getElementById('u-cel').textContent = currentUser?.telefono || 'SIN REGISTRO';
  document.getElementById('u-res').textContent = currentUser?.residencia || 'SIN REGISTRO';
  document.getElementById('u-ref').textContent = currentUser?.referencia || 'N/A';
  document.getElementById('u-mpio').textContent = currentUser?.municipio || 'SIN REGISTRO';
  document.getElementById('u-puesto').textContent = currentUser?.puesto || 'SIN REGISTRO';
  document.getElementById('u-mesa').textContent = currentUser?.mesa || 'SIN REGISTRO';

  // Etiqueta "Usuario Premium/Est√°ndar" debajo del icono (seg√∫n municipio)
  const mpio = (currentUser?.municipio || '').trim().toUpperCase();
  const planEl = document.getElementById('u-plan');
  if (planEl){
    planEl.textContent = (mpio === 'FLANDES' || mpio === 'A LA ESPERA')
      ? '‚≠ê Usuario Premium ‚≠ê'
      : 'Usuario Est√°ndar';
  }
}
    async function refreshUserFromServer(){
      try{
        const doc = currentUser?.documento;
        if(!doc) return;
        const res = await apiGet('validarDocumento', { documento: doc });
        if(res?.existe){
          currentUser = {
            documento: res.documento,
            nombre: res.nombre,
            telefono: res.telefono || '',
            residencia: res.residencia || '',
            referencia: res.referencia || '',
            municipio: res.municipio || '',
            puesto: res.puesto || '',
            mesa: res.mesa || ''
          };
          renderUserMenu();
        }
      }catch(e){ /* silencio */ }
    }

                  // Ocultar completamente la categor√≠a L√çDERES si no es l√≠der
    function updateLeaderUI(isLeader){
      try{
        const catLideresBlock = document.getElementById('cat-lideres-block');
        const btnLider        = document.getElementById('go-lider');
        const btnReferidos    = document.getElementById('go-referidos');

        const btnAgenda       = document.getElementById('go-agenda');
        const btnServicios    = document.getElementById('go-servicios');
        const btnAsistir    = document.getElementById('go-asistir');
        const btnAppComercial = document.getElementById('go-appcomercial');

        const show = !!isLeader;
        const isAuth = !!(currentUser && AUTH_LEADERS.includes(String(currentUser.documento || '').trim()));

        if (catLideresBlock) catLideresBlock.style.display = show ? '' : 'none';
        if (btnLider)        btnLider.style.display        = show ? '' : 'none';
        if (btnReferidos)    btnReferidos.style.display    = show ? '' : 'none';

        // Estos tres solo para l√≠deres autorizados por documento
        if (btnAgenda)       btnAgenda.style.display       = (show && isAuth) ? '' : 'none';
        if (btnServicios)    btnServicios.style.display    = (show && isAuth) ? '' : 'none';
        if (btnAsistir)    btnAsistir.style.display    = (show && isAuth) ? '' : 'none';
        if (btnAppComercial) btnAppComercial.style.display = (show && isAuth) ? '' : 'none';
      }catch(_){}
    }
    updateLeaderUI(false);
    
    // Choices (select con filtro)
    let choicesReg = null, choicesUpd = null, choicesCom = null;
    function initChoices(){
      if(choicesReg) choicesReg.destroy();
      if(choicesUpd) choicesUpd.destroy();
      const regSel = document.getElementById('reg-residencia');
      const updSel = document.getElementById('upd-residencia');
      if(regSel){
        choicesReg = new Choices(regSel, {
          searchEnabled: true, itemSelectText: '', shouldSort:false,
          placeholder: true, placeholderValue: 'Selecciona tu Residencia',
          searchPlaceholderValue: 'Escribe para filtrar'
        });
      }
      if(updSel){
        choicesUpd = new Choices(updSel, {
          searchEnabled: true, itemSelectText: '', shouldSort:false,
          placeholder: true, placeholderValue: 'Selecciona tu Residencia',
          searchPlaceholderValue: 'Escribe para filtrar'
        });
      }
    }
    document.addEventListener('DOMContentLoaded', initChoices);

    // LOGIN
    const btnLogin = document.getElementById('btn-login');
    const docLogin = document.getElementById('doc-login');
    const regCard = document.getElementById('registro-card');
    const btnGuardarRegistro = document.getElementById('btn-guardar-registro');

        // Toggle ver/ocultar Documento en login (igual que indexref)
    (function(){
      const toggleBtn = document.getElementById('toggle-doc-login');
      const input = document.getElementById('doc-login');
      if(!toggleBtn || !input) return;
      toggleBtn.addEventListener('click', ()=>{
        const oculto = input.type === 'password';
        input.type = oculto ? 'tel' : 'password';
        const nuevoIcono = oculto
          ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
          : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
        const accion = oculto ? 'Ocultar' : 'Mostrar';
        toggleBtn.setAttribute('aria-label', accion + ' documento');
        toggleBtn.innerHTML = '<img src="'+nuevoIcono+'" alt="'+accion+'">';
      });
    })();

    btnLogin.addEventListener('click', async () => {
  const documento = (docLogin.value || '').trim();

  if (documento === '') {
    Swal.fire({ icon:'question', title:'¬øDeseas comenzar?', text:'Ingresa un Documento para validar.', timer:3000, width:'80%', padding:'1rem', customClass:{ popup:'swal2-responsive-popup' } });
    return;
  }
  if (!/^\d{6,10}$/.test(documento)) {
    Swal.fire({ icon:'warning', title:'Documento inv√°lido', text:'El Documento debe tener de 6 a 10 d√≠gitos SIN PUNTOS NI ESPACIOS' });
    return;
  }

  try {
    // Una sola llamada r√°pida al backend
    const res = await apiGet('loginfast', { documento });

    if (res && res.existe) {
      const estado = String(res.estado || '').toUpperCase();
      if (estado === 'INACTIVO'){
        await Swal.fire({
          icon: 'info',
          title: 'No tienes acceso',
          text: 'Dirigete a la sede Frente al parque La Victoria para corroborar tu identidad',
          timer: 5000,
          showConfirmButton: false
        });
        return;
      }

      // Crear sesi√≥n y mostrar men√∫ de inmediato
      currentUser = {
        documento: res.user.documento,
        nombre: res.user.nombre,
        telefono: res.user.telefono || '',
        residencia: res.user.residencia || '',
        referencia: res.user.referencia || '',
        municipio: res.user.municipio || '',
        puesto: res.user.puesto || '',
        mesa: res.user.mesa || ''
      };
      renderUserMenu();
      playSoundOnce(SOUNDS.login);
      showView('view-menu');

        // En segundo plano: feed + badge + mostrar bot√≥n de l√≠der si aplica
      try{ sessionStorage.removeItem(FEED_SOUND_KEY); }catch(_){}
      loadFeed().then(()=> refreshNotificationsBadge()).catch(()=>{});

      // isLeader viene del backend (controla visibilidad general de la categor√≠a)
      // updateLeaderUI decide adem√°s si muestra los 3 botones especiales seg√∫n AUTH_LEADERS
      updateLeaderUI(!!res.isLeader);

    } else {
      regCard.style.display = '';
      Swal.fire({ icon:'info', title:'Nuevo usuario', text:'Completa tu registro para continuar.' });
    }
  } catch (e) {
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

    // Toggle Referido (registro)
    const regRefWrap = document.getElementById('reg-referido-wrap');
    const btnRefMas = document.getElementById('btn-ref-mas');
    const btnRefMenos = document.getElementById('btn-ref-menos');
    btnRefMas.addEventListener('click', (ev)=>{ ev.preventDefault(); regRefWrap.style.display=''; btnRefMas.classList.add('hidden'); btnRefMenos.classList.remove('hidden'); });
    btnRefMenos.addEventListener('click', (ev)=>{ ev.preventDefault(); regRefWrap.style.display='none'; btnRefMas.classList.remove('hidden'); btnRefMenos.classList.add('hidden'); document.getElementById('reg-referencia').value=''; });

    // Bot√≥n Atr√°s en registro: vuelve a login/validaci√≥n
    const btnRegAtras = document.getElementById('btn-reg-atras');
    if(btnRegAtras){
      btnRegAtras.addEventListener('click', (e)=>{
        e.preventDefault();
        playSoundOnce(SOUNDS.back);
        regCard.style.display='none';
        showView('view-login');
      });
    }

    // Guardar Registro con Resumen
    btnGuardarRegistro.addEventListener('click', async ()=>{
      const documento = (docLogin.value || '').trim();
      const formData = {
        documento,
        nombre: document.getElementById('reg-nombre').value.trim(),
        telefono: document.getElementById('reg-telefono').value.trim(),
        residencia: document.getElementById('reg-residencia').value.trim(),
        referencia: (document.getElementById('reg-referencia').value || '').trim()
      };
      const documentoRegex = /^(?:[0-9]{6,9}|1[0-9]{9})$/;
      const telefonoRegex = /^[0-9]{10}$/;
      const referenciaRegex = /^[0-9]{1,3}$/;

      // Requeridos b√°sicos
if (!formData.nombre || !formData.documento || !formData.telefono || !formData.residencia) {
  return Swal.fire({
    icon: 'warning',
    title: 'Faltan campos Requeridos',
    text: 'Completa Nombre, Documento, Whatsapp y Residencia'
  });
}

// Validar que el nombre tenga al menos 2 palabras
const nombrePalabras = formData.nombre.split(/\s+/).filter(Boolean);
if (nombrePalabras.length < 2) {
  return Swal.fire({
    icon: 'warning',
    title: 'Nombre incompleto',
    text: 'Ingresa tu nombre completo (m√≠nimo nombre y apellido).'
  });
}

// Documento
if (!documentoRegex.test(formData.documento)) {
  return Swal.fire({
    icon: 'warning',
    title: 'Documento inv√°lido',
    text: 'Revisa el n√∫mero de documento.'
  });
}

// Whatsapp / Tel√©fono
if (!telefonoRegex.test(formData.telefono)) {
  return Swal.fire({
    icon: 'warning',
    title: 'Whatsapp inv√°lido',
    text: 'Debe tener exactamente 10 d√≠gitos.'
  });
}

// Referido (opcional)
if (formData.referencia && !referenciaRegex.test(formData.referencia)) {
  return Swal.fire({
    icon: 'warning',
    title: 'Referido inv√°lido',
    text: 'Debe tener 1 a 3 d√≠gitos.'
  });
}

      const resumenHtml = `
        <b>Nombre:</b> ${formData.nombre}<br>
        <b>N¬∞ Documento:</b> ${formData.documento}<br>
        <b>Whatsapp:</b> ${formData.telefono}<br>
        <b>Residencia:</b> ${formData.residencia}<br>
        <b>Referido:</b> ${formData.referencia || 'No Registras'}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Registro', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', customClass:{ popup:'swal2-responsive-popup' },
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        const r = await apiPost('guardarContactoEnServidor', formData);
        if(r && r.success){
          // Revalidar y pasar a men√∫
          const res = await apiGet('validarDocumento', { documento: formData.documento });
          if(res?.existe){
            currentUser = {
              documento: res.documento,
              nombre: res.nombre,
              telefono: res.telefono || '',
              residencia: res.residencia || '',
              referencia: res.referencia || '',
              municipio: res.municipio || '',
              puesto: res.puesto || '',
              mesa: res.mesa || ''
            };
            // Alerta de registro exitoso
            await Swal.fire({ icon:'success', title:'Registro exitoso', timer:1800, showConfirmButton:false });
            renderUserMenu();
            playSoundOnce(SOUNDS.login);
            showView('view-menu');
            regCard.style.display='none';
          }else{
            Swal.fire({ icon:'error', title:'No se pudo completar el registro' });
          }
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', html: r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });

    // MEN√ö
    const overlay = document.getElementById('overlay');
    document.getElementById('btn-open-menu').addEventListener('click', ()=> { playSoundOnce(SOUNDS.menu); });
    document.getElementById('btn-open-menu').addEventListener('click', ()=> overlay.classList.add('open'));
    document.getElementById('btn-ovl-back').addEventListener('click', ()=> overlay.classList.remove('open'));
        document.getElementById('ovlClose').addEventListener('click', ()=>{
      playSoundOnce(SOUNDS.back);
      overlay.classList.remove('open');
    });

      // Sonido login para todos los botones del men√∫ lateral
    (function(){
      const idsMenu = [
        'go-feed',
        'go-solicitud',
        'go-ideas',
        'go-libretacontactos',
        'go-comerciantes',
        'go-sede',
        'go-redes',
        'go-asistencia',
        'go-actualizacion',
        'go-consultar',
        'go-lider',
        'go-referidos'
      ];
      idsMenu.forEach(function(id){
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('click', function(){
            playSoundOnce(SOUNDS.login);
          }, { capture:true });
        }
      });
    })();


        // Men√∫ por categor√≠as: abrir/cerrar secciones con sonido back
    (function initOverlayCategories(){
      const catButtons    = Array.from(document.querySelectorAll('.menu-cat-btn'));
      const catContainers = Array.from(document.querySelectorAll('.menu-cat-options'));

      function hideAllCategories(){
        catContainers.forEach(c =>{
          c.style.display = 'none';
          c.classList.remove('showing');
        });
        catButtons.forEach(b => b.classList.remove('active'));
      }

      function showCategory(catId){
        hideAllCategories();

        const cont = document.getElementById(catId);
        const btn  = catButtons.find(b => b.dataset.cat === catId);

        if(cont){
          cont.style.display = 'flex';
          // fuerza reflujo para poder aplicar animaci√≥n
          cont.offsetHeight;
          cont.classList.add('showing');
        }
        if(btn){
          btn.classList.add('active');
        }
      }

      // Click en la cabecera de cada categor√≠a: toggle con sonido BACK
      catButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.cat;
          if(!id) return;

          try{
            if(typeof playSoundOnce === 'function' && SOUNDS && SOUNDS.back){
              playSoundOnce(SOUNDS.back);
            }
          }catch(_){}

          const cont = document.getElementById(id);
          const isOpen = cont && cont.style.display === 'flex';

          if(isOpen){
            hideAllCategories();
          }else{
            showCategory(id);
          }
        });
      });

      // Al cargar: todas cerradas
      hideAllCategories();

      // Al abrir el overlay con el bot√≥n MEN√ö, se cierran todas las categor√≠as
      const openBtn = document.getElementById('btn-open-menu');
      if(openBtn){
        openBtn.addEventListener('click', ()=>{
          hideAllCategories();
        });
      }
    })();
    
    document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  try{ sessionStorage.removeItem(FEED_SOUND_KEY); }catch(_){}
  currentUser = null;
  docLogin.value = '';
  regCard.style.display='none';
  showView('view-login');
});

    document.getElementById('go-asistencia').addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararAsistencia();
      showView('view-asistencia');
    });
    document.getElementById('go-actualizacion').addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararActualizacion();
      showView('view-actualizacion');
    });
    document.getElementById('go-consultar').addEventListener('click', ()=>{
      overlay.classList.remove('open');
      document.getElementById('c-documento').value = currentUser?.documento || '';
      showView('view-consultar');
    });
    // NUEVO: SOLICITUD
    document.getElementById('go-solicitud').addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararSolicitud();
      showView('view-solicitud');
    });
    // NUEVO: IDEAS
    document.getElementById('go-ideas').addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararIdeas();
      showView('view-ideas');
    });
    // INSERT: NUEVO - CASA SOCIAL
    document.getElementById('go-sede').addEventListener('click', ()=>{
      overlay.classList.remove('open');
      showView('view-sede');
    });

    // NUEVO: REDES SOCIALES
document.getElementById('go-redes').addEventListener('click', ()=>{
  overlay.classList.remove('open');
  showView('view-redes');
});

    // listeners LIBRETA DE CONTACTOS
    document.getElementById('go-libretacontactos').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  try{ await loadLibretaContactos(); }catch(_){}
  showView('view-libretacontactos');
});

    document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  try{ sessionStorage.removeItem(FEED_SOUND_KEY); }catch(_){}
  currentUser = null;
  docLogin.value = '';
  regCard.style.display='none';

  // Oculta bot√≥n de l√≠der al salir
  updateLeaderUI(false);

  showView('view-login');
});

    document.getElementById('go-lider').addEventListener('click', async ()=>{
      if(!currentUser){ return; }
      try{
        const r = await apiGet('validarLider', { documento: currentUser.documento });
        if(r && r.codigo && r.nombre){
         const msg = "Hola üëãüèª\n\nQuiero pedirte que apoyes a nuestro gran amigo *Jhonny Perdomo*.\n\nInstala la App y reg√≠strate aqu√≠ üëâ " + "https://tinyurl.com/app-jhonny-perdomo" + " üëà\n\nEn el campo *N¬∞ de Referido* por favor escribe el N¬∞ üëâ " + r.codigo + " üëà (solo el n√∫mero).\n\nEn esta App encontrar√°s muchas opciones para ayudar a tu comunidad. ¬°Bendiciones!\n\nCordialmente,\n\n*" + r.nombre + "*\n> Equipo del Hacer";
          const textoEscapado = encodeURIComponent(msg);
          const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
          if(navigator.clipboard){ navigator.clipboard.writeText(msg).catch(()=>{}); }
          window.open((esMovil ? "whatsapp://send?text=" : "https://api.whatsapp.com/send?text=") + textoEscapado, "_blank");
        }else{
          Swal.fire({ icon:'info', title:'No est√°s en registros de L√≠deres' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });

    document.getElementById('go-referidos').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await prepararReferidos();
  showView('view-referidos');
});

    document.getElementById('go-jlideres').addEventListener('click', ()=>{
  overlay.classList.remove('open');
  window.open('https://botheart911.github.io/lideres-jhonny-perdomo/', '_blank');
});    

        // NUEVOS: BOTONES SOLO PARA L√çDERES AUTORIZADOS
    const btnAgendaPriv = document.getElementById('go-agenda');
    if (btnAgendaPriv){
      btnAgendaPriv.addEventListener('click', ()=>{
        overlay.classList.remove('open');
        window.open('https://botheart911.github.io/agendaPriv-Jhonny-Perdomo/', '_blank');
      });
    }

    const btnServiciosPriv = document.getElementById('go-servicios');
    if (btnServiciosPriv){
      btnServiciosPriv.addEventListener('click', ()=>{
        overlay.classList.remove('open');
        window.open('https://botheart911.github.io/servicios-jhonny-perdomo/', '_blank');
      });
    }

     const btnAsistirPriv = document.getElementById('go-asistir');
    if (btnAsistirPriv){
      btnAsistirPriv.addEventListener('click', ()=>{
        overlay.classList.remove('open');
        window.open('https://botheart911.github.io/asistencia-jhonny-perdomo/#instalar', '_blank');
      });
    }

    const btnAppComercial = document.getElementById('go-appcomercial');
    if (btnAppComercial){
      btnAppComercial.addEventListener('click', ()=>{
        Swal.fire({
          icon: 'success',
          title: 'App Comercial disponible',
          html: `
            <div style="text-align:center; margin-top:8px;">
              <p style="margin:0 0 10px;"><b>Puedes instalar o compartir la App Comercial ahora mismo.</b></p>
              <p style="margin:0;">Selecciona una opci√≥n:</p>
            </div>
          `,
          showConfirmButton: false,
          showCancelButton: false,
          footer: `
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
              <button id="appcom-instalar" class="swal2-confirm swal2-styled" style="display:block; width:100%;">
                Instalar
              </button>
              <button id="appcom-compartir" class="swal2-confirm swal2-styled" style="display:block; width:100%; background:#10b981; border-color:#10b981;">
                Compartir
              </button>
              <button id="appcom-cerrar" class="swal2-cancel swal2-styled" style="display:block; width:100%;">
                Cerrar
              </button>
            </div>
          `,
          soundTag: 'success'
        });

        // Asignar listeners a los botones del footer
        setTimeout(()=>{
          const bInstalar = document.getElementById('appcom-instalar');
          const bCompartir = document.getElementById('appcom-compartir');
          const bCerrar = document.getElementById('appcom-cerrar');

          if (bInstalar){
            bInstalar.addEventListener('click', ()=>{
              window.open('https://botheart911.github.io/comercio-jhonny-perdomo/#instalar', '_blank');
            });
          }

          if (bCompartir){
            bCompartir.addEventListener('click', async ()=>{
              const texto = 'Instala nuestra App Comercial: https://tinyurl.com/comercio-jhonny-perdomo';
              try{
                if (navigator.clipboard && navigator.clipboard.writeText){
                  await navigator.clipboard.writeText(texto);
                }
              }catch(_){}
              const enc = encodeURIComponent(texto);
              const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
              const waUrl = (esMovil ? 'whatsapp://send?text=' : 'https://api.whatsapp.com/send?text=') + enc;
              window.open(waUrl, '_blank');
            });
          }

          if (bCerrar){
            bCerrar.addEventListener('click', ()=>{
              Swal.close();
              overlay.classList.add('open');
            });
          }
        }, 50);
      });
    }

   /* ==== NOTIFICACIONES: feed, no le√≠das, badge, sonido ==== */
let FEED_CACHE = []; // √∫ltimo listado obtenido
const FEED_READ_KEY_PREFIX = 'feedReadIds@v1:';
function feedReadKey(){
  return FEED_READ_KEY_PREFIX + (currentUser?.documento || 'anon');
}
const FEED_SOUND_KEY = 'notifSoundPlayed@session';

function getReadMap(){
  try{
    const raw = localStorage.getItem(feedReadKey());
    return raw ? JSON.parse(raw) : {};
  }catch(_){ return {}; }
}
function setReadMap(map){
  try{ localStorage.setItem(feedReadKey(), JSON.stringify(map||{})); }catch(_){}
}
function isRead(id){
  const m = getReadMap();
  return !!m[id];
}
function markRead(id){
  const m = getReadMap();
  m[id] = true;
  setReadMap(m);
}

function firstLinkThumb(url){
  const placeholder = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759798601/noticias_dax8sd.jpg';
  if(!url) return placeholder;

  // Si es imagen directa, √∫sala.
  if (/\.(png|jpe?g|webp|gif|bmp|svg)(\?.*)?$/i.test(url)) return url;

  // Open Graph preview (tercero sin CORS desde el cliente)
  // Opci√≥n: thum.io OG (si el sitio expone OG image)
  return 'https://image.thum.io/get/og/' + encodeURIComponent(url);
}

async function loadFeed(){
  // IMPORTANTE: acci√≥n en min√∫sculas (el backend hace toLowerCase, pero usamos la forma definida)
  const list = await apiGet('listnotificaciones');
  FEED_CACHE = Array.isArray(list) ? list : [];
  renderFeedList(FEED_CACHE);
}
    function fallbackThumbFor(url){
  const u = String(url||'').toLowerCase();
  if(u.includes('facebook'))  return 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/facebook_nezbkz.webp';
  if(u.includes('instagram')) return 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/instragram_uft2wl.webp';
  if(u.includes('tiktok'))    return 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/tiktok_tdvc2x.webp';
  return 'https://res.cloudinary.com/dqqeavica/image/upload/v1759798601/noticias_dax8sd.jpg';
}

function renderFeedList(items){
  const wrap = document.getElementById('feed-list');
  if(!wrap) return;
  wrap.innerHTML = '';

  if(!items.length){
    const p = document.createElement('p');
    p.className = 'muted center';
    p.textContent = 'No hay notificaciones disponibles.';
    wrap.appendChild(p);
    return;
  }

  for(const it of items){
    const item = document.createElement('div');
    item.className = 'feed-item';
    item.dataset.id = it.id;

    const img = document.createElement('img');
img.className = 'feed-thumb';
img.alt = '';


img.src = firstLinkThumb(it.first_link);

img.loading = 'lazy';
img.onerror = () => {
  const enc = encodeURIComponent(it.first_link || '');
  if (!img.dataset.shotTried){
    img.dataset.shotTried = '1';
    img.src = 'https://image.thum.io/get/width/900/crop/500/noanimate/' + enc;
    return;
  }
  img.src = fallbackThumbFor(it.first_link);
};

    const ct = document.createElement('div');
    ct.className = 'feed-content';

    const h = document.createElement('h4');
    h.className = 'feed-title';
    h.textContent = String(it.titulo||'');

    const p = document.createElement('p');
    p.className = 'feed-desc';
    p.textContent = String(it.descripcion||'');

    ct.appendChild(h);
    ct.appendChild(p);

    item.appendChild(img);
    item.appendChild(ct);

    if(!isRead(it.id)){
      const dot = document.createElement('span');
      dot.className = 'feed-dot';
      item.appendChild(dot);
    }

    item.addEventListener('click', ()=> openFeedDetail(it));
    wrap.appendChild(item);
  }
}

function openFeedDetail(it){
  const thumb = document.getElementById('fd-thumb');
  const title = document.getElementById('fd-title');
  const desc  = document.getElementById('fd-desc');
  const link  = document.getElementById('fd-link');

  // Imagen fija para el detalle
  if (thumb){
    thumb.src = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759798601/noticias_dax8sd.jpg';
    thumb.loading = 'lazy';
  }

  if (title) title.textContent = String(it.titulo || '');
  if (desc)  desc.textContent  = String(it.descripcion || '');

  // Link de acci√≥n (mostrar/ocultar y texto)
if (link){
  // 1) intenta extraer el primer v√≠nculo de la descripci√≥n
  const urlFromDesc = extractFirstUrl(it.descripcion);
  // 2) si no hay en la descripci√≥n, usa el proporcionado por el backend (si existe)
  const firstUrl = urlFromDesc || it.first_link || '';

  if (firstUrl){
    link.href = firstUrl;
    link.style.display = '';
  } else {
    link.href = '#';
    link.style.display = 'none';
  }
  link.textContent = 'Ay√∫danos con tu Like, Comenta y comparte';
}
  // Marcar como le√≠da y refrescar UI del listado y badge
  markRead(it.id);
  renderFeedList(FEED_CACHE);
  refreshNotificationsBadge();

  // Mostrar vista detalle
  showView('view-feed-detail');
}

function extractFirstUrl(text){
  if(!text) return null;
  const m = String(text).match(/(https?:\/\/[^\s'"<>]+|www\.[^\s'"<>]+)/i);
  if(!m) return null;
  let u = m[0];
  if(u.startsWith('www.')) u = 'https://' + u; // normaliza www. -> https://
  return u;
}
    
function unreadCountFrom(items){
  if(!Array.isArray(items) || !items.length) return 0;
  let n = 0;
  for(const it of items){ if(!isRead(it.id)) n++; }
  return n;
}

async function refreshNotificationsBadge(){
  try{
    // Usar el cache en memoria (FEED_CACHE) para contar no le√≠das
    const count = unreadCountFrom(FEED_CACHE);

    const bell = document.getElementById('notif-bell');
    const label = document.getElementById('notif-label');
    const btnBadge = document.getElementById('go-feed-badge');

    // Actualizar badge del bot√≥n del men√∫
    if(btnBadge){
      btnBadge.textContent = String(count);
      if(count > 0) btnBadge.classList.add('active');
      else btnBadge.classList.remove('active');
    }

    if(count > 0){
      bell && bell.classList.add('active');
      label && label.classList.add('active');

      // Sonar solo una vez por sesi√≥n mientras existan no le√≠das
      const played = sessionStorage.getItem(FEED_SOUND_KEY) === '1';
      if(!played){
        playSoundOnce(SOUNDS.notify);
        try{ sessionStorage.setItem(FEED_SOUND_KEY, '1'); }catch(_){}
      }
    }else{
      bell && bell.classList.remove('active');
      label && label.classList.remove('active');
      try{ sessionStorage.removeItem(FEED_SOUND_KEY); }catch(_){}
    }
  }catch(_){
    // Si algo falla, oculta los indicadores
    const bell = document.getElementById('notif-bell');
    const label = document.getElementById('notif-label');
    const btnBadge = document.getElementById('go-feed-badge');
    bell && bell.classList.remove('active');
    label && label.classList.remove('active');
    btnBadge && btnBadge.classList.remove('active');
  }
}

    /* ==== LIBRETA DE CONTACTOS (cargar y pintar) ==== */
async function loadLibretaContactos(){
  const list = await apiGet('listcontactos');   // acci√≥n en min√∫sculas
  renderContactos(Array.isArray(list) ? list : []);
}

function renderContactos(items){
  const wrap = document.getElementById('lc-list');
  if(!wrap) return;
  wrap.innerHTML = '';

  if(!items.length){
    const p = document.createElement('p');
    p.className = 'muted center';
    p.textContent = 'No hay contactos disponibles.';
    wrap.appendChild(p);
    return;
  }

  for(const it of items){
    const name = String(it.nombre || '').trim();
    const waRaw = String(it.whatsapp || '').trim();   // Columna C
    const telRaw = String(it.telefono || '').trim();  // Columna D

    // Normaliza a solo d√≠gitos
    const waDigits = waRaw.replace(/\D/g, '');   // esperado tipo 57XXXXXXXXXX
    const telDigits = telRaw.replace(/\D/g, ''); // puede ser 310... o 601...

    // Enlaces
    const waLink = 'https://wa.me/' + waDigits;
    const telLink = 'tel:' + telDigits;

    // Contenedor de √≠tem
    const item = document.createElement('div');
    item.className = 'contact-item';

    // Nombre (crece si es largo por CSS)
    const title = document.createElement('div');
    title.className = 'contact-name';
    title.textContent = name || 'Contacto';

    // Acciones
    const actions = document.createElement('div');
    actions.className = 'contact-actions';

    // Bot√≥n WhatsApp (solo si hay dato)
    if (waDigits){
      const aWa = document.createElement('a');
      aWa.href = waLink;
      aWa.target = '_blank';
      aWa.rel = 'noopener';
      aWa.setAttribute('aria-label', 'Abrir chat de WhatsApp');

      const imgWa = document.createElement('img');
      imgWa.src = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp';
      imgWa.alt = '';
      aWa.appendChild(imgWa);

      actions.appendChild(aWa);
    }

    // Bot√≥n Llamada (solo si hay dato)
    if (telDigits){
      const aTel = document.createElement('a');
      aTel.href = telLink;
      aTel.setAttribute('aria-label', 'Llamar al contacto');

      const imgTel = document.createElement('img');
      imgTel.src = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759952569/Llamada_hra2ch.webp';
      imgTel.alt = '';
      aTel.appendChild(imgTel);

      actions.appendChild(aTel);
    }

    // Armar tarjeta
    item.appendChild(title);
    item.appendChild(actions);
    wrap.appendChild(item);
  }
}
    
    // COMPARTIR PORTAL (con men√∫ + sonidos)
document.getElementById('btn-compartir').addEventListener('click', ()=>{

  // Sonido al abrir el men√∫ de compartir
  try{ playSoundOnce(SOUNDS.success); }catch(_){}

  Swal.fire({
    icon: 'success',
    title: 'COMPARTE LA APP',
    text: 'Selecciona una opci√≥n',
    showConfirmButton: false,
    showCancelButton: false,
    footer: `
      <div style="display:flex; justify-content:center; gap:14px; align-items:center; width:100%;">
        
        <button id="share-wa" class="swal2-confirm swal2-styled"
          style="display:inline-flex; align-items:center; justify-content:center; width:64px; height:54px; padding:0; margin:0;">
          <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp"
               alt="WhatsApp" style="width:32px; height:32px; object-fit:contain;">
        </button>

        <button id="share-qr" class="swal2-confirm swal2-styled"
          style="display:inline-flex; align-items:center; justify-content:center; width:64px; height:54px; padding:0; margin:0; background:#10b981; border-color:#10b981;">
          <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1769201714/QR_v8d70l.jpg"
               alt="QR" style="width:32px; height:32px; object-fit:contain;">
        </button>

        <button id="share-close" class="swal2-cancel swal2-styled"
          style="display:inline-flex; align-items:center; justify-content:center; width:64px; height:54px; padding:0; margin:0;">
          <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1769201713/cerrar_dob9nv.png"
               alt="Cerrar" style="width:28px; height:28px; object-fit:contain;">
        </button>

      </div>
    `
  });

  setTimeout(()=>{

    const btnWA = document.getElementById('share-wa');
    const btnQR = document.getElementById('share-qr');
    const btnClose = document.getElementById('share-close');

    // 1) WhatsApp: ejecuta la acci√≥n actual
    if (btnWA){
      btnWA.addEventListener('click', async ()=>{
        try{ playSoundOnce(SOUNDS.login); }catch(_){}

        const url = "https://tinyurl.com/app-jhonny-perdomo";
        const txt = "Instala la *App de Jhonny Perdomo* üì≤ y reg√≠strate con un clic:\n" + url;

        try{
          if(navigator.clipboard && navigator.clipboard.writeText){
            await navigator.clipboard.writeText(txt);
          }
        }catch(_){}

        const enc = encodeURIComponent(txt);
        const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
        window.open((esMovil ? "whatsapp://send?text=" : "https://api.whatsapp.com/send?text=") + enc, "_blank");
      });
    }

    // 2) QR: muestra imagen + bot√≥n cerrar + vuelve a login
    if (btnQR){
      btnQR.addEventListener('click', async ()=>{
        try{ playSoundOnce(SOUNDS.success); }catch(_){}

        await Swal.fire({
          icon: 'success',
          title: 'ESCANEA EL QR PARA INSTALAR',
          imageUrl: 'https://res.cloudinary.com/dqqeavica/image/upload/v1769201414/qr_app_cwdtrj.png',
          imageAlt: 'QR para instalar',
          confirmButtonText: 'Cerrar'
        });

        // Sonido "atr√°s" al volver a login
        try{ playSoundOnce(SOUNDS.back); }catch(_){}
        showView('view-login');
      });
    }

    // 3) Cerrar alerta
    if (btnClose){
      btnClose.addEventListener('click', ()=>{
        try{ playSoundOnce(SOUNDS.back); }catch(_){}
        Swal.close();
      });
    }

  }, 50);
});

   // VIDEO (con miniatura, Cloudinary MP4, 1 clic)
const videoCard = document.getElementById('videoCard');
const playLayer = document.getElementById('playLayer');
const videoThumb = document.getElementById('videoThumb');

let currentVideo = null; // referencia al <video> creado

function playVideo(){
  // Evita crear el video m√°s de una vez
  if (videoCard.querySelector('video')) return;

  const src = 'https://res.cloudinary.com/dqqeavica/video/upload/v1759803503/Bienvenida_d0q2bs.mp4';

  const video = document.createElement('video');
  video.src = src;
  video.autoplay = true;     // autoplay en el primer clic
  video.muted = false;       // reproducci√≥n con audio (puede requerir interacci√≥n en algunos navegadores)
  video.playsInline = true;  // iOS: evita fullscreen autom√°tico
  video.controls = true;     // controles visibles
  video.preload = 'auto';
  video.setAttribute('title', 'Video');

  // Miniatura como poster mientras carga
  if (videoThumb && videoThumb.src) video.poster = videoThumb.src;

  // Ajuste visual al contenedor
  video.style.width = '100%';
  video.style.height = '100%';
  video.style.display = 'block';
  video.style.objectFit = 'cover';

  videoCard.appendChild(video);
  videoCard.classList.add('playing');

  currentVideo = video;

  // Intentar reproducir y, si falla por pol√≠ticas de autoplay con sonido,
  // como fallback silencia y vuelve a intentar (manteniendo 1 clic)
  const p = video.play();
  if (p && typeof p.then === 'function') {
    p.catch(() => {
      video.muted = true;
      video.play().catch(()=>{ /* ignorar */ });
    });
  }

  // Limpieza al finalizar
  video.addEventListener('ended', stopVideoPlayback);
}

// Detener y limpiar el video (se llama al cambiar de vista/men√∫, logout, etc.)
function stopVideoPlayback(){
  const v = currentVideo || videoCard.querySelector('video');
  if (!v) {
    videoCard.classList.remove('playing');
    return;
  }
  try {
    v.pause();
    // liberar recursos de la descarga
    v.removeAttribute('src');
    v.load();
  } catch(_){}
  // quitar del DOM
  v.remove();
  currentVideo = null;
  // restaurar estado visual (mostrar miniatura y capa play)
  videoCard.classList.remove('playing');
}

// Un solo clic en imagen o capa de play
if (playLayer) playLayer.addEventListener('click', playVideo);
if (videoThumb) videoThumb.addEventListener('click', playVideo);

// Detener si la pesta√±a pierde foco (opcional pero recomendado)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) stopVideoPlayback();
});

// Detener al navegar desde el men√∫ a cualquier otra vista
['go-asistencia','go-actualizacion','go-consultar','go-solicitud','go-ideas','go-sede','go-redes','btn-logout','go-feed','go-libretacontactos','go-comerciantes','go-referidos']
  .forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('click', () => stopVideoPlayback(), { capture: true });
    }
  });
    
    // ASISTENCIA
let aReunionDebounceTimer = null;
let aReunionQuerySeq = 0;
    
    async function prepararAsistencia(){
  if(!currentUser) return;
  document.getElementById('a-documento').value = currentUser.documento;
  try{
    const d = await apiGet('validarDocumento4', { documento: currentUser.documento });
    if(d){
      document.getElementById('a-nombre').value = d.nombre || '';
      document.getElementById('a-telefono').value = d.telefono || '';
    }
  }catch{}

  document.getElementById('a-reunion').value = '';
  document.getElementById('a-evento').value = '';
  document.getElementById('evento-wrap').style.display = 'none';

  // INSERT: limpia debounce e invalida peticiones en curso
  if (aReunionDebounceTimer) clearTimeout(aReunionDebounceTimer);
  aReunionDebounceTimer = null;
  aReunionQuerySeq++;
}
    document.getElementById('a-reunion').addEventListener('input', (e) => {
  const wrap = document.getElementById('evento-wrap');
  const out  = document.getElementById('a-evento');
  const val  = (e.target.value || '').trim();

  // Si est√° vac√≠o: cancela debounce, invalida peticiones, oculta y limpia
  if (!val){
    if (aReunionDebounceTimer) clearTimeout(aReunionDebounceTimer);
    aReunionDebounceTimer = null;
    aReunionQuerySeq++; // invalida cualquier petici√≥n en vuelo
    wrap.style.display = 'none';
    out.value = '';
    return;
  }

  // Reinicia el temporizador de espera
  if (aReunionDebounceTimer) clearTimeout(aReunionDebounceTimer);
  aReunionDebounceTimer = setTimeout(async () => {
    const currentVal = (document.getElementById('a-reunion').value || '').trim();
    if (!currentVal){ wrap.style.display='none'; out.value=''; return; }

    // ID de consulta para descartar respuestas antiguas
    const mySeq = ++aReunionQuerySeq;
    try{
      const r = await apiGet('validarReunion', { reunion: currentVal });
      if (mySeq !== aReunionQuerySeq) return; // hubo otra b√∫squeda m√°s reciente
      out.value = r?.evento || '';
      wrap.style.display = '';
    }catch(_){}
  }, 1250); // 1 segundo y cuarto
});
    document.getElementById('a-guardar').addEventListener('click', async ()=>{
      const body = {
        documento: document.getElementById('a-documento').value.trim(),
        nombre: document.getElementById('a-nombre').value.trim(),
        telefono: document.getElementById('a-telefono').value.trim(),
        reunion: document.getElementById('a-reunion').value.trim(),
        evento: document.getElementById('a-evento').value.trim()
      };
      const documentoRegex = /^[0-9]{6,10}$/;
      const reunionRegex = /^[0-9]{1,3}$/;
      if(!documentoRegex.test(body.documento)){
        return Swal.fire({icon:'warning',title:'Documento inv√°lido'});
      }
      if(!reunionRegex.test(body.reunion)){
        return Swal.fire({icon:'warning',title:'N¬∞ de Evento inv√°lido'});
      }
      try{
        const r = await apiPost('guardarAsistenciaEnServidor', body);
        if(r && r.success){
          await Swal.fire({ icon:'success', title:'Asistencia registrada', timer:1500, showConfirmButton:false });
          showView('view-menu');
        }else{
          Swal.fire({ icon:'info', title:'Atenci√≥n', html: r?.message || 'No se pudo registrar' });
        }
      }catch(e){
        Swal.fire({ icon:'info', title:'Atenci√≥n', text:e.message });
      }
    });
    document.getElementById('a-volver').addEventListener('click', ()=> showView('view-menu'));

    // VOTACI√ìN (pegar fila)
    function parseFila(text){
      const ENC = ["NUIP","DEPARTAMENTO","MUNICIPIO","PUESTO","DIRECCI√ìN","MESA"];
      let p = (text||'').split(/[\t\n\r]+/).map(s=>s.trim()).filter(Boolean);
      if(p.length>=6 && ENC.every(e => p.slice(0,6).join(' ').toUpperCase().includes(e))) p = p.slice(6);
      p = p.filter(x => !ENC.includes(x.toUpperCase()));
      if(p.length>6) p[5] = p.slice(5).join(' ');
      if(p.length>6) p = p.slice(0,6);
      return p;
    }
    function intentarAutocompletar(){
      const t = document.getElementById('v-row').value.trim();
      const p = parseFila(t);
      if(p.length===6){
        document.getElementById('v-nuip').value = p[0];
        document.getElementById('v-departamento').value = p[1];
        document.getElementById('v-municipio').value = p[2];
        document.getElementById('v-puesto').value = p[3];
        document.getElementById('v-direccion').value = p[4];
        document.getElementById('v-mesa').value = p[5];
      }
    }
    ['paste','input','blur'].forEach(evt=>{
      document.getElementById('v-row').addEventListener(evt, ()=> setTimeout(intentarAutocompletar, 80));
    });
    // VOTACI√ìN (pegar fila)
document.getElementById('v-guardar').addEventListener('click', async ()=>{
  const body = {
    nuip: document.getElementById('v-nuip').value.trim(),
    departamento: document.getElementById('v-departamento').value.trim(),
    municipio: document.getElementById('v-municipio').value.trim(),
    puesto: document.getElementById('v-puesto').value.trim(),
    direccion: document.getElementById('v-direccion').value.trim(),
    mesa: document.getElementById('v-mesa').value.trim()
  };
  if(Object.values(body).some(v=>!v)){
    return Swal.fire({ icon:'warning', title:'Faltan datos', text:'Pega la fila de la consulta primero.' });
  }
  try{
    const r = await apiPost('guardarVotacionEnServidor', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Informaci√≥n guardada', timer:1800, showConfirmButton:false });
      // Actualiza los datos del usuario para reflejar municipio/puesto/mesa reci√©n guardados
      try{ await refreshUserFromServer(); }catch(_){}
      showView('view-menu');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error al guardar', text:e.message });
  }
});
    document.getElementById('v-volver').addEventListener('click', ()=> showView('view-menu'));

    // ACTUALIZACI√ìN (con Resumen)
    async function prepararActualizacion(){
      if(!currentUser) return;
      document.getElementById('upd-documento').value = currentUser.documento;
      try{
        const r = await apiGet('validarDocumento3',{ documento: currentUser.documento });
        document.getElementById('upd-nombre').value = r?.existe ? (r.nombre || '') : (currentUser.nombre || '');
      }catch{
        document.getElementById('upd-nombre').value = currentUser.nombre || '';
      }
      document.getElementById('upd-telefono').value = '';
      document.getElementById('upd-residencia').value = '';
      document.getElementById('upd-referencia').value = '';
      if(choicesUpd) choicesUpd.setChoiceByValue('');
    }
    // Toggle Referido en Actualizaci√≥n
    const updRefWrap = document.getElementById('upd-referido-wrap');
    const updRefMas = document.getElementById('upd-ref-mas');
    const updRefMenos = document.getElementById('upd-ref-menos');
    updRefMas.addEventListener('click', (ev)=>{ ev.preventDefault(); updRefWrap.style.display=''; updRefMas.classList.add('hidden'); updRefMenos.classList.remove('hidden'); });
    updRefMenos.addEventListener('click', (ev)=>{ ev.preventDefault(); updRefWrap.style.display='none'; updRefMas.classList.remove('hidden'); updRefMenos.classList.add('hidden'); document.getElementById('upd-referencia').value=''; });

    document.getElementById('upd-guardar').addEventListener('click', async ()=>{
      const body = {
        documento: document.getElementById('upd-documento').value.trim(),
        nombre: document.getElementById('upd-nombre').value.trim(),
        telefono: document.getElementById('upd-telefono').value.trim(),
        residencia: document.getElementById('upd-residencia').value,
        referencia: document.getElementById('upd-referencia').value.trim()
      };
      const documentoRegex = /^[0-9]{6,10}$/;
      const telefonoRegex = /^[0-9]{10}$/;
      const referenciaRegex = /^[0-9]{1,3}$/;

      if(!documentoRegex.test(body.documento)){
        return Swal.fire({ icon:'warning', title:'Documento inv√°lido' });
      }
      if(body.telefono && !telefonoRegex.test(body.telefono)){
        return Swal.fire({ icon:'warning', title:'Whatsapp inv√°lido' });
      }
      if(body.referencia && !referenciaRegex.test(body.referencia)){
        return Swal.fire({ icon:'warning', title:'Referido inv√°lido', text:'Debe tener 1 a 3 d√≠gitos.' });
      }

      const resumenHtml = `
        <b>N¬∞ Documento:</b> ${body.documento}<br>
        <b>Whatsapp:</b> ${body.telefono || 'Sin cambios'}<br>
        <b>Residencia:</b> ${body.residencia || 'Sin cambios'}<br>
        <b>Referido:</b> ${body.referencia || 'Sin cambios'}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Actualizaci√≥n', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', customClass:{ popup:'swal2-responsive-popup' },
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        const r = await apiPost('guardarActualizacionEnServidor', body);
        if(r && r.success){
          await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
          // Refrescar datos en men√∫ autom√°ticamente
          await refreshUserFromServer();
          showView('view-menu');
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });
    document.getElementById('upd-volver').addEventListener('click', ()=> showView('view-menu'));


    // CONSULTAR (requisitos de alertas y botones)
document.getElementById('c-validar').addEventListener('click', async ()=>{
  const documento = (document.getElementById('c-documento').value || '').trim();
  if(!/^\d{6,10}$/.test(documento)){
    return Swal.fire({ icon:'warning', title:'Documento inv√°lido', text:'Ingresa de 6 a 10 d√≠gitos.' });
  }
  try{
    const r = await apiGet('validarDocumento2', { documento });
    const cResult = document.getElementById('c-result');
    if(!r?.existe){
      cResult.style.display = 'none';
      await Swal.fire({ icon:'warning', title:'Documento No encontrado', timer:2000, showConfirmButton:false });
      return;
    }
    const ok = !!(r.departamento && r.municipio && r.puesto && r.direccion && r.mesa);
    if(!ok){
      cResult.style.display = 'none';
      const rs = await Swal.fire({
        icon:'info',
        title:`No encontramos informaci√≥n de votaci√≥n`,
        text:`Puedes validar nuevamente o ir a la secci√≥n "Votaci√≥n" para registrarla.`,
        showDenyButton:true,
        denyButtonText:'Validar Nuevamente',
        showConfirmButton:true,
        confirmButtonText:'Consultar'
      });
      if(rs.isConfirmed){
        // Copiar el documento al portapapeles y abrir la vista de votaci√≥n
        try{
          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function'){
            await navigator.clipboard.writeText(documento);
          }
        }catch(_){}
        showView('view-votacion');
      }
      // si es Deny, solo cerrar
      return;
    }
    // Mostrar resultados
    document.getElementById('c-dep').textContent = r.departamento;
    document.getElementById('c-mun').textContent = r.municipio;
    document.getElementById('c-pue').textContent = r.puesto;
    document.getElementById('c-dir').textContent = r.direccion;
    document.getElementById('c-mesa').textContent = r.mesa;
    cResult.style.display = '';
    Swal.fire({ icon:'success', title:`Datos de Votaci√≥n cargados` , timer:1400, showConfirmButton:false });
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
    document.getElementById('c-volver').addEventListener('click', ()=> showView('view-menu'));

    // SOLICITUD (con Resumen)
    async function prepararSolicitud(){
      if(!currentUser) return;
      document.getElementById('s-documento').value = currentUser.documento || '';
      // Limpiar campos
      document.getElementById('s-nombre').value = '';
      document.getElementById('s-telefono').value = '';
      document.getElementById('s-residencia').value = '';
      document.getElementById('s-servicio').value = '';
      document.getElementById('s-solicitud').value = '';

      try{
        const r = await apiGet('validarDocumento5', { documento: currentUser.documento });
        if(r && r.existe){
          document.getElementById('s-nombre').value = r.nombre || '';
          document.getElementById('s-telefono').value = r.telefono || '';
          document.getElementById('s-residencia').value = r.residencia || '';
        }else{
          // Si no existe, usar los datos del currentUser
          document.getElementById('s-nombre').value = currentUser.nombre || '';
          document.getElementById('s-telefono').value = currentUser.telefono || '';
          document.getElementById('s-residencia').value = currentUser.residencia || '';
        }
      }catch(_){
        document.getElementById('s-nombre').value = currentUser.nombre || '';
        document.getElementById('s-telefono').value = currentUser.telefono || '';
        document.getElementById('s-residencia').value = currentUser.residencia || '';
      }
    }

    document.getElementById('s-guardar').addEventListener('click', async ()=>{
      const body = {
        documento: (document.getElementById('s-documento').value || '').trim(),
        nombre: (document.getElementById('s-nombre').value || '').trim(),
        telefono: (document.getElementById('s-telefono').value || '').trim(),
        residencia: (document.getElementById('s-residencia').value || '').trim(),
        servicio: document.getElementById('s-servicio').value,
        solicitud: (document.getElementById('s-solicitud').value || '').trim()
      };
      const docRegex = /^[0-9]{6,10}$/;
      if(!docRegex.test(body.documento)){
        return Swal.fire({ icon:'warning', title:'Documento inv√°lido', text:'Documento no v√°lido en sesi√≥n.' });
      }
      if(!body.servicio){
        return Swal.fire({ icon:'warning', title:'Servicio requerido', text:'Selecciona un servicio.' });
      }
      if(!body.solicitud){
        return Swal.fire({ icon:'warning', title:'Solicitud requerida', text:'Describe brevemente tu solicitud.' });
      }

      const resumenHtml = `
        <b>Nombre:</b> ${body.nombre}<br>
        <b>N¬∞ Documento:</b> ${body.documento}<br>
        <b>Whatsapp:</b> ${body.telefono || 'N/A'}<br>
        <b>Residencia:</b> ${body.residencia || 'N/A'}<br>
        <b>Servicio:</b> ${body.servicio}<br>
        <b>Solicitud:</b> ${body.solicitud}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Solicitud', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', customClass:{ popup:'swal2-responsive-popup' },
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        const r = await apiPost('guardarSolicitudEnServidor', body);
        if(r && r.success){
          await Swal.fire({ icon:'success', title:'Solicitud enviada', timer:1700, showConfirmButton:false });
          showView('view-menu');
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });
    document.getElementById('s-volver').addEventListener('click', ()=> showView('view-menu'));

    // IDEAS (con Resumen)
    async function prepararIdeas(){
      if(!currentUser) return;
      document.getElementById('i-documento').value = currentUser.documento || '';
      // Limpiar campos
      document.getElementById('i-nombre').value = '';
      document.getElementById('i-telefono').value = '';
      document.getElementById('i-residencia').value = '';
      document.getElementById('i-social').value = '';
      document.getElementById('i-institucional').value = '';
      document.getElementById('i-economico').value = '';
      document.getElementById('i-ambiental').value = '';
      document.getElementById('i-otros').value = '';

      try{
        const r = await apiGet('validarDocumento6', { documento: currentUser.documento });
        if(r && r.existe){
          document.getElementById('i-nombre').value = r.nombre || '';
          document.getElementById('i-telefono').value = r.telefono || '';
          document.getElementById('i-residencia').value = r.residencia || '';
        }else{
          document.getElementById('i-nombre').value = currentUser.nombre || '';
          document.getElementById('i-telefono').value = currentUser.telefono || '';
          document.getElementById('i-residencia').value = currentUser.residencia || '';
        }
      }catch(_){
        document.getElementById('i-nombre').value = currentUser.nombre || '';
        document.getElementById('i-telefono').value = currentUser.telefono || '';
        document.getElementById('i-residencia').value = currentUser.residencia || '';
      }
    }

    document.getElementById('i-guardar').addEventListener('click', async ()=>{
      const body = {
        documento: (document.getElementById('i-documento').value || '').trim(),
        nombre: (document.getElementById('i-nombre').value || '').trim(),
        telefono: (document.getElementById('i-telefono').value || '').trim(),
        residencia: (document.getElementById('i-residencia').value || '').trim(),
        social: (document.getElementById('i-social').value || '').trim(),
        institucional: (document.getElementById('i-institucional').value || '').trim(),
        economico: (document.getElementById('i-economico').value || '').trim(),
        ambiental: (document.getElementById('i-ambiental').value || '').trim(),
        otros: (document.getElementById('i-otros').value || '').trim()
      };
      const docRegex = /^[0-9]{6,10}$/;
      if(!docRegex.test(body.documento)){
        return Swal.fire({ icon:'warning', title:'Documento inv√°lido', text:'Documento no v√°lido en sesi√≥n.' });
      }

      const resumenHtml = `
        <b>Nombre:</b> ${body.nombre}<br>
        <b>N¬∞ Documento:</b> ${body.documento}<br>
        <b>Whatsapp:</b> ${body.telefono || 'N/A'}<br>
        <b>Residencia:</b> ${body.residencia || 'N/A'}<br>
        <hr>
        <b>Aspecto Social:</b><br>${(body.social||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <b>Aspecto Institucional:</b><br>${(body.institucional||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <b>Aspecto Econ√≥mico:</b><br>${(body.economico||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <b>Aspecto Ambiental:</b><br>${(body.ambiental||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <b>Otros:</b><br>${(body.otros||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Ideas', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', customClass:{ popup:'swal2-responsive-popup' },
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        const r = await apiPost('guardarIdeasEnServidor', body);
        if(r && r.success){
          await Swal.fire({ icon:'success', title:'¬°Gracias por tus Ideas!', timer:1700, showConfirmButton:false });
          showView('view-menu');
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });
    document.getElementById('i-volver').addEventListener('click', ()=> showView('view-menu'));

    document.getElementById('feed-volver').addEventListener('click', ()=> showView('view-menu'));
document.getElementById('fd-volver').addEventListener('click', ()=> showView('view-feed'));

    // ==== Comerciantes Amigos ====

// Iconos (incluye el faltante de ubicaci√≥n)
const ICON_UBIC = 'https://res.cloudinary.com/dqqeavica/image/upload/v1760108968/ubicacion_zicnod.png';
const ICON_FB   = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/facebook_nezbkz.webp';
const ICON_IG   = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/instragram_uft2wl.webp';
const ICON_TT   = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/tiktok_tdvc2x.webp';
const ICON_WA   = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp';
const ICON_TEL  = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759952569/Llamada_hra2ch.webp';

document.getElementById('go-comerciantes').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await prepararComerciantes();
  showView('view-comerciantes');
});

function driveThumb(url){
  const m = String(url||'').match(/[-\w]{25,}/);
  return m ? `https://drive.google.com/thumbnail?sz=w1000&id=${m[0]}` : String(url||'');
}

async function prepararComerciantes(){
  // Limpia UI
  const sel = document.getElementById('com-cat');
  const spec = document.getElementById('com-spec');
  const specText = document.getElementById('com-spec-text');
  const specChip = document.getElementById('com-cat-chip');
  const list = document.getElementById('com-list');
  if(!sel || !list) return;

  // Si ya hab√≠a un Choices, destr√∫yelo antes de repoblar
  if (choicesCom) {
    try { choicesCom.destroy(); } catch(_) {}
    choicesCom = null;
  }

  sel.innerHTML = '<option value="" selected disabled>Selecciona la Categor√≠a</option>';
  spec.style.display = 'none';
  specText.textContent = '';
  specChip.textContent = '';
  list.innerHTML = '';

  // Carga categor√≠as desde el GS
  try{
    const cats = await apiGet('listcategoriascomercio');

    // Choices SIN caja de b√∫squeda (solo lista para seleccionar)
    choicesCom = new Choices(sel, {
      searchEnabled: false,     // el usuario NO escribe, solo selecciona
      itemSelectText: '',
      shouldSort: true,
      placeholder: true,
      placeholderValue: 'Selecciona la Categor√≠a'
    });

    // Poblamos usando setChoices
    choicesCom.setChoices(
      (Array.isArray(cats) ? cats : []).map(c => ({
        value: c, label: c, selected:false, disabled:false
      })),
      'value', 'label', true
    );

  }catch(_){
    // Fallback sin Choices si algo falla
    try{
      const cats = await apiGet('listcategoriascomercio');
      if(Array.isArray(cats)){
        for(const c of cats){
          const opt = document.createElement('option');
          opt.value = c; opt.textContent = c;
          sel.appendChild(opt);
        }
      }
    }catch(__){}
  }
}

    // Helper: limpia resultados (lista y especificaci√≥n), sin tocar la selecci√≥n,
// y oculta/elimina el segundo bot√≥n ("Ocultar") si existe.
function clearComerciantesUI(){
  const list = document.getElementById('com-list');
  const spec = document.getElementById('com-spec');
  if (list) list.innerHTML = '';
  if (spec) spec.style.display = 'none';

  // Oculta/elimina el bot√≥n inferior si est√° presente
  const bottomBtn = document.getElementById('com-volver-bottom');
  if (bottomBtn && bottomBtn.parentElement){
    bottomBtn.parentElement.remove(); // remueve el contenedor del bot√≥n inferior
  }
}

document.getElementById('com-cat')?.addEventListener('change', async (e)=>{
  const categoria = e.target.value;
  if(!categoria) return;
  try{
    const data = await apiGet('comercioporcategoria', { categoria });
    renderComercioSpec(data?.categoria || categoria, data?.especificaciones || '');
    renderComercioList(Array.isArray(data?.items) ? data.items : []);
  }catch(err){
    Swal.fire({ icon:'error', title:'Error', text:String(err?.message||err) });
  }
});

function renderComercioSpec(cat, txt){
  const spec = document.getElementById('com-spec');
  const specText = document.getElementById('com-spec-text');
  const specChip = document.getElementById('com-cat-chip');
  if(!spec || !specText || !specChip) return;
  specChip.textContent = cat || '';
  specText.textContent = txt || '';
  spec.style.display = (cat || txt) ? '' : 'none';
}

function renderComercioList(items){
  const wrap = document.getElementById('com-list');
  if(!wrap) return;
  wrap.innerHTML = '';

  if(!items.length){
    const p = document.createElement('p');
    p.className = 'muted center';
    p.textContent = 'No hay comercios para esta categor√≠a.';
    wrap.appendChild(p);
    return;
  }

  for(const it of items){
    // Normaliza tel√©fonos (misma l√≥gica de "Libreta de contactos")
    let waDigits = String(it.whatsapp||'').replace(/\D/g,'');
    if(/^3\d{9}$/.test(waDigits)) waDigits = '57' + waDigits;
    const telDigits = String(it.llamada||'').replace(/\D/g,'');

    const card = document.createElement('div');
    card.className = 'com-card';

    const title = document.createElement('div');
    title.className = 'com-card-title';
    title.textContent = it.titulo || '';

    const sub = document.createElement('div');
    sub.className = 'com-card-sub';
    sub.textContent = it.subtitulo || '';

    const img = document.createElement('img');
    img.className = 'com-card-img';
    img.alt = '';
    img.loading = 'lazy';
    img.src = driveThumb(it.imagen || '');

    const desc = document.createElement('div');
    desc.className = 'com-card-desc';
    desc.textContent = it.descripcion || '';

    // Etiqueta y recuadro Premium
    const premiumLabel = document.createElement('div');
    premiumLabel.className = 'com-offer-label';
    premiumLabel.textContent = 'Oferta Usuarios Premium';

    const hi = document.createElement('div');
    hi.className = 'com-card-hi';
    hi.textContent = it.premiumColor || '';

    // Etiqueta y recuadro Est√°ndar
    const stdLabel = document.createElement('div');
    stdLabel.className = 'com-offer-label';
    stdLabel.textContent = 'Oferta Usuarios Est√°ndar';

    const std = document.createElement('div');
    std.className = 'com-card-std';
    std.textContent = it.estandarColor || '';

    const actions = document.createElement('div');
    actions.className = 'com-card-actions';

    function addIcon(href, icon){
      if(!href) return;
      const a = document.createElement('a');
      a.href = href; a.target = '_blank'; a.rel = 'noopener';
      const i = document.createElement('img');
      i.src = icon; i.alt = '';
      a.appendChild(i);
      actions.appendChild(a);
    }

    addIcon(it.ubicacion || '', ICON_UBIC);
    addIcon(it.facebook  || '', ICON_FB);
    addIcon(it.instagram || '', ICON_IG);
    addIcon(it.tiktok    || '', ICON_TT);
    addIcon(waDigits ? ('https://wa.me/' + waDigits) : '', ICON_WA);
    addIcon(telDigits ? ('tel:' + telDigits) : '', ICON_TEL);

    // Armar tarjeta
    card.appendChild(title);
    if(sub.textContent) card.appendChild(sub);
    if(img.src) card.appendChild(img);
    if(desc.textContent) card.appendChild(desc);

    if(hi.textContent){
      card.appendChild(premiumLabel);
      card.appendChild(hi);
    }
    if(std.textContent){
      card.appendChild(stdLabel);
      card.appendChild(std);
    }

    card.appendChild(actions);

    wrap.appendChild(card);
  }

// --- Bot√≥n "Ocultar" al final (fuera del grid) ---
// (Reemplaza el bloque que crea el bot√≥n "Regresar" inferior)
const oldBottom = document.getElementById('com-volver-bottom');
if (oldBottom && oldBottom.parentElement) {
  oldBottom.parentElement.remove(); // evita duplicados al re-renderizar
}

const bottom = document.createElement('div');
bottom.className = 'com-bottom-actions spaced';

const backBtn = document.createElement('button');
backBtn.id = 'com-volver-bottom';
backBtn.textContent = 'Ocultar';  // nombre actualizado

bottom.appendChild(backBtn);

/* Inserta el contenedor inmediatamente DESPU√âS del grid,
   de modo que no sea parte del layout de columnas */
wrap.insertAdjacentElement('afterend', bottom);

// Listener: solo limpia y se oculta (no navega)
backBtn.addEventListener('click', () => {
  try { playSoundOnce(SOUNDS.back); } catch(_){}
  clearComerciantesUI();        // limpia lista + especificaciones y quita el bot√≥n
  // Opcional: desplaza al inicio de la vista
  try {
    document.getElementById('view-comerciantes')
      ?.scrollIntoView({ behavior:'smooth', block:'start' });
  } catch(_){}
});
}

// Sonido de "Atr√°s" para esta vista
(function(){
  const el = document.getElementById('com-volver');
  if(el) el.addEventListener('click', ()=> playSoundOnce(SOUNDS.back));
})();

// Asegurar detener el video al abrir esta vista
(function(){
  const el = document.getElementById('go-comerciantes');
  if(el){ el.addEventListener('click', ()=> stopVideoPlayback(), { capture:true }); }
})();

    // Sonido para botones Atr√°s/Regresar
    ['btn-ovl-back','a-volver','v-volver','upd-volver','c-volver','s-volver','i-volver','btn-reg-atras','sede-volver','redes-volver','lc-volver','com-volver','ref-volver'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('click', ()=> playSoundOnce(SOUNDS.back));
});

    // Volver gen√©ricos
    ['a-volver','v-volver','upd-volver','c-volver','s-volver','i-volver','sede-volver','redes-volver','lc-volver','com-volver','ref-volver'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('click', ()=> showView('view-menu'));
});

    // + nuevos "Atr√°s"
['feed-volver','fd-volver'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('click', ()=> playSoundOnce(SOUNDS.back));
});

document.addEventListener('DOMContentLoaded', () => {
  const label = document.getElementById('notif-label');
  const goFeedBtn = document.getElementById('go-feed');
  if (!label || !goFeedBtn) return;

  const openFeed = () => { goFeedBtn.click(); };

  // Click con mouse
  label.addEventListener('click', openFeed);

  // Accesibilidad: permitir Enter/Espacio como bot√≥n
  label.setAttribute('role', 'button');
  label.setAttribute('tabindex', '0');
  label.setAttribute('aria-label', 'Abrir notificaciones');
  label.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      openFeed();
    }
  });
});

    /* ==== REFERIDOS (vista l√≠der) ==== */
let REF_DATA = [];

async function prepararReferidos(){
  if(!currentUser) return;
  // Solicita lista al backend
  try{
    const r = await apiGet('listReferidos', { documento: currentUser.documento });
    const leaderName = r?.leaderName || '';
    REF_DATA = Array.isArray(r?.items) ? r.items : [];

    // T√≠tulo
    const tEl = document.getElementById('ref-title');
    if(tEl){
      tEl.textContent = 'REFERIDOS ' + (leaderName || '');
    }

    // Limpia filtro y pinta
    const f = document.getElementById('ref-filter');
    if(f) f.value = '';
    renderReferidos(REF_DATA);
    updateReferidosSummary(REF_DATA);
  }catch(e){
    REF_DATA = [];
    renderReferidos(REF_DATA);
    updateReferidosSummary(REF_DATA);
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
}

function updateReferidosSummary(list){
  const box = document.getElementById('ref-count');
  const cap = document.getElementById('ref-caption');
  if(!box || !cap) return;
  if(!list.length){
    box.style.display='none'; cap.style.display='none'; box.textContent='';
    return;
  }
  box.textContent = String(list.length);
  box.style.display='inline-block';
  cap.style.display='block';
}

function voteClass(v){
  const val = String(v||'').trim().toUpperCase();
  if(val === 'FLANDES') return 'green';
  if(val === 'SIN CONSULTAR') return 'blue';
  if(val === 'A LA ESPERA') return 'gray';
  if(val === 'POR CONFIRMAR') return 'orange';
  return 'red';
}

function renderReferidos(list){
  const wrap = document.getElementById('ref-list');
  if(!wrap) return;
  wrap.innerHTML = '';

  if(!list.length){
    const p = document.createElement('p');
    p.className = 'muted center';
    p.textContent = 'No hay referidos registrados.';
    wrap.appendChild(p);
    return;
  }

  for(const it of list){
    const card = document.createElement('div');
    card.className = 'ref-item';

    // Top row: nombre + votaci√≥n
    const top = document.createElement('div');
    top.className = 'ref-row-top';

    const name = document.createElement('p');
    name.className = 'ref-name';
    name.textContent = it.nombre || '';

    const vote = document.createElement('div');
    vote.className = 'ref-vote ' + voteClass(it.votacion);
    vote.textContent = 'VOTACI√ìN: ' + (it.votacion || '‚Äî');

    top.appendChild(name);
    top.appendChild(vote);

    // Details
    const det = document.createElement('div');
    det.className = 'ref-details';
    const docSpan = document.createElement('span');
    docSpan.innerHTML = '<b>CC:</b> ' + (it.documento || '');
    const resSpan = document.createElement('span');
    resSpan.innerHTML = '<b>RESIDENCIA:</b> ' + (it.residencia || '');
    det.appendChild(docSpan);
    det.appendChild(resSpan);

    // Acciones
    const actions = document.createElement('div');
    actions.className = 'ref-actions';

    const telDigits = String(it.telefono||'').replace(/\D/g,'');
    const waFull = telDigits ? (telDigits.startsWith('57') ? telDigits : ('57'+telDigits.slice(-10))) : '';

    // Bot√≥n WhatsApp (igual que index2)
    if(waFull){
      const aWa = document.createElement('a');
      aWa.className = 'ref-wa';
      aWa.href = 'https://wa.me/' + waFull;
      aWa.target = '_blank';
      aWa.rel = 'noopener';
      aWa.setAttribute('aria-label','Abrir chat de WhatsApp');

      const imgWa = document.createElement('img');
      imgWa.src = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp';
      imgWa.alt = '';
      aWa.appendChild(imgWa);

      actions.appendChild(aWa);
    }

    // Bot√≥n Llamar (igual que index2)
    if (telDigits){
      const aTel = document.createElement('a');
      aTel.className = 'ref-wa';
      aTel.href = 'tel:' + telDigits;
      aTel.setAttribute('aria-label','Llamar al contacto');

      const imgTel = document.createElement('img');
      imgTel.src = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759952569/Llamada_hra2ch.webp';
      imgTel.alt = '';
      aTel.appendChild(imgTel);

      actions.appendChild(aTel);
    }

    card.appendChild(top);
    card.appendChild(det);
    card.appendChild(actions);
    wrap.appendChild(card);
  }
}

// Filtro con debounce
(function(){
  const input = document.getElementById('ref-filter');
  if(!input) return;
  function normalize(s){ return String(s||'').toLowerCase(); }
  function matches(it,q){
    if(!q) return true;
    const qq = q.toLowerCase();
    return normalize(it.nombre).includes(qq) ||
           normalize(it.documento).includes(qq) ||
           normalize(it.residencia).includes(qq) ||
           normalize(it.votacion).includes(qq);
  }
  let t;
  input.addEventListener('input', ()=>{
    clearTimeout(t);
    t = setTimeout(()=>{
      const q = input.value.trim();
      const filtered = REF_DATA.filter(it=>matches(it,q));
      renderReferidos(filtered);
      updateReferidosSummary(filtered);
    }, 160);
  });
})();

// Bot√≥n Regresar (aplica estilos/sonido existentes)
document.getElementById('ref-volver').addEventListener('click', ()=> showView('view-menu'));

  </script>
</body>

</html>
