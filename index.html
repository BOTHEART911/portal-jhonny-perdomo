<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>JHONNY PERDOMO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1759697569/Jhonny_tvexdy.png">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <link rel="manifest" href="manifest.webmanifest">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root{
      --primary:#007BFF;
      --primary-2:#0056b3;
      --ok:#16a34a;
      --error:#dc2626;
      --scrim:rgba(0,0,0,.35);
    }
    html,body{
      margin:0; padding:0; height:100%; width:100%;
      overflow-x:hidden; /* SIN scroll lateral */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1753538930/FONDO_JHONNY_sugwsj.png') center/cover fixed no-repeat;
    }
    .container{ max-width: 1000px; margin: 0 auto; padding: 16px; }

    /* VISTAS con transición */
    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      min-height: 0; /* <--- ELIMINADO min-height extra */
      box-sizing:border-box; padding:16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }

    /* Tarjetas y formularios */
    .card{
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(3px);
      border: 2px solid #ddd; border-radius: 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,.15);
      max-width: 420px; margin: 16px auto; padding: 16px 16px 10px 16px; /* menos padding abajo */
    }
    h1,h2{ margin: 8px 0 12px; text-align:center; }
    p.helper{ color:#666; font-size:.95rem; text-align:center; margin:8px 0 16px; }
    label{ display:block; font-weight:700; margin: 10px 0 6px; color:#007BFF; }
    input, select, textarea, button{
      width:100%; padding:12px; box-sizing:border-box;
      border:1.5px solid #ccc; border-radius:8px; background:#fff;
      outline:none; transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
    button{
      cursor:pointer; border:2px solid var(--primary);
      background:#fff; color:#000; font-weight:700;
    }
    button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-row{ display:flex; gap:12px; }
    .btn-row > *{ flex:1; }
    .muted{ color:#666; font-size:.9rem; }
    .center{ text-align:center; }
    .image-center{ display:flex; justify-content:center; }
    .brand{ width:210px; border-radius:8px; display:block; margin:12px auto 4px; }
    .chip{
      padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
      background:#fff; font-weight:700; color:#000;
    }
    .danger{ background:#e11; border-color:#e11; color:#fff; }

    /* OVERLAY BANNER LATERAL */
    .overlay{ position: fixed; inset: 0; pointer-events:none; }
    .overlay .scrim{ position:absolute; inset:0; background:var(--scrim);
      opacity:0; transition:opacity .25s ease;
    }
    .overlay .panel{
      position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%;
      background:#2f6bdb; color:#fff; padding:16px 16px 8px 16px; box-sizing:border-box;
      transform: translateX(-100%); transition: transform .25s ease;
      display:flex; flex-direction:column; gap:10px; overflow-y:auto;
      min-height: 0;
    }
    .overlay.open{ pointer-events:auto; }
    .overlay.open .scrim{ opacity:1; }
    .overlay.open .panel{ transform: translateX(0); }
    .panel h3{ margin: 4px 0 8px; text-align:center; }
    .menu-btn{
      background:#7de3ef; color:#000; border:0; font-weight:800;
      border-radius:999px; padding:12px; box-shadow: 0 6px 12px rgba(0,0,0,.18);
    }
   
    /* VIDEO */
    .video-card{
      position:relative; width: min(560px, 90vw); aspect-ratio: 16 / 9;
      margin: 12px auto; background:#000; border-radius: 14px; overflow:hidden;
      border:2px solid #ddd; box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .video-card .video-thumb{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; display:block;
    }
    .video-card .play-layer{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at center, rgba(255,255,255,.18), rgba(0,0,0,.55));
      color:#fff; font-size: 64px; cursor:pointer; transition: opacity .2s ease;
    }
    .video-card.playing .play-layer{ opacity:0; pointer-events:none; }
    .video-card.playing .video-thumb{ display:none; }
    .video-card iframe{ width:100%; height:100%; display:block; }

/* Loader centrado (overlay) */
.loader{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.35);
  z-index:9999; backdrop-filter: blur(2px);
  opacity:1; transition: opacity .12s ease; /* antes .2s */
  will-change: opacity;
}
/* Para que el loader haga fade-out pero NO afecte otros .hidden */
.loader.hidden{
  display:flex !important; /* sobreescribe .hidden genérico solo para el loader */
  opacity:0; pointer-events:none;
}

/* Spinner tipo iOS (12 barras) */
.spinner-ios{
  position:relative; width:64px; height:64px;
}
.spinner-ios i{
  position:absolute; left:50%; top:50%;
  width:6px; height:18px; margin:-9px 0 0 -3px;
  background:#fff; border-radius:3px;
  opacity:.2;
  animation:iosFade 1.2s linear infinite;
  /* Cada barra se ubica por rotación y se aleja hacia arriba */
  transform-origin: center center;
}

/* Keyframes de “iluminación” secuencial */
@keyframes iosFade{
  0%, 39%, 100% { opacity:.2; }
  40% { opacity:1; }
}

/* 12 barras, separadas 30° y con retraso escalonado */
.spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
.spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
.spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
.spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
.spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
.spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
.spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
.spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
.spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
.spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
.spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
.spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

.hidden{ display:none !important; }

.narrow{ max-width: 520px; margin: 0 auto; }
.spaced{ margin-top:12px; }

/* INSERT: tarjeta de mapa estático (similar a video-card) */
.map-card{
  width: 100%;              /* que se ajuste al ancho del card */
  max-width: 100%;
  aspect-ratio: 16 / 9;     /* mantiene proporción 16:9 */
  margin: 12px 0;           /* mismo espaciado que otros medios dentro del card */
  border-radius: 14px;
  overflow: hidden;
  border: 2px solid #ddd;
  box-shadow: 0 10px 24px rgba(0,0,0,.25);
  background: #f3f3f3;
}
.map-card img,
.map-card iframe{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border: 0;
}

/* FIX mapa responsivo dentro del card (no se sale en móvil) */
#view-sede .map-embed{
  position: relative;
  width: 100%;              /* ocupa el ancho del card */
  aspect-ratio: 16 / 9;     /* mantiene proporción 16:9 */
  border-radius: 14px;
  overflow: hidden;
  border: 2px solid #ddd;
  box-shadow: 0 10px 24px rgba(0,0,0,.25);
  background:#000;
  margin: 12px 0;           /* igual que otras tarjetas de media */
}
#view-sede .map-embed iframe{
  position:absolute; inset:0;
  width:100%; height:100%; border:0; display:block;
}

/* Si accidentalmente vuelves a usar .video-card para el mapa en esta vista,
   garantizamos que no use 90vw y no se salga del card */
#view-sede .video-card{
  width:100% !important;
  max-width:100%;
  margin:12px 0;
  border-radius:14px; 
  overflow:hidden;
}

@media (max-width: 700px){ .btn-row{ flex-direction:column; } }

    /* Redes sociales: botones con icono, responsivos */
.social-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
  margin:12px 0;
}
.social-btn{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px;
  border-radius:999px; border:2px solid var(--primary);
  background:#fff; color:#000; font-weight:800; text-decoration:none;
  box-shadow: 0 6px 12px rgba(0,0,0,.18);
}
.social-btn:hover{
  background:var(--primary-2); color:#fff; border-color:var(--primary-2);
}
.social-btn img{
  width:26px; height:26px; object-fit:contain; margin-left:10px;
  border-radius:4px; background:#fff;
}
/* En pantallas anchas se pueden ver en 2 columnas */
@media (min-width: 560px){
  .social-grid{ grid-template-columns: 1fr 1fr; }
}

    /* Vista Instalar centrada, sin card */
#view-instalar{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height: calc(100dvh - 32px);
  text-align:center;
}
#view-instalar .install-wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  padding: 8px;
}
#view-instalar .brand{ width:220px; border-radius:8px; }
#view-instalar .tagline{
  font-weight:800;
  color:#111;
  margin: 0 0 4px;
}

    /* Botón con icono */
.btn-with-icon{
  display:flex;               /* mantiene el ancho 100% del botón y centra contenido */
  align-items:center;
  justify-content:center;
  gap:10px;                   /* espacio entre icono y texto */
}
.btn-with-icon img{
  width:22px; height:22px;
  object-fit:contain;
  border-radius:4px;
  background:#fff;            /* se ve bien sobre fondos oscuros */
}

   /* Quitar espacio extra arriba/abajo en todas las vistas (menu, sede, redes, etc.) */
.view{
  padding: 0 16px; /* sin padding vertical; se conserva solo el lateral */
}

/* Evitar márgenes colapsados del primer y último elemento dentro de cada vista */
.view > *:first-child{ margin-top: 0 !important; }
.view > *:last-child{ margin-bottom: 0 !important; }

/* Opcional: si quieres limitarlo sólo a las vistas mencionadas
#view-menu > *:first-child,
#view-sede > *:first-child,
#view-redes > *:first-child{ margin-top: 0 !important; }
#view-menu > *:last-child,
#view-sede > *:last-child,
#view-redes > *:last-child{ margin-bottom: 0 !important; }
*/

/* Panel lateral (menú deslizable): sin espacio “muerto” abajo/arriba */
.overlay .panel{
  padding-top: 16px;
  padding-bottom: 0; /* quita espacio al final */
}
.overlay .panel > *:first-child{ margin-top: 0 !important; }
.overlay .panel > *:last-child{ margin-bottom: 0 !important; }

  /* 1) FIX crítico: la vista "Instalar" no debe ocupar espacio cuando no está activa */
#view-instalar.view { display: none; }            /* Oculta siempre por defecto */
#view-instalar.view.active { display: flex; }     /* Solo flex cuando la vista está activa */

/* 2) Recorte global de bordes: sin espacio arriba/abajo si no hay más contenido */
.container{ padding-bottom: 0; }                  /* Nada de espacio extra al final de la página */
.view{ padding-top: 0; padding-bottom: 0; }       /* Sin padding vertical en cada vista */
.view > *:first-child{ margin-top: 0 !important; }/* Primer bloque sin margen superior */
.view > *:last-child{ margin-bottom: 0 !important; }/* Último bloque sin margen inferior */

/* Opcional: si quieres que Sede y Redes no tengan ni 1px de “aire” arriba */
#view-sede > *:first-child,
#view-redes > *:first-child{ margin-top: 0 !important; }

  /* ==== NOTIFICACIONES (lista en Menú + detalle) ==== */
.notif-card{ max-width:640px; margin: 16px auto; }
#notif-list{ display:flex; flex-direction:column; gap:12px; }

.notif-item{
  display:flex; align-items:center; gap:12px;
  background: rgba(255,255,255,.86);
  border-radius:14px; border:2px solid #cfd7ff;
  padding:10px; position:relative; cursor:pointer;
  box-shadow: 0 8px 14px rgba(0,0,0,.12);
}
.notif-img{
  width:64px; height:64px; flex:0 0 64px; border-radius:10px; object-fit:cover;
  background:#eee; border:1px solid #ddd;
}
.notif-content{ flex:1; min-width:0; }
.notif-title{
  font-weight:800; color:#111;
  display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden;
}
.notif-desc{
  color:#333; font-size:.94rem;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
}
.notif-dot{
  position:absolute; right:10px; top:8px;
  width:12px; height:12px; background:#e11; border-radius:50%;
  box-shadow: 0 0 0 2px #fff;
}
.notif-dot.hidden{ display:none; }

/* Detalle */
#view-notif .cover{
  width:160px; height:160px; object-fit:cover; border-radius:10px; border:2px solid #ddd;
}
#view-notif h2{ text-align:center; }
#view-notif .body{ text-align:justify; white-space:pre-wrap; }
  
</style>
  
</head>
<body>
 <!-- Loader centrado (efecto iOS, sin imagen) -->
<div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
  <div class="spinner-ios" role="status" aria-label="Cargando">
    <i></i><i></i><i></i><i></i><i></i><i></i>
    <i></i><i></i><i></i><i></i><i></i><i></i>
  </div>
</div>

  <div class="container">

    <!-- VISTA 1: LOGIN / REGISTRO -->
    <section id="view-login" class="view active">
      <div class="card">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">JHONNY PERDOMO</h1>
        <p class="helper"><b>Al usar esta aplicación, aceptas voluntariamente suministrar tus datos Personales.</b><br><i>Art. 5 Ley 1581 de 2012 y Decreto 1074 de 2015</i></p>

        <label>Documento:</label>
        <input id="doc-login" type="tel" inputmode="numeric" placeholder="Sin puntos ni espacios" />

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesión</button>
         <button id="btn-compartir" class="btn-with-icon">
  <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="" aria-hidden="true">
  <span>Comparte la App</span>
</button>
        </div>

        <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
        <p class="center muted">Copyright © <a href="https://wa.me/573103230712" target="_blank"><b>Oscar Polanía</b></a></p>
      </div>

      <!-- REGISTRO (solo si no existe) -->
      <div id="registro-card" class="card" style="display:none;">
        <h2 style="color:var(--primary)">INFORMACIÓN PERSONAL</h2>
        <div class="narrow">
          <label>Nombre Completo</label>
          <input id="reg-nombre" type="text" placeholder="Ingresa tu Nombre completo" />

          <label>Whatsapp</label>
          <input id="reg-telefono" type="tel" inputmode="numeric" placeholder="10 dígitos" />

          <label>Barrio, Vereda o Conjunto de Residencia</label>
          <select id="reg-residencia">
            <option value="" disabled selected>Selecciona tu Residencia</option>
            <option value="ACAPULCO I">ACAPULCO I</option>
            <option value="ACAPULCO II">ACAPULCO II</option>
            <option value="AGUAMARINA">AGUAMARINA</option>
            <option value="ALCALA I">ALCALA I</option>
            <option value="ALFONSO LÓPEZ">ALFONSO LÓPEZ</option>
            <option value="ALTAGRACIA I">ALTAGRACIA I</option>
            <option value="ALTAGRACIA II">ALTAGRACIA II</option>
            <option value="ALTAGRACIA IV">ALTAGRACIA IV</option>
            <option value="APROVITEF">APROVITEF</option>
            <option value="ARAGON I">ARAGON I</option>
            <option value="ARAGON II">ARAGON II</option>
            <option value="ARAGON III">ARAGON III</option>
            <option value="ARAGON IV">ARAGON IV</option>
            <option value="ARBOLEDA I">ARBOLEDA I</option>
            <option value="ARBOLEDA II">ARBOLEDA II</option>
            <option value="BALCONES DE ALEJANDRIA">BALCONES DE ALEJANDRIA</option>
            <option value="BILBAO">BILBAO</option>
            <option value="CALA I">CALA I</option>
            <option value="CANALES">CANALES</option>
            <option value="CANCUN">CANCUN</option>
            <option value="CAMALA">CAMALA</option>
            <option value="CASA DEL SOL I">CASA DEL SOL I</option>
            <option value="CASA DEL SOL II">CASA DEL SOL II</option>
            <option value="CENTRO">CENTRO</option>
            <option value="COLEGIO I">COLEGIO I</option>
            <option value="COLEGIO II">COLEGIO II</option>
            <option value="COLEGIO III">COLEGIO III</option>
            <option value="DUBAI">DUBAI</option>
            <option value="EL PORTAL DEL RUBI">EL PORTAL DEL RUBI</option>
            <option value="GAITAN">GAITAN</option>
            <option value="HANGARES">HANGARES</option>
            <option value="INVASION BRISAS DEL CARMEN">INVASION BRISAS DEL CARMEN</option>
            <option value="INVASION VILLA MAGDALENA">INVASION VILLA MAGDALENA</option>
            <option value="INVASION VILLA MARIANA">INVASION VILLA MARIANA</option>
            <option value="IQUEIMA">IQUEIMA</option>
            <option value="JARDINES DE BABILONIA">JARDINES DE BABILONIA</option>
            <option value="LA CAPILLA">LA CAPILLA</option>
            <option value="LA CEIBA">LA CEIBA</option>
            <option value="LA ESPERANZA">LA ESPERANZA</option>
            <option value="LA PAZ">LA PAZ</option>
            <option value="LA UNION">LA UNION</option>
            <option value="LAS ROSAS">LAS ROSAS</option>
            <option value="LAS VILLAS">LAS VILLAS</option>
            <option value="LIBERTADOR">LIBERTADOR</option>
            <option value="LLERAS">LLERAS</option>
            <option value="LOS MANGOS I">LOS MANGOS I</option>
            <option value="LOS MANGOS II">LOS MANGOS II</option>
            <option value="LOS MANGOS III">LOS MANGOS III</option>
            <option value="LOS MANGOS IV">LOS MANGOS IV</option>
            <option value="LOS MANGOS V">LOS MANGOS V</option>
            <option value="LOS MANGOS VI">LOS MANGOS VI</option>
            <option value="LOS MANGOS VII">LOS MANGOS VII</option>
            <option value="LOS PIJAOS">LOS PIJAOS</option>
            <option value="MIRADOR DE LA ESPERANZA">MIRADOR DE LA ESPERANZA</option>
            <option value="MIRADOR DEL SOL">MIRADOR DEL SOL</option>
            <option value="MONACO">MONACO</option>
            <option value="OBRERO">OBRERO</option>
            <option value="OBRERO DELIRIO">OBRERO DELIRIO</option>
            <option value="ORQUÍDEAS I">ORQUÍDEAS I</option>
            <option value="ORQUÍDEAS II">ORQUÍDEAS II</option>
            <option value="ORQUÍDEAS REAL I">ORQUÍDEAS REAL I</option>
            <option value="ORQUÍDEAS REAL II">ORQUÍDEAS REAL II</option>
            <option value="ORQUÍDEAS REAL III">ORQUÍDEAS REAL III</option>
            <option value="ORQUÍDEAS REAL IV">ORQUÍDEAS REAL IV</option>
            <option value="PARADERO I">PARADERO I</option>
            <option value="PARADERO II">PARADERO II</option>
            <option value="PARAISO">PARAISO</option>
            <option value="PAKISTAN I">PAKISTAN I</option>
            <option value="PAKISTAN II">PAKISTAN II</option>
            <option value="PAKISTAN III">PAKISTAN III</option>
            <option value="PALO VERDE">PALO VERDE</option>
            <option value="PARQUES DE ALEJANDRIA I">PARQUES DE ALEJANDRIA I</option>
            <option value="PARQUES DE ALEJANDRIA II">PARQUES DE ALEJANDRIA II</option>
            <option value="PARQUES DE ALEJANDRIA III">PARQUES DE ALEJANDRIA III</option>
            <option value="PARQUES DE ALEJANDRIA IV">PARQUES DE ALEJANDRIA IV</option>
            <option value="PARQUES DE PAKISTAN I">PARQUES DE PAKISTAN I</option>
            <option value="PARQUES DE PAKISTAN II">PARQUES DE PAKISTAN II</option>
            <option value="PARQUES DE PAKISTAN III">PARQUES DE PAKISTAN III</option>
            <option value="PARQUES DE PAKISTAN IV">PARQUES DE PAKISTAN IV</option>
            <option value="PARQUES DE PAKISTAN V">PARQUES DE PAKISTAN V</option>
            <option value="PORTAL DEL RUBY">PORTAL DEL RUBY</option>
            <option value="PRADERAS DE PALMA REAL">PRADERAS DE PALMA REAL</option>
            <option value="PRADOS DE SAN REMO">PRADOS DE SAN REMO</option>
            <option value="PUERTA BLANCA">PUERTA BLANCA</option>
            <option value="PUERTO BAHIA I">PUERTO BAHIA I</option>
            <option value="PUERTO BAHIA II">PUERTO BAHIA II</option>
            <option value="PUERTO DOMINGO">PUERTO DOMINGO</option>
            <option value="PUERTO MEDITERRANEO">PUERTO MEDITERRANEO</option>
            <option value="QUINTAS DE SAN ESTEBAN">QUINTAS DE SAN ESTEBAN</option>
            <option value="QUINTAS DE SAN FRANCISCO">QUINTAS DE SAN FRANCISCO</option>
            <option value="QUINTAS DEL DIVINO NIÑO">QUINTAS DEL DIVINO NIÑO</option>
            <option value="QUINTAS FERROVIARIAS">QUINTAS FERROVIARIAS</option>
            <option value="RIVERAS DEL MAGDALENA">RIVERAS DEL MAGDALENA</option>
            <option value="SAN ANDRES">SAN ANDRES</option>
            <option value="SAN FELIPE DE BARAJAS">SAN FELIPE DE BARAJAS</option>
            <option value="SAN FEMANDO DE SEGOVIA">SAN FEMANDO DE SEGOVIA</option>
            <option value="SAN FRANCISCO">SAN FRANCISCO</option>
            <option value="SAN LUIS">SAN LUIS</option>
            <option value="SANTA ANA">SANTA ANA</option>
            <option value="SANTA HAGIA SOTA">SANTA HAGIA SOTA</option>
            <option value="SANTA MARTHA">SANTA MARTHA</option>
            <option value="SANTA MONICA I">SANTA MONICA I</option>
            <option value="SANTA MONICA II">SANTA MONICA II</option>
            <option value="SINAI">SINAI</option>
            <option value="SOL Y BRISA">SOL Y BRISA</option>
            <option value="TARQUI">TARQUI</option>
            <option value="TAYRONA">TAYRONA</option>
            <option value="TERRAZAS DE ALEJANDRIA">TERRAZAS DE ALEJANDRIA</option>
            <option value="TOPACIO">TOPACIO</option>
            <option value="TRIANA">TRIANA</option>
            <option value="URBANIZACION ARRAYANES">URBANIZACION ARRAYANES</option>
            <option value="URBANIZACION EL PALMAR">URBANIZACION EL PALMAR</option>
            <option value="URBANIZACION EL PORTAL">URBANIZACION EL PORTAL</option>
            <option value="URBANIZACION EL RUBY">URBANIZACION EL RUBY</option>
            <option value="URBANIZACION LOS ALMENDROS">URBANIZACION LOS ALMENDROS</option>
            <option value="URBANIZACION VILLA LUCIA">URBANIZACION VILLA LUCIA</option>
            <option value="URBANIZACION VILLA MAGDALENA I">URBANIZACION VILLA MAGDALENA I</option>
            <option value="URBANIZACION VILLA MAGDALENA II">URBANIZACION VILLA MAGDALENA II</option>
            <option value="URBANIZACION VILLA MAGDALENA III">URBANIZACION VILLA MAGDALENA III</option>
            <option value="URBANIZACION VILLA MARIANA">URBANIZACIÓN VILLA MARIANA</option>
            <option value="VALLESUE">VALLESUE</option>
            <option value="VENECIA I">VENECIA I</option>
            <option value="VENECIA II">VENECIA II</option>
            <option value="VENECIA III">VENECIA III</option>
            <option value="VENECIA IV">VENECIA IV</option>
            <option value="VILLA DE LAS PALMAS">VILLA DE LAS PALMAS</option>
            <option value="VILLA DEL RIO I">VILLA DEL RIO I</option>
            <option value="VILLA DEL RIO II">VILLA DEL RIO II</option>
            <option value="VILLA DEL SOL">VILLA DEL SOL</option>
            <option value="VILLA ESPERANZA">VILLA ESPERANZA</option>
            <option value="VILLA LAS PALMAS">VILLA LAS PALMAS</option>
            <option value="VILLA MEDINA">VILLA MEDINA</option>
            <option value="VILLAS DEL MEDITERANEO">VILLAS DEL MEDITERANEO</option>
          </select>

          <!-- Campo Referido ocultable -->
          <div id="reg-referido-wrap" style="display:none;">
            <label>N° Referido</label>
            <input id="reg-referencia" type="tel" inputmode="numeric" placeholder="N° de Referido (opcional)" />
          </div>
          <div class="btn-row">
            <button id="btn-ref-mas">Si eres Referido</button>
            <button id="btn-ref-menos" class="hidden">No soy Referido</button>
          </div>

          <div class="btn-row spaced">
            <button class="spaced btn-primary" id="btn-guardar-registro">Guardar</button>
            <button id="btn-reg-atras">Atrás</button>
          </div>
          <p class="center muted spaced"><b>Revisa la información antes de guardar.</b></p>
        </div>
      </div>
    </section>

    <!-- VISTA 2: MENÚ -->
    <section id="view-menu" class="view">
      <div class="btn-row" style="margin-bottom:12px;">
        <button class="chip" id="btn-open-menu">MENÚ</button>
        <button class="chip danger" id="btn-logout">Cerrar Sesión</button>
      </div>

      <!-- NOTIFICACIONES: lista en Menú -->
<div class="card notif-card">
  <h2 style="color:var(--primary);">¡PONTE AL DÍA!</h2>
  <div id="notif-list"></div>
</div>

      <div class="card">
        <div class="image-center">
          <img alt="usuario" src="https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png" width="64" height="64" />
        </div>
        <h2 id="u-nombre">Nombre</h2>
        <div class="narrow">
          <p><b>C.C.:</b> <span id="u-doc"></span></p>
          <p><b>Cel:</b> <span id="u-cel"></span></p>
          <p><b>Residencia:</b> <span id="u-res"></span></p>
          <p><b>Referencia:</b> <span id="u-ref"></span></p>
          <p><b>Municipio:</b> <span id="u-mpio"></span></p>
          <p><b>Puesto:</b> <span id="u-puesto"></span></p>
          <p><b>Mesa:</b> <span id="u-mesa"></span></p>
        </div>
      </div>

      <!-- Video de Drive -->
      <div class="video-card" id="videoCard">
        <img id="videoThumb" class="video-thumb" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753562431/ASISTENCIA_JHONNY_co6qwy.png" alt="Video miniatura">
        <div class="play-layer" id="playLayer">▶</div>
      </div>

      <div class="image-center">
        <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
      </div>
      <p class="center muted">Copyright © <a href="#" target="https://wa.me/573103230712"><b>Oscar Polanía</b></a></p>
    </section>

    <!-- OVERLAY BANNER -->
<div class="overlay" id="overlay">
  <div class="scrim" id="ovlClose"></div>
  <aside class="panel">
    <div class="btn-row">
      <button id="btn-ovl-back">ATRÁS</button>
    </div>
    <div class="image-center">
      <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759696513/Jhonny_y1tslf.gif" style="max-width:180px;border-radius:10px;" />
    </div>
    <h3>Selecciona una de las opciones</h3>
    <button class="menu-btn" id="go-asistencia">Registra Asistencia a Evento ✋🏾</button>
    <button class="menu-btn" id="go-solicitud">Realiza tu Solicitud 📬</button>
    <button class="menu-btn" id="go-ideas">Suma tus Ideas 💡</button>
    <button class="menu-btn" id="go-actualizacion">Actualiza tus Datos Personales 🔁</button>
    <button class="menu-btn" id="go-consultar">Consulta tu Puesto de Votación 🗳</button>
    <button class="menu-btn" id="go-lider">Si eres Líder, Refiere con un solo Clic 📤</button>
    <button class="menu-btn" id="go-sede">Visita Nuestra Casa Social 📍</button>
    <button class="menu-btn" id="go-redes">Conoce Nuestras Redes Sociales 🌐</button>
    <button class="menu-btn" id="btn-instalar" style="display:none;">Instalar la App 📲</button>
    <div style="height:24px"></div>
    <img class="brand" alt="Brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" />
    <p class="center muted">Copyright © <a href="#" target="https://wa.me/573103230712"><b>Oscar Polanía</b></a></p>
  </aside>
</div>

    <!-- VISTA 3: ASISTENCIA -->
    <section id="view-asistencia" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">REGISTRA ASISTENCIA</h2>
        <input id="a-documento" type="hidden" />
        <input id="a-nombre" type="hidden" />
        <input id="a-telefono" type="hidden" />

        <p class="center muted spaced"><b>Escribe el N° de Evento y espera unos segundos</b></p>

        <label>N° de Evento</label>
        <input id="a-reunion" type="tel" inputmode="numeric" placeholder="N° de Evento" />
        <div id="evento-wrap" style="display:none;">
          <label>Nombre de Evento</label>
          <input id="a-evento" type="text" readonly>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="a-guardar">Guardar</button>
          <button id="a-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA 4: VOTACIÓN -->
    <section id="view-votacion" class="view">
      <div class="card narrow">
        <h2 style="color:#0a0">CONSULTA TU LUGAR DE VOTACIÓN</h2>
        <p class="helper">
          1) Abre la página oficial y consulta tu puesto.<br>
          2) Copia la fila de resultados de la tabla.<br>
          3) Pégala abajo: se completa automático.<br>
        </p>
        <div class="image-center">
          <a class="chip" href="https://wsp.registraduria.gov.co/censo/consultar/" target="_blank">Ir a la página oficial</a>
        </div>
        <label>Pega aquí la fila copiada de la tabla</label>
        <textarea id="v-row" rows="6" placeholder="Pega aquí..."></textarea>

        <label>NUIP</label><input id="v-nuip" readonly>
        <label>Departamento</label><input id="v-departamento" readonly>
        <label>Municipio</label><input id="v-municipio" readonly>
        <label>Puesto</label><input id="v-puesto" readonly>
        <label>Dirección</label><input id="v-direccion" readonly>
        <label>Mesa</label><input id="v-mesa" readonly>

        <p class="center muted spaced"><b>Si no Guardaras estos campos, haz clic en el botón "Atrás"</b></p>

        <div class="btn-row spaced">
          <button class="btn-primary" id="v-guardar">Guardar</button>
          <button id="v-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA 5: ACTUALIZACIÓN -->
    <section id="view-actualizacion" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">ACTUALIZA TUS DATOS</h2>
        <input id="upd-documento" type="hidden" />
        <label>Nombre</label>
        <input id="upd-nombre" type="text" readonly>

        <p class="center muted spaced"><b>Solo edita los campos que actualizarás</b></p>
        
        <label>Whatsapp</label>
        <input id="upd-telefono" type="tel" inputmode="numeric" placeholder="10 dígitos" />
        <label>Residencia</label>
        <select id="upd-residencia">
          <option value="" disabled selected>Selecciona tu Residencia</option>
          <!-- mismas opciones que en registro -->
          <option value="ACAPULCO I">ACAPULCO I</option>
          <option value="ACAPULCO II">ACAPULCO II</option>
          <option value="AGUAMARINA">AGUAMARINA</option>
          <option value="ALCALA I">ALCALA I</option>
          <option value="ALFONSO LÓPEZ">ALFONSO LÓPEZ</option>
          <option value="ALTAGRACIA I">ALTAGRACIA I</option>
          <option value="ALTAGRACIA II">ALTAGRACIA II</option>
          <option value="ALTAGRACIA IV">ALTAGRACIA IV</option>
          <option value="APROVITEF">APROVITEF</option>
          <option value="ARAGON I">ARAGON I</option>
          <option value="ARAGON II">ARAGON II</option>
          <option value="ARAGON III">ARAGON III</option>
          <option value="ARAGON IV">ARAGON IV</option>
          <option value="ARBOLEDA I">ARBOLEDA I</option>
          <option value="ARBOLEDA II">ARBOLEDA II</option>
          <option value="BALCONES DE ALEJANDRIA">BALCONES DE ALEJANDRIA</option>
          <option value="BILBAO">BILBAO</option>
          <option value="CALA I">CALA I</option>
          <option value="CANALES">CANALES</option>
          <option value="CANCUN">CANCUN</option>
          <option value="CAMALA">CAMALA</option>
          <option value="CASA DEL SOL I">CASA DEL SOL I</option>
          <option value="CASA DEL SOL II">CASA DEL SOL II</option>
          <option value="CENTRO">CENTRO</option>
          <option value="COLEGIO I">COLEGIO I</option>
          <option value="COLEGIO II">COLEGIO II</option>
          <option value="COLEGIO III">COLEGIO III</option>
          <option value="DUBAI">DUBAI</option>
          <option value="EL PORTAL DEL RUBI">EL PORTAL DEL RUBI</option>
          <option value="GAITAN">GAITAN</option>
          <option value="HANGARES">HANGARES</option>
          <option value="INVASION BRISAS DEL CARMEN">INVASION BRISAS DEL CARMEN</option>
          <option value="INVASION VILLA MAGDALENA">INVASION VILLA MAGDALENA</option>
          <option value="INVASION VILLA MARIANA">INVASION VILLA MARIANA</option>
          <option value="IQUEIMA">IQUEIMA</option>
          <option value="JARDINES DE BABILONIA">JARDINES DE BABILONIA</option>
          <option value="LA CAPILLA">LA CAPILLA</option>
          <option value="LA CEIBA">LA CEIBA</option>
          <option value="LA ESPERANZA">LA ESPERANZA</option>
          <option value="LA PAZ">LA PAZ</option>
          <option value="LA UNION">LA UNION</option>
          <option value="LAS ROSAS">LAS ROSAS</option>
          <option value="LAS VILLAS">LAS VILLAS</option>
          <option value="LIBERTADOR">LIBERTADOR</option>
          <option value="LLERAS">LLERAS</option>
          <option value="LOS MANGOS I">LOS MANGOS I</option>
          <option value="LOS MANGOS II">LOS MANGOS II</option>
          <option value="LOS MANGOS III">LOS MANGOS III</option>
          <option value="LOS MANGOS IV">LOS MANGOS IV</option>
          <option value="LOS MANGOS V">LOS MANGOS V</option>
          <option value="LOS MANGOS VI">LOS MANGOS VI</option>
          <option value="LOS MANGOS VII">LOS MANGOS VII</option>
          <option value="LOS PIJAOS">LOS PIJAOS</option>
          <option value="MIRADOR DE LA ESPERANZA">MIRADOR DE LA ESPERANZA</option>
          <option value="MIRADOR DEL SOL">MIRADOR DEL SOL</option>
          <option value="MONACO">MONACO</option>
          <option value="OBRERO">OBRERO</option>
          <option value="OBRERO DELIRIO">OBRERO DELIRIO</option>
          <option value="ORQUÍDEAS I">ORQUÍDEAS I</option>
          <option value="ORQUÍDEAS II">ORQUÍDEAS II</option>
          <option value="ORQUÍDEAS REAL I">ORQUÍDEAS REAL I</option>
          <option value="ORQUÍDEAS REAL II">ORQUÍDEAS REAL II</option>
          <option value="ORQUÍDEAS REAL III">ORQUÍDEAS REAL III</option>
          <option value="ORQUÍDEAS REAL IV">ORQUÍDEAS REAL IV</option>
          <option value="PARADERO I">PARADERO I</option>
          <option value="PARADERO II">PARADERO II</option>
          <option value="PARAISO">PARAISO</option>
          <option value="PAKISTAN I">PAKISTAN I</option>
          <option value="PAKISTAN II">PAKISTAN II</option>
          <option value="PAKISTAN III">PAKISTAN III</option>
          <option value="PALO VERDE">PALO VERDE</option>
          <option value="PARQUES DE ALEJANDRIA I">PARQUES DE ALEJANDRIA I</option>
          <option value="PARQUES DE ALEJANDRIA II">PARQUES DE ALEJANDRIA II</option>
          <option value="PARQUES DE ALEJANDRIA III">PARQUES DE ALEJANDRIA III</option>
          <option value="PARQUES DE ALEJANDRIA IV">PARQUES DE ALEJANDRIA IV</option>
          <option value="PARQUES DE PAKISTAN I">PARQUES DE PAKISTAN I</option>
          <option value="PARQUES DE PAKISTAN II">PARQUES DE PAKISTAN II</option>
          <option value="PARQUES DE PAKISTAN III">PARQUES DE PAKISTAN III</option>
          <option value="PARQUES DE PAKISTAN IV">PARQUES DE PAKISTAN IV</option>
          <option value="PARQUES DE PAKISTAN V">PARQUES DE PAKISTAN V</option>
          <option value="PORTAL DEL RUBY">PORTAL DEL RUBY</option>
          <option value="PRADERAS DE PALMA REAL">PRADERAS DE PALMA REAL</option>
          <option value="PRADOS DE SAN REMO">PRADOS DE SAN REMO</option>
          <option value="PUERTA BLANCA">PUERTA BLANCA</option>
          <option value="PUERTO BAHIA I">PUERTO BAHIA I</option>
          <option value="PUERTO BAHIA II">PUERTO BAHIA II</option>
          <option value="PUERTO DOMINGO">PUERTO DOMINGO</option>
          <option value="PUERTO MEDITERRANEO">PUERTO MEDITERRANEO</option>
          <option value="QUINTAS DE SAN ESTEBAN">QUINTAS DE SAN ESTEBAN</option>
          <option value="QUINTAS DE SAN FRANCISCO">QUINTAS DE SAN FRANCISCO</option>
          <option value="QUINTAS DEL DIVINO NIÑO">QUINTAS DEL DIVINO NIÑO</option>
          <option value="QUINTAS FERROVIARIAS">QUINTAS FERROVIARIAS</option>
          <option value="RIVERAS DEL MAGDALENA">RIVERAS DEL MAGDALENA</option>
          <option value="SAN ANDRES">SAN ANDRES</option>
          <option value="SAN FELIPE DE BARAJAS">SAN FELIPE DE BARAJAS</option>
          <option value="SAN FEMANDO DE SEGOVIA">SAN FEMANDO DE SEGOVIA</option>
          <option value="SAN FRANCISCO">SAN FRANCISCO</option>
          <option value="SAN LUIS">SAN LUIS</option>
          <option value="SANTA ANA">SANTA ANA</option>
          <option value="SANTA HAGIA SOTA">SANTA HAGIA SOTA</option>
          <option value="SANTA MARTHA">SANTA MARTHA</option>
          <option value="SANTA MONICA I">SANTA MONICA I</option>
          <option value="SANTA MONICA II">SANTA MONICA II</option>
          <option value="SINAI">SINAI</option>
          <option value="SOL Y BRISA">SOL Y BRISA</option>
          <option value="TARQUI">TARQUI</option>
          <option value="TAYRONA">TAYRONA</option>
          <option value="TERRAZAS DE ALEJANDRIA">TERRAZAS DE ALEJANDRIA</option>
          <option value="TOPACIO">TOPACIO</option>
          <option value="TRIANA">TRIANA</option>
          <option value="URBANIZACION ARRAYANES">URBANIZACION ARRAYANES</option>
          <option value="URBANIZACION EL PALMAR">URBANIZACION EL PALMAR</option>
          <option value="URBANIZACION EL PORTAL">URBANIZACION EL PORTAL</option>
          <option value="URBANIZACION EL RUBY">URBANIZACION EL RUBY</option>
          <option value="URBANIZACION LOS ALMENDROS">URBANIZACION LOS ALMENDROS</option>
          <option value="URBANIZACION VILLA LUCIA">URBANIZACION VILLA LUCIA</option>
          <option value="URBANIZACION VILLA MAGDALENA I">URBANIZACION VILLA MAGDALENA I</option>
          <option value="URBANIZACION VILLA MAGDALENA II">URBANIZACION VILLA MAGDALENA II</option>
          <option value="URBANIZACION VILLA MAGDALENA III">URBANIZACION VILLA MAGDALENA III</option>
          <option value="URBANIZACION VILLA MARIANA">URBANIZACIÓN VILLA MARIANA</option>
          <option value="VALLESUE">VALLESUE</option>
          <option value="VENECIA I">VENECIA I</option>
          <option value="VENECIA II">VENECIA II</option>
          <option value="VENECIA III">VENECIA III</option>
          <option value="VENECIA IV">VENECIA IV</option>
          <option value="VILLA DE LAS PALMAS">VILLA DE LAS PALMAS</option>
          <option value="VILLA DEL RIO I">VILLA DEL RIO I</option>
          <option value="VILLA DEL RIO II">VILLA DEL RIO II</option>
          <option value="VILLA DEL SOL">VILLA DEL SOL</option>
          <option value="VILLA ESPERANZA">VILLA ESPERANZA</option>
          <option value="VILLA LAS PALMAS">VILLA LAS PALMAS</option>
          <option value="VILLA MEDINA">VILLA MEDINA</option>
          <option value="VILLAS DEL MEDITERANEO">VILLAS DEL MEDITERANEO</option>
        </select>

        <!-- Referido (ocultable) -->
        <div id="upd-referido-wrap" style="display:none;">
          <label>Ingresa o Actualiza el N° Referido</label>
          <input id="upd-referencia" type="tel" inputmode="numeric" placeholder="N° de Referido (opcional)">
        </div>
        <div class="btn-row">
          <button id="upd-ref-mas">Agregar/Editar N° de Referido</button>
          <button id="upd-ref-menos" class="hidden">No editar Referido</button>
        </div>

        <p class="center muted spaced"><b>Revisa muy bien la información antes de Guardar</b></p>

        <div class="btn-row spaced">
          <button class="btn-primary" id="upd-guardar">Guardar</button>
          <button id="upd-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA 6: CONSULTAR -->
    <section id="view-consultar" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">CONSULTA TU PUESTO DE VOTACIÓN</h2>
        <label>Documento</label>
        <input id="c-documento" type="tel" inputmode="numeric" placeholder="Pega o escribe tu Documento" />
        <div class="btn-row spaced">
          <button class="btn-primary" id="c-validar">Validar Documento</button>
          <button id="c-volver">Regresar</button>
        </div>
        <div id="c-result" class="spaced" style="display:none;">
          <p><b>Departamento:</b> <span id="c-dep"></span></p>
          <p><b>Municipio:</b> <span id="c-mun"></span></p>
          <p><b>Puesto:</b> <span id="c-pue"></span></p>
          <p><b>Dirección:</b> <span id="c-dir"></span></p>
          <p><b>Mesa:</b> <span id="c-mesa"></span></p>
        </div>
      </div>
    </section>

    <!-- VISTA 7: SOLICITUD -->
    <section id="view-solicitud" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">REALIZA TU SOLICITUD</h2>
        <p class="center muted spaced"><b>Recibirás respuesta o asesoramiento vía telefónica</b></p>
        <input id="s-documento" type="hidden" />
        <input id="s-telefono" type="hidden" />
        <input id="s-residencia" type="hidden" />

        <label>Nombre</label>
        <input id="s-nombre" type="text" readonly placeholder="Tu Nombre" />

        <label>Servicio</label>
        <select id="s-servicio">
          <option value="" disabled selected>Selecciona el servicio que necesitas</option>
          <option value="Asesoría Jurídica">Asesoría Jurídica</option>
          <option value="Asesoría Contable">Asesoría Contable</option>
          <option value="Asesoría Ambiental o Forestal">Asesoría Ambiental o Forestal</option>
          <option value="Orientación en Salud">Orientación en Salud</option>
          <option value="Orientación Psicológica">Orientación Psicológica</option>
        </select>

        <label>Solicitud</label>
        <textarea id="s-solicitud" rows="5" placeholder="Describe ampliamente tu solicitud"></textarea>

        <p class="center muted spaced"><b>Revisa muy bien la información antes de Guardar</b></p>

        <div class="btn-row spaced">
          <button class="btn-primary" id="s-guardar">Guardar</button>
          <button id="s-volver">Atrás</button>
        </div>
      </div>
    </section>

    <!-- VISTA 8: IDEAS -->
    <section id="view-ideas" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">SUMA TUS IDEAS</h2>
        <input id="i-documento" type="hidden" />
        <input id="i-telefono" type="hidden" />
        <input id="i-residencia" type="hidden" />

        <label>Nombre</label>
        <input id="i-nombre" type="text" readonly placeholder="Tu Nombre" />

        <p class="helper" style="margin-top:16px;">
          <b>Escribe las acciones o proyectos que te gustaría proponer para tu sector, barrio, calle, cuadra, vereda, conjunto o en general para el municipio.<br><br>Tus propuestas e ideas son importantes para que juntos recuperemos la identidad de nuestro hermoso municipio de Flandes.</b>
        </p>

        <label>Aspecto Social</label>
        <p class="muted">Salud, educación, vivienda, cultura, deporte y recreación, agua potable y saneamiento básico, y promoción social (atención a grupos vulnerables)</p>
        <textarea id="i-social" rows="4" placeholder="Redacta tus ideas para Aspecto Social"></textarea>

        <label>Aspecto Institucional</label>
        <p class="muted">Seguridad y justicia, desarrollo comunitario, fortalecimiento institucional, equipamiento público y centros de reclusión.</p>
        <textarea id="i-institucional" rows="4" placeholder="Redacta tus ideas para Aspecto Institucional"></textarea>

        <label>Aspecto Económico</label>
        <p class="muted">Promoción del desarrollo, empleo, turismo, emprendimiento, agropecuario, transporte, servicios públicos diferentes a acueducto, alcantarillado y aseo.</p>
        <textarea id="i-economico" rows="4" placeholder="Redacta tus ideas para Aspecto Económico"></textarea>

        <label>Aspecto Ambiental</label>
        <p class="muted">Ambiental, prevención y atención de desastres, gestión del riesgo, protección animal.</p>
        <textarea id="i-ambiental" rows="4" placeholder="Redacta tus ideas para Aspecto Ambiental"></textarea>

        <label>Otros</label>
        <textarea id="i-otros" rows="4" placeholder="Redacta tus ideas para Otros Aspectos"></textarea>

        <p class="center muted spaced"><b>Revisa muy bien la información antes de Guardar</b></p>

        <div class="btn-row spaced">
          <button class="btn-primary" id="i-guardar">Guardar</button>
          <button id="i-volver">Atrás</button>
        </div>
      </div>
    </section>

    <!-- VISTA: INSTALAR APP (solo con el enlace #instalar) -->
<section id="view-instalar" class="view">
  <div class="install-wrap">
    <h2 style="color:var(--primary); text-shadow: 0 2px 2px #031732; margin: 0 0 8px;">JHONNY PERDOMO</h2>
    <img class="brand" alt="App" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759696513/Jhonny_y1tslf.gif" />
    <p class="tagline">#SoyDeFlandes</p>
    <p class="tagline">#NoParamos</p>
    <p class="tagline">#SiemprePresentes</p>
    <div class="btn-row spaced" style="max-width:420px; width:100%; justify-content:center;">
      <button class="btn-primary" id="btn-instalar-standalone">Instalar la App 📲</button>
    </div>
  </div>
</section>

    <!-- VISTA 9: CASA SOCIAL -->
<section id="view-sede" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">Casa Social Soy de Flandes</h2>

    <!-- Mapa responsivo e interactivo en móvil -->
    <div class="map-embed" style="overscroll-behavior: contain;">
      <iframe
        src="https://www.google.com/maps?q=4.289037,-74.814221&z=16&hl=es&output=embed&gestureHandling=greedy"
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
        allowfullscreen
        title="Ubicación Casa Social Soy de Flandes"
        style="width:100%; height:100%; border:0; touch-action: pan-x pan-y; -ms-touch-action: pan-x pan-y;"
      ></iframe>
    </div>

    <!-- Botones -->
    <div class="btn-row spaced">
      <button class="btn-primary" id="btn-como-llegar">Iniciar Recorrido</button>
      <button id="sede-volver">Atrás</button>
    </div>

    <div class="narrow">
      <p class="helper" style="text-align:left;">
        Aquí te escuchamos, te acompañamos y ponemos a tu alcance cursos y servicios totalmente gratuitos.
      </p>
      <ul style="line-height:1.6; padding-left:18px;">
        <li><b>Martes:</b> asesorías jurídicas para las JAC</li>
        <li><b>Miércoles:</b> asesorías en salud y trámites EPS</li>
        <li><b>Jueves:</b> asesorías contables📈 y curso de guitarra 🎸</li>
        <li><b>Viernes:</b> asesorías jurídicas y realización de derechos de petición y acciones de tutelas⚖. Y en la noche, aeróbicos para toda la familia 🏃‍♀</li>
        <li><b>Sábados:</b> un espacio de escucha y amistad👥</li>
        <li><b>Red de apoyo con entrega gratuita de medicamentos 💊</b></li>
      </ul>
      <p style="margin-top:10px;">
        Ven y visítanos <b>diagonal al Parque La Victoria📍</b>. Estamos para ti, trabajando de la mano con todos los flamencos. 🤝
      </p>
      <p class="muted" style="margin-top:8px;">
        #SoyDeFlandes #CasaSocial #NoParamos #SiemprePresentes
      </p>
    </div>
  </div>

  
  <!-- Forzar abrir Google Maps app con fallback a web -->
  <script>
    (function(){
      const btn = document.getElementById('btn-como-llegar');
      if (!btn) return;

      const LAT = 4.289037, LNG = -74.814221;

      btn.addEventListener('click', () => {
        const ua = navigator.userAgent || '';
        const isAndroid = /android/i.test(ua);
        const isIOS = /(iphone|ipad|ipod)/i.test(ua);

        // Fallback web universal (indicando destino y modo)
        const webUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + LAT + ',' + LNG + '&travelmode=driving';

        if (isAndroid){
          // Intent para abrir app de Google Maps
          const intentUrl = 'intent://maps.google.com/maps?daddr=' + LAT + ',' + LNG + '&directionsmode=driving#Intent;scheme=https;package=com.google.android.apps.maps;end';
          let fallbackTimer = setTimeout(()=> window.open(webUrl, '_blank'), 700);
          try{
            window.location.href = intentUrl;
          }catch(_){
            clearTimeout(fallbackTimer);
            window.open(webUrl, '_blank');
          }
          return;
        }

        if (isIOS){
          // Esquema de Google Maps (si la app está instalada)
          const appUrl = 'comgooglemaps://?daddr=' + LAT + ',' + LNG + '&directionsmode=driving';
          let fallbackTimer = setTimeout(()=> window.open(webUrl, '_blank'), 700);
          window.location.href = appUrl;
          return;
        }

        // Desktop u otros
        window.open(webUrl, '_blank');
      });
    })();
  </script>
    </section>

    
<script>
 /* PWA: instalar + detección de instalada (Android/PC prompt; iOS instrucciones).
   Botones soportados: #btn-instalar (menú) y #btn-instalar-standalone (vista instalar). */
let deferredPrompt = null;
const installButtons = Array.from(document.querySelectorAll('#btn-instalar, #btn-instalar-standalone'));

function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  const dmInstalled = window.matchMedia('(display-mode: installed)').matches;
  return dmStandalone || iosStandalone || dmInstalled;
}
function isIOS(){
  return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
}
function isMarkedInstalled(){
  try{ return localStorage.getItem('appInstalled') === '1'; }catch(_){ return false; }
}
function markInstalled(){
  try{ localStorage.setItem('appInstalled', '1'); }catch(_){}
}
function clearInstalledMark(){
  try{ localStorage.removeItem('appInstalled'); }catch(_){}
}

// Detección robusta con prioridad a getInstalledRelatedApps.
// Si detecta que YA NO está instalada, limpia el flag local.
async function detectInstalled(){
  if (isStandalone()) return true;

  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a =>
        a.platform === 'webapp' &&
        typeof a.url === 'string' &&
        /portal-jhonny-perdomo\/manifest\.webmanifest$/.test(a.url)
      );
      if (found){
        markInstalled();
        return true;
      } else {
        clearInstalledMark(); // importante para el caso de desinstalar
      }
    }catch(_){}
  }

  // Fallback: si el navegador no soporta la API, usa el flag local
  return isMarkedInstalled();
}

function updateInstallButtonsVisibility(){
  const installedFlag = isMarkedInstalled();
  const shouldShow = !isStandalone() && !installedFlag && (isIOS() || !!deferredPrompt);
  installButtons.forEach(btn => { if (btn) btn.style.display = shouldShow ? '' : 'none'; });
}

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  updateInstallButtonsVisibility();
});

window.addEventListener('appinstalled', ()=>{
  markInstalled();
  updateInstallButtonsVisibility();
});

installButtons.forEach(btn=>{
  if (!btn) return;
  btn.addEventListener('click', async ()=>{
    if (isIOS()){
      return Swal.fire({
        icon:'info',
        title:'Instalar en iPhone/iPad',
        html:'1) Toca Compartir (cuadro con flecha).<br>2) Elige "Agregar a pantalla de inicio".<br>3) Confirma "Agregar".'
      });
    }
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    deferredPrompt = null;
    if (choice.outcome === 'accepted'){
      markInstalled();
      Swal.fire({ icon:'success', title:'¡App instalándose!', timer:2000, showConfirmButton:false });
    }
    updateInstallButtonsVisibility();
  });
});

if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

updateInstallButtonsVisibility();

/* #instalar: lógica
   - Mostrar SIEMPRE la vista "Instalar App" primero
   - Si está instalada, tras ~2s ir a login
   - Si no, permanecer en la vista e iluminar botón si aplica */
(function(){
  let installRedirectTimer = null;

  async function openOrInstall(){
    if (location.hash !== '#instalar') return;

    try{ overlay.classList.remove('open'); }catch(_){}
    showView('view-instalar');

    const installed = await detectInstalled();

    if (installRedirectTimer){
      clearTimeout(installRedirectTimer);
      installRedirectTimer = null;
    }

    if (installed){
      installRedirectTimer = setTimeout(()=>{
        showView('view-login');
      }, 2000);
    } else {
      updateInstallButtonsVisibility();
    }
  }

  window.addEventListener('load', openOrInstall);
  window.addEventListener('hashchange', openOrInstall);
})();
    
  </script>


     <!-- VISTA 10: REDES SOCIALES -->
<section id="view-redes" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">Síguenos</h2>
    <p class="helper"><b>Conoce el trabajo que venimos desarrollando todos los días</b><br><br>#SoyDeFlandes #CasaSocial #NoParamos #SiemprePresentes</p>

    <div class="social-grid">
      <a class="social-btn" href="https://www.facebook.com/share/1CD6ubtcRA/" target="_blank" rel="noopener">
        Facebook
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/facebook_nezbkz.webp" alt="Facebook">
      </a>
      <a class="social-btn" href="https://www.instagram.com/jhonnyperdomor?igsh=MTN5eHZucTd5OGNtbw==" target="_blank" rel="noopener">
        Instagram
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/instragram_uft2wl.webp" alt="Instagram">
      </a>
      <a class="social-btn" href="https://vt.tiktok.com/ZSD7FBBNG/" target="_blank" rel="noopener">
        TikTok
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/tiktok_tdvc2x.webp" alt="TikTok">
      </a>
      <a class="social-btn" href="https://whatsapp.com/channel/0029VbBEYJ83LdQbOODLO10S" target="_blank" rel="noopener">
        WhatsApp Canal
        <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="WhatsApp">
      </a>
    </div>

    <div class="btn-row spaced">
      <button id="redes-volver">Atrás</button>
    </div>
  </div>
</section>

    
    <!-- VISTA 11: DETALLE DE NOTIFICACIÓN -->
<section id="view-notif" class="view">
  <div class="card narrow">
    <div class="image-center"><img id="nd-image" class="cover" alt=""></div>
    <h2 id="nd-title"></h2>
    <p id="nd-desc" class="body"></p>
    <div class="btn-row spaced">
      <a id="nd-link" class="btn-primary" href="#" target="_blank" rel="noopener">Visita la Noticia</a>
      <button id="nd-back">Regresar</button>
    </div>
  </div>
</section>

  <script>
    // URL de tu Apps Script desplegado
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzYEzUpAoXZKgkCut4HI2CgcHiwkgldjx23RXucAGx-BlTKXreJO_ZQ2MCyr8aqnOl0/exec';

   // Loader centrado (smart delay)
const loader = document.getElementById('loader');
let loadingCount = 0;
let loaderTimer = null;

function startLoading(){
  loadingCount++;
  if (loadingCount === 1){
    // Mostrar solo si la operación tarda más de 120ms (evita parpadeo)
    loaderTimer = setTimeout(()=>{
      loader.classList.remove('hidden');
      loaderTimer = null;
    }, 120);
  }
}

function stopLoading(){
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    // Si nunca alcanzó a mostrarse, cancela el timer
    if (loaderTimer){
      clearTimeout(loaderTimer);
      loaderTimer = null;
    }
    // Oculta de inmediato (fade corto definido en CSS)
    loader.classList.add('hidden');
  }
}

    // Sonidos
    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      resumen: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Charging_clkgcd.mp3',
      login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
      logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
      menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3',
      back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
    };
    function playSoundOnce(url){
      try{
        const a = new Audio(url);
        a.preload = 'auto';
        a.play().catch(()=>{});
      }catch(e){}
    }
    // Patch de SweetAlert2 para sonar según icono o etiqueta de resumen
    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          if (options.soundTag === 'resumen'){
            playSoundOnce(SOUNDS.resumen);
          } else {
            const icon = options.icon || options.type;
            if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
          }
        }catch(e){}
        return __fire(options, ...rest);
      }
    }

    // Fetch helpers
    async function apiGet(action, params = {}){
      startLoading();
      try{
        const url = new URL(API_BASE);
        url.search = new URLSearchParams({ action, ...params }).toString();
        const r = await fetch(url.toString(), { method: 'GET' });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }
    async function apiPost(action, body = {}){
      startLoading();
      try{
        const url = API_BASE + '?action=' + encodeURIComponent(action);
        const r = await fetch(url, {
          method:'POST',
          headers: { 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(body)
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }

    // Estado
    let currentUser = null;

    // Helpers de vistas
    function showView(id){
      for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
      document.getElementById(id).classList.add('active');
      overlay.classList.remove('open');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function renderUserMenu(){
      document.getElementById('u-nombre').textContent = currentUser?.nombre || '';
      document.getElementById('u-doc').textContent = currentUser?.documento || '';
      document.getElementById('u-cel').textContent = currentUser?.telefono || 'SIN REGISTRO';
      document.getElementById('u-res').textContent = currentUser?.residencia || 'SIN REGISTRO';
      document.getElementById('u-ref').textContent = currentUser?.referencia || 'N/A';
      document.getElementById('u-mpio').textContent = currentUser?.municipio || 'SIN REGISTRO';
      document.getElementById('u-puesto').textContent = currentUser?.puesto || 'SIN REGISTRO';
      document.getElementById('u-mesa').textContent = currentUser?.mesa || 'SIN REGISTRO';
    }
    async function refreshUserFromServer(){
      try{
        const doc = currentUser?.documento;
        if(!doc) return;
        const res = await apiGet('validarDocumento', { documento: doc });
        if(res?.existe){
          currentUser = {
            documento: res.documento,
            nombre: res.nombre,
            telefono: res.telefono || '',
            residencia: res.residencia || '',
            referencia: res.referencia || '',
            municipio: res.municipio || '',
            puesto: res.puesto || '',
            mesa: res.mesa || ''
          };
          renderUserMenu();
        }
      }catch(e){ /* silencio */ }
    }

    // Choices (select con filtro)
    let choicesReg = null, choicesUpd = null;
    function initChoices(){
      if(choicesReg) choicesReg.destroy();
      if(choicesUpd) choicesUpd.destroy();
      const regSel = document.getElementById('reg-residencia');
      const updSel = document.getElementById('upd-residencia');
      if(regSel){
        choicesReg = new Choices(regSel, {
          searchEnabled: true, itemSelectText: '', shouldSort:false,
          placeholder: true, placeholderValue: 'Selecciona tu Residencia',
          searchPlaceholderValue: 'Escribe para filtrar'
        });
      }
      if(updSel){
        choicesUpd = new Choices(updSel, {
          searchEnabled: true, itemSelectText: '', shouldSort:false,
          placeholder: true, placeholderValue: 'Selecciona tu Residencia',
          searchPlaceholderValue: 'Escribe para filtrar'
        });
      }
    }
    document.addEventListener('DOMContentLoaded', initChoices);

    // LOGIN
    const btnLogin = document.getElementById('btn-login');
    const docLogin = document.getElementById('doc-login');
    const regCard = document.getElementById('registro-card');
    const btnGuardarRegistro = document.getElementById('btn-guardar-registro');

    btnLogin.addEventListener('click', async () => {
  const documento = (docLogin.value || '').trim();

  // Validación: campo vacío
  if (documento === '') {
    Swal.fire({
      icon: 'question',
      title: '¿Deseas comenzar?',
      text: 'Ingresa un Documento para validar.',
      timer: 3000,
      width: '80%',
      padding: '1rem',
      customClass: { popup: 'swal2-responsive-popup' }
    });
    return;
  }

  // Validación: formato (6 a 10 dígitos)
  if (!/^\d{6,10}$/.test(documento)) {
    Swal.fire({ 
      icon: 'warning', 
      title: 'Documento inválido', 
      text: 'Ingresa de 6 a 10 dígitos.' 
    });
    return;
  }

  try {
    const res = await apiGet('validarDocumento', { documento });
    if (res && res.existe) {
      currentUser = {
        documento: res.documento,
        nombre: res.nombre,
        telefono: res.telefono || '',
        residencia: res.residencia || '',
        referencia: res.referencia || '',
        municipio: res.municipio || '',
        puesto: res.puesto || '',
        mesa: res.mesa || ''
      };
      renderUserMenu();
      playSoundOnce(SOUNDS.login);
      showView('view-menu');
    } else {
      regCard.style.display = '';
      Swal.fire({
        icon: 'info',
        title: 'Nuevo usuario',
        text: 'Completa tu registro para continuar.'
      });
    }
  } catch (e) {
    Swal.fire({ 
      icon: 'error', 
      title: 'Error', 
      text: e.message 
    });
  }
});

    // Toggle Referido (registro)
    const regRefWrap = document.getElementById('reg-referido-wrap');
    const btnRefMas = document.getElementById('btn-ref-mas');
    const btnRefMenos = document.getElementById('btn-ref-menos');
    btnRefMas.addEventListener('click', (ev)=>{ ev.preventDefault(); regRefWrap.style.display=''; btnRefMas.classList.add('hidden'); btnRefMenos.classList.remove('hidden'); });
    btnRefMenos.addEventListener('click', (ev)=>{ ev.preventDefault(); regRefWrap.style.display='none'; btnRefMas.classList.remove('hidden'); btnRefMenos.classList.add('hidden'); document.getElementById('reg-referencia').value=''; });

    // Botón Atrás en registro: vuelve a login/validación
    const btnRegAtras = document.getElementById('btn-reg-atras');
    if(btnRegAtras){
      btnRegAtras.addEventListener('click', (e)=>{
        e.preventDefault();
        playSoundOnce(SOUNDS.back);
        regCard.style.display='none';
        showView('view-login');
      });
    }

    // Guardar Registro con Resumen
    btnGuardarRegistro.addEventListener('click', async ()=>{
      const documento = (docLogin.value || '').trim();
      const formData = {
        documento,
        nombre: document.getElementById('reg-nombre').value.trim(),
        telefono: document.getElementById('reg-telefono').value.trim(),
        residencia: document.getElementById('reg-residencia').value,
        referencia: (document.getElementById('reg-referencia').value || '').trim()
      };
      const documentoRegex = /^(?:[0-9]{6,9}|1[0-9]{9})$/;
      const telefonoRegex = /^[0-9]{10}$/;
      const referenciaRegex = /^[0-9]{1,3}$/;

      // Requeridos básicos
if (!formData.nombre || !formData.documento || !formData.telefono) {
  return Swal.fire({
    icon: 'warning',
    title: 'Faltan campos Requeridos',
    text: 'Completa Nombre, Documento y Whatsapp.'
  });
}

// Validar que el nombre tenga al menos 2 palabras
const nombrePalabras = formData.nombre.split(/\s+/).filter(Boolean);
if (nombrePalabras.length < 2) {
  return Swal.fire({
    icon: 'warning',
    title: 'Nombre incompleto',
    text: 'Ingresa tu nombre completo (mínimo nombre y apellido).'
  });
}

// Documento
if (!documentoRegex.test(formData.documento)) {
  return Swal.fire({
    icon: 'warning',
    title: 'Documento inválido',
    text: 'Revisa el número de documento.'
  });
}

// Whatsapp / Teléfono
if (!telefonoRegex.test(formData.telefono)) {
  return Swal.fire({
    icon: 'warning',
    title: 'Whatsapp inválido',
    text: 'Debe tener exactamente 10 dígitos.'
  });
}

// Referido (opcional)
if (formData.referencia && !referenciaRegex.test(formData.referencia)) {
  return Swal.fire({
    icon: 'warning',
    title: 'Referido inválido',
    text: 'Debe tener 1 a 3 dígitos.'
  });
}

      const resumenHtml = `
        <b>Nombre:</b> ${formData.nombre}<br>
        <b>N° Documento:</b> ${formData.documento}<br>
        <b>Whatsapp:</b> ${formData.telefono}<br>
        <b>Residencia:</b> ${formData.residencia}<br>
        <b>Referido:</b> ${formData.referencia || 'No Registras'}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Registro', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', customClass:{ popup:'swal2-responsive-popup' },
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        const r = await apiPost('guardarContactoEnServidor', formData);
        if(r && r.success){
          // Revalidar y pasar a menú
          const res = await apiGet('validarDocumento', { documento: formData.documento });
          if(res?.existe){
            currentUser = {
              documento: res.documento,
              nombre: res.nombre,
              telefono: res.telefono || '',
              residencia: res.residencia || '',
              referencia: res.referencia || '',
              municipio: res.municipio || '',
              puesto: res.puesto || '',
              mesa: res.mesa || ''
            };
            // Alerta de registro exitoso
            await Swal.fire({ icon:'success', title:'Registro exitoso', timer:1800, showConfirmButton:false });
            renderUserMenu();
            playSoundOnce(SOUNDS.login);
            showView('view-menu');
            regCard.style.display='none';
          }else{
            Swal.fire({ icon:'error', title:'No se pudo completar el registro' });
          }
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', html: r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });

    // MENÚ
    const overlay = document.getElementById('overlay');
    document.getElementById('btn-open-menu').addEventListener('click', ()=> { playSoundOnce(SOUNDS.menu); });
    document.getElementById('btn-open-menu').addEventListener('click', ()=> overlay.classList.add('open'));
    document.getElementById('btn-ovl-back').addEventListener('click', ()=> overlay.classList.remove('open'));
    document.getElementById('ovlClose').addEventListener('click', ()=> overlay.classList.remove('open'));

    document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  onUserLoggedOut_Notifications(); // <--- NUEVO: detiene polling y limpia
  currentUser = null;
  docLogin.value = '';
  regCard.style.display='none';
  showView('view-login');
});


    document.getElementById('go-asistencia').addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararAsistencia();
      showView('view-asistencia');
    });
    document.getElementById('go-actualizacion').addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararActualizacion();
      showView('view-actualizacion');
    });
    document.getElementById('go-consultar').addEventListener('click', ()=>{
      overlay.classList.remove('open');
      document.getElementById('c-documento').value = currentUser?.documento || '';
      showView('view-consultar');
    });
    // NUEVO: SOLICITUD
    document.getElementById('go-solicitud').addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararSolicitud();
      showView('view-solicitud');
    });
    // NUEVO: IDEAS
    document.getElementById('go-ideas').addEventListener('click', async ()=>{
      overlay.classList.remove('open');
      await prepararIdeas();
      showView('view-ideas');
    });
    // INSERT: NUEVO - CASA SOCIAL
    document.getElementById('go-sede').addEventListener('click', ()=>{
      overlay.classList.remove('open');
      showView('view-sede');
    });

    // NUEVO: REDES SOCIALES
document.getElementById('go-redes').addEventListener('click', ()=>{
  overlay.classList.remove('open');
  showView('view-redes');
});

    document.getElementById('go-lider').addEventListener('click', async ()=>{
      if(!currentUser){ return; }
      try{
        const r = await apiGet('validarLider', { documento: currentUser.documento });
        if(r && r.codigo && r.nombre){
         const msg = "Hola 👋🏻\n\nQuiero pedirte que apoyes a nuestro gran amigo *Jhonny Perdomo*.\n\nInstala la App y regístrate aquí 👉 " + "https://tinyurl.com/app-jhonny-perdomo" + " 👈\n\nEn el campo *N° de Referido* por favor escribe el N° 👉 " + r.codigo + " 👈 (solo el número).\n\nEn esta App encontrarás muchas opciones para ayudar a tu comunidad. ¡Bendiciones!\n\nCordialmente,\n\n*" + r.nombre + "*\n> Equipo del Hacer";
          const textoEscapado = encodeURIComponent(msg);
          const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
          if(navigator.clipboard){ navigator.clipboard.writeText(msg).catch(()=>{}); }
          window.open((esMovil ? "whatsapp://send?text=" : "https://api.whatsapp.com/send?text=") + textoEscapado, "_blank");
        }else{
          Swal.fire({ icon:'info', title:'No estás en registros de Líderes' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });

    // COMPARTIR PORTAL
    document.getElementById('btn-compartir').addEventListener('click', ()=>{
  const url = "https://tinyurl.com/app-jhonny-perdomo";
  const txt = "Instala la *App de Jhonny Perdomo* 📲 y regístrate con un clic:\n" + url;
  if(navigator.clipboard){ navigator.clipboard.writeText(txt).catch(()=>{}); }
  const enc = encodeURIComponent(txt);
  const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
  window.open((esMovil ? "whatsapp://send?text=" : "https://api.whatsapp.com/send?text=") + enc, "_blank");
});

   // VIDEO (con miniatura, Cloudinary MP4, 1 clic)
const videoCard = document.getElementById('videoCard');
const playLayer = document.getElementById('playLayer');
const videoThumb = document.getElementById('videoThumb');

let currentVideo = null; // referencia al <video> creado

function playVideo(){
  // Evita crear el video más de una vez
  if (videoCard.querySelector('video')) return;

  const src = 'https://res.cloudinary.com/dqqeavica/video/upload/v1746906083/Firma_bmcatv.mp4';

  const video = document.createElement('video');
  video.src = src;
  video.autoplay = true;     // autoplay en el primer clic
  video.muted = false;       // reproducción con audio (puede requerir interacción en algunos navegadores)
  video.playsInline = true;  // iOS: evita fullscreen automático
  video.controls = true;     // controles visibles
  video.preload = 'auto';
  video.setAttribute('title', 'Video');

  // Miniatura como poster mientras carga
  if (videoThumb && videoThumb.src) video.poster = videoThumb.src;

  // Ajuste visual al contenedor
  video.style.width = '100%';
  video.style.height = '100%';
  video.style.display = 'block';
  video.style.objectFit = 'cover';

  videoCard.appendChild(video);
  videoCard.classList.add('playing');

  currentVideo = video;

  // Intentar reproducir y, si falla por políticas de autoplay con sonido,
  // como fallback silencia y vuelve a intentar (manteniendo 1 clic)
  const p = video.play();
  if (p && typeof p.then === 'function') {
    p.catch(() => {
      video.muted = true;
      video.play().catch(()=>{ /* ignorar */ });
    });
  }

  // Limpieza al finalizar
  video.addEventListener('ended', stopVideoPlayback);
}

// Detener y limpiar el video (se llama al cambiar de vista/menú, logout, etc.)
function stopVideoPlayback(){
  const v = currentVideo || videoCard.querySelector('video');
  if (!v) {
    videoCard.classList.remove('playing');
    return;
  }
  try {
    v.pause();
    // liberar recursos de la descarga
    v.removeAttribute('src');
    v.load();
  } catch(_){}
  // quitar del DOM
  v.remove();
  currentVideo = null;
  // restaurar estado visual (mostrar miniatura y capa play)
  videoCard.classList.remove('playing');
}

// Un solo clic en imagen o capa de play
if (playLayer) playLayer.addEventListener('click', playVideo);
if (videoThumb) videoThumb.addEventListener('click', playVideo);

// Detener si la pestaña pierde foco (opcional pero recomendado)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) stopVideoPlayback();
});

// Detener al navegar desde el menú a cualquier otra vista
['go-asistencia','go-actualizacion','go-consultar','go-solicitud','go-ideas','go-sede','go-redes','btn-logout']
  .forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      // capture:true asegura que pare antes de que se cambie la vista
      el.addEventListener('click', () => stopVideoPlayback(), { capture: true });
    }
  });
    
    // ASISTENCIA
    async function prepararAsistencia(){
      if(!currentUser) return;
      document.getElementById('a-documento').value = currentUser.documento;
      try{
        const d = await apiGet('validarDocumento4', { documento: currentUser.documento });
        if(d){
          document.getElementById('a-nombre').value = d.nombre || '';
          document.getElementById('a-telefono').value = d.telefono || '';
        }
      }catch{}
      document.getElementById('a-reunion').value = '';
      document.getElementById('a-evento').value = '';
      document.getElementById('evento-wrap').style.display='none';
    }
    document.getElementById('a-reunion').addEventListener('input', async (e)=>{
      const val = (e.target.value||'').trim();
      if(!val){ document.getElementById('evento-wrap').style.display='none'; return; }
      try{
        const r = await apiGet('validarReunion', { reunion: val });
        document.getElementById('a-evento').value = r?.evento || '';
        document.getElementById('evento-wrap').style.display='';
      }catch{}
    });
    document.getElementById('a-guardar').addEventListener('click', async ()=>{
      const body = {
        documento: document.getElementById('a-documento').value.trim(),
        nombre: document.getElementById('a-nombre').value.trim(),
        telefono: document.getElementById('a-telefono').value.trim(),
        reunion: document.getElementById('a-reunion').value.trim(),
        evento: document.getElementById('a-evento').value.trim()
      };
      const documentoRegex = /^[0-9]{6,10}$/;
      const reunionRegex = /^[0-9]{1,3}$/;
      if(!documentoRegex.test(body.documento)){
        return Swal.fire({icon:'warning',title:'Documento inválido'});
      }
      if(!reunionRegex.test(body.reunion)){
        return Swal.fire({icon:'warning',title:'N° de Evento inválido'});
      }
      try{
        const r = await apiPost('guardarAsistenciaEnServidor', body);
        if(r && r.success){
          await Swal.fire({ icon:'success', title:'Asistencia registrada', timer:1500, showConfirmButton:false });
          showView('view-menu');
        }else{
          Swal.fire({ icon:'info', title:'Atención', html: r?.message || 'No se pudo registrar' });
        }
      }catch(e){
        Swal.fire({ icon:'info', title:'Atención', text:e.message });
      }
    });
    document.getElementById('a-volver').addEventListener('click', ()=> showView('view-menu'));
    
    showView('view-menu');
onUserLoggedIn_Notifications(); // <--- NUEVO: carga la lista y arranca el polling

    // VOTACIÓN (pegar fila)
    function parseFila(text){
      const ENC = ["NUIP","DEPARTAMENTO","MUNICIPIO","PUESTO","DIRECCIÓN","MESA"];
      let p = (text||'').split(/[\t\n\r]+/).map(s=>s.trim()).filter(Boolean);
      if(p.length>=6 && ENC.every(e => p.slice(0,6).join(' ').toUpperCase().includes(e))) p = p.slice(6);
      p = p.filter(x => !ENC.includes(x.toUpperCase()));
      if(p.length>6) p[5] = p.slice(5).join(' ');
      if(p.length>6) p = p.slice(0,6);
      return p;
    }
    function intentarAutocompletar(){
      const t = document.getElementById('v-row').value.trim();
      const p = parseFila(t);
      if(p.length===6){
        document.getElementById('v-nuip').value = p[0];
        document.getElementById('v-departamento').value = p[1];
        document.getElementById('v-municipio').value = p[2];
        document.getElementById('v-puesto').value = p[3];
        document.getElementById('v-direccion').value = p[4];
        document.getElementById('v-mesa').value = p[5];
      }
    }
    ['paste','input','blur'].forEach(evt=>{
      document.getElementById('v-row').addEventListener(evt, ()=> setTimeout(intentarAutocompletar, 80));
    });
    // VOTACIÓN (pegar fila)
document.getElementById('v-guardar').addEventListener('click', async ()=>{
  const body = {
    nuip: document.getElementById('v-nuip').value.trim(),
    departamento: document.getElementById('v-departamento').value.trim(),
    municipio: document.getElementById('v-municipio').value.trim(),
    puesto: document.getElementById('v-puesto').value.trim(),
    direccion: document.getElementById('v-direccion').value.trim(),
    mesa: document.getElementById('v-mesa').value.trim()
  };
  if(Object.values(body).some(v=>!v)){
    return Swal.fire({ icon:'warning', title:'Faltan datos', text:'Pega la fila de la consulta primero.' });
  }
  try{
    const r = await apiPost('guardarVotacionEnServidor', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Información guardada', timer:1800, showConfirmButton:false });
      // Actualiza los datos del usuario para reflejar municipio/puesto/mesa recién guardados
      try{ await refreshUserFromServer(); }catch(_){}
      showView('view-menu');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error al guardar', text:e.message });
  }
});
    document.getElementById('v-volver').addEventListener('click', ()=> showView('view-menu'));

    // ACTUALIZACIÓN (con Resumen)
    async function prepararActualizacion(){
      if(!currentUser) return;
      document.getElementById('upd-documento').value = currentUser.documento;
      try{
        const r = await apiGet('validarDocumento3',{ documento: currentUser.documento });
        document.getElementById('upd-nombre').value = r?.existe ? (r.nombre || '') : (currentUser.nombre || '');
      }catch{
        document.getElementById('upd-nombre').value = currentUser.nombre || '';
      }
      document.getElementById('upd-telefono').value = '';
      document.getElementById('upd-residencia').value = '';
      document.getElementById('upd-referencia').value = '';
      if(choicesUpd) choicesUpd.setChoiceByValue('');
    }
    // Toggle Referido en Actualización
    const updRefWrap = document.getElementById('upd-referido-wrap');
    const updRefMas = document.getElementById('upd-ref-mas');
    const updRefMenos = document.getElementById('upd-ref-menos');
    updRefMas.addEventListener('click', (ev)=>{ ev.preventDefault(); updRefWrap.style.display=''; updRefMas.classList.add('hidden'); updRefMenos.classList.remove('hidden'); });
    updRefMenos.addEventListener('click', (ev)=>{ ev.preventDefault(); updRefWrap.style.display='none'; updRefMas.classList.remove('hidden'); updRefMenos.classList.add('hidden'); document.getElementById('upd-referencia').value=''; });

    document.getElementById('upd-guardar').addEventListener('click', async ()=>{
      const body = {
        documento: document.getElementById('upd-documento').value.trim(),
        nombre: document.getElementById('upd-nombre').value.trim(),
        telefono: document.getElementById('upd-telefono').value.trim(),
        residencia: document.getElementById('upd-residencia').value,
        referencia: document.getElementById('upd-referencia').value.trim()
      };
      const documentoRegex = /^[0-9]{6,10}$/;
      const telefonoRegex = /^[0-9]{10}$/;
      const referenciaRegex = /^[0-9]{1,3}$/;

      if(!documentoRegex.test(body.documento)){
        return Swal.fire({ icon:'warning', title:'Documento inválido' });
      }
      if(body.telefono && !telefonoRegex.test(body.telefono)){
        return Swal.fire({ icon:'warning', title:'Whatsapp inválido' });
      }
      if(body.referencia && !referenciaRegex.test(body.referencia)){
        return Swal.fire({ icon:'warning', title:'Referido inválido', text:'Debe tener 1 a 3 dígitos.' });
      }

      const resumenHtml = `
        <b>N° Documento:</b> ${body.documento}<br>
        <b>Whatsapp:</b> ${body.telefono || 'Sin cambios'}<br>
        <b>Residencia:</b> ${body.residencia || 'Sin cambios'}<br>
        <b>Referido:</b> ${body.referencia || 'Sin cambios'}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Actualización', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', customClass:{ popup:'swal2-responsive-popup' },
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        const r = await apiPost('guardarActualizacionEnServidor', body);
        if(r && r.success){
          await Swal.fire({ icon:'success', title:'Actualización Exitosa', timer:1600, showConfirmButton:false });
          // Refrescar datos en menú automáticamente
          await refreshUserFromServer();
          showView('view-menu');
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });
    document.getElementById('upd-volver').addEventListener('click', ()=> showView('view-menu'));


    // CONSULTAR (requisitos de alertas y botones)
document.getElementById('c-validar').addEventListener('click', async ()=>{
  const documento = (document.getElementById('c-documento').value || '').trim();
  if(!/^\d{6,10}$/.test(documento)){
    return Swal.fire({ icon:'warning', title:'Documento inválido', text:'Ingresa de 6 a 10 dígitos.' });
  }
  try{
    const r = await apiGet('validarDocumento2', { documento });
    const cResult = document.getElementById('c-result');
    if(!r?.existe){
      cResult.style.display = 'none';
      await Swal.fire({ icon:'warning', title:'Documento No encontrado', timer:2000, showConfirmButton:false });
      return;
    }
    const ok = !!(r.departamento && r.municipio && r.puesto && r.direccion && r.mesa);
    if(!ok){
      cResult.style.display = 'none';
      const rs = await Swal.fire({
        icon:'info',
        title:`No encontramos información de votación`,
        text:`Puedes validar nuevamente o ir a la sección "Votación" para registrarla.`,
        showDenyButton:true,
        denyButtonText:'Validar Nuevamente',
        showConfirmButton:true,
        confirmButtonText:'Consultar'
      });
      if(rs.isConfirmed){
        // Copiar el documento al portapapeles y abrir la vista de votación
        try{
          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function'){
            await navigator.clipboard.writeText(documento);
          }
        }catch(_){}
        showView('view-votacion');
      }
      // si es Deny, solo cerrar
      return;
    }
    // Mostrar resultados
    document.getElementById('c-dep').textContent = r.departamento;
    document.getElementById('c-mun').textContent = r.municipio;
    document.getElementById('c-pue').textContent = r.puesto;
    document.getElementById('c-dir').textContent = r.direccion;
    document.getElementById('c-mesa').textContent = r.mesa;
    cResult.style.display = '';
    Swal.fire({ icon:'success', title:`Datos de Votación cargados` , timer:1400, showConfirmButton:false });
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
    document.getElementById('c-volver').addEventListener('click', ()=> showView('view-menu'));

    // SOLICITUD (con Resumen)
    async function prepararSolicitud(){
      if(!currentUser) return;
      document.getElementById('s-documento').value = currentUser.documento || '';
      // Limpiar campos
      document.getElementById('s-nombre').value = '';
      document.getElementById('s-telefono').value = '';
      document.getElementById('s-residencia').value = '';
      document.getElementById('s-servicio').value = '';
      document.getElementById('s-solicitud').value = '';

      try{
        const r = await apiGet('validarDocumento5', { documento: currentUser.documento });
        if(r && r.existe){
          document.getElementById('s-nombre').value = r.nombre || '';
          document.getElementById('s-telefono').value = r.telefono || '';
          document.getElementById('s-residencia').value = r.residencia || '';
        }else{
          // Si no existe, usar los datos del currentUser
          document.getElementById('s-nombre').value = currentUser.nombre || '';
          document.getElementById('s-telefono').value = currentUser.telefono || '';
          document.getElementById('s-residencia').value = currentUser.residencia || '';
        }
      }catch(_){
        document.getElementById('s-nombre').value = currentUser.nombre || '';
        document.getElementById('s-telefono').value = currentUser.telefono || '';
        document.getElementById('s-residencia').value = currentUser.residencia || '';
      }
    }

    document.getElementById('s-guardar').addEventListener('click', async ()=>{
      const body = {
        documento: (document.getElementById('s-documento').value || '').trim(),
        nombre: (document.getElementById('s-nombre').value || '').trim(),
        telefono: (document.getElementById('s-telefono').value || '').trim(),
        residencia: (document.getElementById('s-residencia').value || '').trim(),
        servicio: document.getElementById('s-servicio').value,
        solicitud: (document.getElementById('s-solicitud').value || '').trim()
      };
      const docRegex = /^[0-9]{6,10}$/;
      if(!docRegex.test(body.documento)){
        return Swal.fire({ icon:'warning', title:'Documento inválido', text:'Documento no válido en sesión.' });
      }
      if(!body.servicio){
        return Swal.fire({ icon:'warning', title:'Servicio requerido', text:'Selecciona un servicio.' });
      }
      if(!body.solicitud){
        return Swal.fire({ icon:'warning', title:'Solicitud requerida', text:'Describe brevemente tu solicitud.' });
      }

      const resumenHtml = `
        <b>Nombre:</b> ${body.nombre}<br>
        <b>N° Documento:</b> ${body.documento}<br>
        <b>Whatsapp:</b> ${body.telefono || 'N/A'}<br>
        <b>Residencia:</b> ${body.residencia || 'N/A'}<br>
        <b>Servicio:</b> ${body.servicio}<br>
        <b>Solicitud:</b> ${body.solicitud}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Solicitud', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', customClass:{ popup:'swal2-responsive-popup' },
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        const r = await apiPost('guardarSolicitudEnServidor', body);
        if(r && r.success){
          await Swal.fire({ icon:'success', title:'Solicitud enviada', timer:1700, showConfirmButton:false });
          showView('view-menu');
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });
    document.getElementById('s-volver').addEventListener('click', ()=> showView('view-menu'));

    // IDEAS (con Resumen)
    async function prepararIdeas(){
      if(!currentUser) return;
      document.getElementById('i-documento').value = currentUser.documento || '';
      // Limpiar campos
      document.getElementById('i-nombre').value = '';
      document.getElementById('i-telefono').value = '';
      document.getElementById('i-residencia').value = '';
      document.getElementById('i-social').value = '';
      document.getElementById('i-institucional').value = '';
      document.getElementById('i-economico').value = '';
      document.getElementById('i-ambiental').value = '';
      document.getElementById('i-otros').value = '';

      try{
        const r = await apiGet('validarDocumento6', { documento: currentUser.documento });
        if(r && r.existe){
          document.getElementById('i-nombre').value = r.nombre || '';
          document.getElementById('i-telefono').value = r.telefono || '';
          document.getElementById('i-residencia').value = r.residencia || '';
        }else{
          document.getElementById('i-nombre').value = currentUser.nombre || '';
          document.getElementById('i-telefono').value = currentUser.telefono || '';
          document.getElementById('i-residencia').value = currentUser.residencia || '';
        }
      }catch(_){
        document.getElementById('i-nombre').value = currentUser.nombre || '';
        document.getElementById('i-telefono').value = currentUser.telefono || '';
        document.getElementById('i-residencia').value = currentUser.residencia || '';
      }
    }

    document.getElementById('i-guardar').addEventListener('click', async ()=>{
      const body = {
        documento: (document.getElementById('i-documento').value || '').trim(),
        nombre: (document.getElementById('i-nombre').value || '').trim(),
        telefono: (document.getElementById('i-telefono').value || '').trim(),
        residencia: (document.getElementById('i-residencia').value || '').trim(),
        social: (document.getElementById('i-social').value || '').trim(),
        institucional: (document.getElementById('i-institucional').value || '').trim(),
        economico: (document.getElementById('i-economico').value || '').trim(),
        ambiental: (document.getElementById('i-ambiental').value || '').trim(),
        otros: (document.getElementById('i-otros').value || '').trim()
      };
      const docRegex = /^[0-9]{6,10}$/;
      if(!docRegex.test(body.documento)){
        return Swal.fire({ icon:'warning', title:'Documento inválido', text:'Documento no válido en sesión.' });
      }

      const resumenHtml = `
        <b>Nombre:</b> ${body.nombre}<br>
        <b>N° Documento:</b> ${body.documento}<br>
        <b>Whatsapp:</b> ${body.telefono || 'N/A'}<br>
        <b>Residencia:</b> ${body.residencia || 'N/A'}<br>
        <hr>
        <b>Aspecto Social:</b><br>${(body.social||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <b>Aspecto Institucional:</b><br>${(body.institucional||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <b>Aspecto Económico:</b><br>${(body.economico||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <b>Aspecto Ambiental:</b><br>${(body.ambiental||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <b>Otros:</b><br>${(body.otros||'').replace(/\n/g,'<br>') || '<i>Sin ideas</i>'}<br><br>
        <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1753538919/BANNER_JHONNY_e0yw7m.png" alt="">
      `;
      const rs = await Swal.fire({
        icon:'info', title:'Resumen de Ideas', html:resumenHtml,
        showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar',
        width:'80%', customClass:{ popup:'swal2-responsive-popup' },
        soundTag:'resumen'
      });
      if(!rs.isConfirmed) return;

      try{
        const r = await apiPost('guardarIdeasEnServidor', body);
        if(r && r.success){
          await Swal.fire({ icon:'success', title:'¡Gracias por tus Ideas!', timer:1700, showConfirmButton:false });
          showView('view-menu');
        }else{
          Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
        }
      }catch(e){
        Swal.fire({ icon:'error', title:'Error', text:e.message });
      }
    });
    document.getElementById('i-volver').addEventListener('click', ()=> showView('view-menu'));

    // Sonido para botones Atrás/Regresar
    ['btn-ovl-back','a-volver','v-volver','upd-volver','c-volver','s-volver','i-volver','btn-reg-atras','sede-volver','redes-volver'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('click', ()=> playSoundOnce(SOUNDS.back));
});

    // Volver genéricos
    ['a-volver','v-volver','upd-volver','c-volver','s-volver','i-volver','sede-volver','redes-volver'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('click', ()=> showView('view-menu'));
});

    /* ==== NOTIFICACIONES: cargar al iniciar sesión y autorefrescar en Menú ==== */
const NEW_NOTIF_SOUND = 'https://res.cloudinary.com/dqqeavica/video/upload/v1759767435/Notificacion_d1woxv.mp3';
const NOTIF_PLACEHOLDER_IMG = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759697569/Jhonny_tvexdy.png';

const notifListEl = document.getElementById('notif-list');
const ndImg = document.getElementById('nd-image');
const ndTitle = document.getElementById('nd-title');
const ndDesc = document.getElementById('nd-desc');
const ndLink = document.getElementById('nd-link');
const ndBack = document.getElementById('nd-back');

let notifState = { items: [], lastTopId: null, readSet: new Set() };
let notifPoller = null;

function notifReadKey(){
  const uid = currentUser?.documento || 'anon';
  return 'readNotifs:' + uid;
}
function loadReadSet(){
  try{
    const raw = localStorage.getItem(notifReadKey());
    notifState.readSet = new Set(raw ? JSON.parse(raw) : []);
  }catch(_){ notifState.readSet = new Set(); }
}
function saveReadSet(){
  try{
    localStorage.setItem(notifReadKey(), JSON.stringify(Array.from(notifState.readSet)));
  }catch(_){}
}

function guessPreview(link){
  if (!link) return NOTIF_PLACEHOLDER_IMG;
  if (/\.(png|jpe?g|webp|gif)$/i.test(link)) return link;
  return NOTIF_PLACEHOLDER_IMG;
}

function renderNotifList(items){
  if (!notifListEl) return;
  if (!items || !items.length){
    notifListEl.innerHTML = '<p class="center muted">No hay notificaciones por ahora.</p>';
    return;
  }
  const html = items.map(n=>{
    const unread = !notifState.readSet.has(n.id);
    const img = guessPreview(n.first_link);
    // Pequeño extracto limpio (sin salto de línea largo)
    const extract = (n.descripcion || '').replace(/\s+/g,' ').trim();
    return `
      <div class="notif-item" data-id="${n.id}">
        <img class="notif-img" loading="lazy" src="${img}" alt="">
        <div class="notif-content">
          <div class="notif-title">${(n.titulo || '').toUpperCase()}</div>
          <div class="notif-desc">${extract}</div>
        </div>
        <span class="notif-dot ${unread ? '' : 'hidden'}"></span>
      </div>
    `;
  }).join('');
  notifListEl.innerHTML = html;
}

function openNotifDetail(n){
  if (!n) return;
  // marcar como leída
  if (!notifState.readSet.has(n.id)){
    notifState.readSet.add(n.id);
    saveReadSet();
    // actualizar punto rojo en la lista
    const dot = notifListEl.querySelector(`.notif-item[data-id="${n.id}"] .notif-dot`);
    if (dot) dot.classList.add('hidden');
  }
  // setear contenido
  ndImg.src = guessPreview(n.first_link);
  ndTitle.textContent = (n.titulo || '').toUpperCase();
  ndDesc.textContent = n.descripcion || '';
  // link “Visita la Noticia”
  if (n.first_link){
    ndLink.style.display = '';
    ndLink.href = n.first_link;
  }else{
    ndLink.style.display = 'none';
    ndLink.href = '#';
  }
  showView('view-notif');
}
if (ndBack){
  ndBack.addEventListener('click', ()=> showView('view-menu'));
}

// Delegación de click en la lista
if (notifListEl){
  notifListEl.addEventListener('click', (ev)=>{
    const item = ev.target.closest('.notif-item');
    if (!item) return;
    const id = item.getAttribute('data-id');
    const n = notifState.items.find(x=> String(x.id) === String(id));
    openNotifDetail(n);
  });
}

async function fetchAndRenderNotifications({playIfNew=false} = {}){
  try{
    const items = await apiGet('listnotificaciones');
    if (!Array.isArray(items)) return;

    const prevTop = notifState.lastTopId;
    notifState.items = items;
    notifState.lastTopId = items[0]?.id || null;

    renderNotifList(items);

    if (playIfNew && prevTop && notifState.lastTopId && notifState.lastTopId !== prevTop){
      // llegó algo nuevo
      playSoundOnce(NEW_NOTIF_SOUND);
    }
  }catch(_){}
}

function startNotifPolling(){
  if (notifPoller || !currentUser) return;
  notifPoller = setInterval(()=> fetchAndRenderNotifications({playIfNew:true}), 30000); // cada 30s
}
function stopNotifPolling(){
  if (notifPoller){ clearInterval(notifPoller); notifPoller = null; }
}

document.addEventListener('visibilitychange', ()=>{
  if (document.hidden){
    stopNotifPolling();
  }else{
    if (currentUser){
      fetchAndRenderNotifications();
      startNotifPolling();
    }
  }
});

// Llamar esto justo DESPUÉS de un login exitoso (cuando pasas a view-menu)
async function onUserLoggedIn_Notifications(){
  loadReadSet();
  await fetchAndRenderNotifications(); // primera carga sin sonido
  startNotifPolling();
}
// Llamar esto en logout
function onUserLoggedOut_Notifications(){
  stopNotifPolling();
  notifState = { items: [], lastTopId: null, readSet: new Set() };
  if (notifListEl) notifListEl.innerHTML = '';
}
  </script>
</body>
</html>
